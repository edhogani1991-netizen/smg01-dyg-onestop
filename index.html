<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CloudKitchen Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #7A3E1D; --accent: #F39C12; --bg: #F7F3EE; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; padding-bottom: 120px; }
        #welcome-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; text-align: center; }
        .card { max-width: 480px; margin: auto; background: white; border-radius: 25px; padding: 20px; display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .section-title { font-size: 13px; font-weight: 800; margin: 20px 0 10px; color: var(--primary); text-transform: uppercase; }
        .mode-selector { display: flex; gap: 8px; flex-wrap: wrap; }
        .option { flex: 1; min-width: 100px; padding: 12px 5px; text-align: center; border: 2px solid #eee; border-radius: 12px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .option.active { border-color: var(--accent); background: #FFF3E6; color: var(--primary); }
        .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 8px; }
        .btn-main { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 18px; font-weight: bold; cursor: pointer; }
        #variant-nasi, #variant-suhu { display: none; }
    </style>
</head>
<body>

<div id="welcome-overlay">
    <div style="background:white; padding:40px; border-radius:30px; width:80%;">
        <div style="font-size:50px;">üìç</div>
        <h2>Akses Lokasi</h2>
        <p>Klik tombol di bawah untuk validasi lokasi dan memulai pesanan.</p>
        <button class="btn-main" onclick="startApp()">IZINKAN GPS</button>
        <p id="gps-err" style="color:red; font-size:12px; margin-top:10px;"></p>
    </div>
</div>

<div class="card" id="app">
    <div id="noAntrean" style="text-align:center; font-size:40px; font-weight:900; color:var(--accent);">#0</div>

    <div class="section-title">üë§ Nama</div>
    <input type="text" id="custName" style="width:100%; padding:12px; border:2px solid #eee; border-radius:12px; box-sizing:border-box;">

    <div id="variant-nasi">
        <div class="section-title">üçö Varian Nasi</div>
        <div class="mode-selector">
            <div class="option active" onclick="setNasi('Putih', 0, this)">Putih (+0)</div>
            <div class="option" onclick="setNasi('Uduk', 0, this)">Uduk (+0)</div>
            <div class="option" onclick="setNasi('Cabe Ijo', 2000, this)">Cabe Ijo (+2k)</div>
            <div class="option" onclick="setNasi('Kecombrang', 2000, this)">Kecombrang (+2k)</div>
            <div class="option" onclick="setNasi('Rumput Laut', 2000, this)">R.Laut (+2k)</div>
            <div class="option" onclick="setNasi('Margarin', 2000, this)">Margarin (+2k)</div>
        </div>
    </div>

    <div id="variant-suhu">
        <div class="section-title">üå°Ô∏è Suhu (Paket Hemat)</div>
        <div class="mode-selector">
            <div class="option active" onclick="setSuhu('Dingin/Es', this)">Dingin/Es</div>
            <div class="option" onclick="setSuhu('Panas', this)">Panas</div>
        </div>
    </div>

    <div class="section-title">üç¥ Menu</div>
    <div id="menu-box">Memuat menu...</div>

    <div id="summary" style="margin-top:20px; padding:15px; background:#f9f9f9; border-radius:15px; display:none;">
        <div id="cart-list"></div>
        <hr>
        <div style="display:flex; justify-content:space-between; font-weight:bold;">
            <span>TOTAL</span>
            <span id="total-txt">Rp 0</span>
        </div>
    </div>

    <button class="btn-main" style="margin-top:20px;" onclick="submitOrder()">KIRIM KE WHATSAPP</button>
</div>

<script>
    const CONFIG = {
        BACKEND: 'https://script.google.com/macros/s/AKfycbxDQvepHw_RQ484cfxlZa3eM22Noja6MQTk6fqSHdr3gq-pjiaLJLEs2jUg-0wBNd6x-g/exec',
        CSV: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQZGCGtu4xfKCj0zCGB2BldzF2fLjFCIOfVSXBAMeTM-3KGHfC9mZ_bhfaTnikwxd5427w4ULtotTJH/pub?gid=2132421401&single=true&output=csv',
        WARUNG: [-7.045132, 110.392160]
    };

    let menu = [], cart = [], selectedNasi = 'Putih', nasiHarga = 0, selectedSuhu = 'Dingin/Es';

    async function startApp() {
        navigator.geolocation.getCurrentPosition(async (p) => {
            document.getElementById('welcome-overlay').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            await loadMenu();
            syncQueue();
        }, () => {
            document.getElementById('gps-err').innerText = "GPS Wajib Aktif!";
        });
    }

    async function loadMenu() {
        const r = await fetch(CONFIG.CSV);
        const t = await r.text();
        menu = t.split('\n').slice(1).map(row => {
            const c = row.split(',');
            return { kat: c[0], nama: c[1], harga: parseInt(c[2]) };
        }).filter(m => m.nama);
        renderMenu();
    }

    function renderMenu() {
        const box = document.getElementById('menu-box');
        const cats = [...new Set(menu.map(m => m.kat))];
        box.innerHTML = cats.map(cat => `
            <div style="font-weight:bold; margin:10px 0;">${cat}</div>
            ${menu.filter(m => m.kat === cat).map(m => `
                <div class="menu-item">
                    <span>${m.nama} <br><small>Rp ${m.harga.toLocaleString()}</small></span>
                    <button onclick="addToCart('${m.nama}', ${m.harga}, '${m.kat}')">+</button>
                </div>
            `).join('')}
        `).join('');
    }

    function addToCart(nama, harga, kat) {
        cart.push({nama, harga, kat});
        updateLogic();
    }

    function updateLogic() {
        // Cek apakah ada menu "Paket Hemat" atau "Wardoy" (mengandung kata nasi)
        const hasNasiKat = cart.some(i => i.kat.toLowerCase().includes('wardoy') || i.kat.toLowerCase().includes('paket hemat'));
        const hasHemat = cart.some(i => i.kat.toLowerCase().includes('paket hemat'));

        document.getElementById('variant-nasi').style.display = hasNasiKat ? 'block' : 'none';
        document.getElementById('variant-suhu').style.display = hasHemat ? 'block' : 'none';

        if(!hasNasiKat) { selectedNasi = "-"; nasiHarga = 0; }
        if(!hasHemat) { selectedSuhu = "-"; }

        let sub = cart.reduce((a, b) => a + b.harga, 0);
        let total = sub + nasiHarga;
        
        document.getElementById('summary').style.display = cart.length > 0 ? 'block' : 'none';
        document.getElementById('cart-list').innerHTML = cart.map(i => `<div>${i.nama}</div>`).join('');
        document.getElementById('total-txt').innerText = `Rp ${total.toLocaleString()}`;
    }

    function setNasi(n, h, el) {
        document.querySelectorAll('#variant-nasi .option').forEach(o => o.classList.remove('active'));
        el.classList.add('active');
        selectedNasi = n; nasiHarga = h; updateLogic();
    }

    function setSuhu(s, el) {
        document.querySelectorAll('#variant-suhu .option').forEach(o => o.classList.remove('active'));
        el.classList.add('active');
        selectedSuhu = s;
    }

    async function submitOrder() {
        const name = document.getElementById('custName').value;
        if(!name || cart.length === 0) return alert("Lengkapi data!");
        
        const params = new URLSearchParams({
            token: 'dyg-access-v2', nama: name, mode: 'DINE IN',
            nasi: selectedNasi, suhu: selectedSuhu,
            pesanan: cart.map(i => i.nama).join(', '),
            total: cart.reduce((a, b) => a + b.harga, 0) + nasiHarga
        });

        const r = await fetch(CONFIG.BACKEND + "?" + params.toString());
        const qNo = await r.text();
        alert("Pesanan Terkirim! Nomor Antrean: #" + qNo);
        location.reload();
    }

    async function syncQueue() {
        while(true) {
            try {
                const r = await fetch(CONFIG.BACKEND + "?waitQueue=true");
                document.getElementById('noAntrean').innerText = "#" + (await r.text());
            } catch(e) { await new Promise(res => setTimeout(res, 5000)); }
        }
    }
</script>
</body>
</html>