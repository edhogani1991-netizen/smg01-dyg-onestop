<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>cloudkitchen.dyg++ | Pemesanan Online</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root { 
            --primary: #7A3E1D; --accent: #F39C12; --bg: #F7F3EE; 
            --surface: #FFFFFF; --soft: #EFE6D8; --dark: #2C2C2C; --muted: #888; 
            --success: #27ae60; --danger: #C0392B;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            margin: 0; padding: 14px; background: var(--bg); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; color: var(--dark); 
            padding-bottom: 160px; overflow-x: hidden; scroll-behavior: smooth;
        }
        .card { max-width: 480px; margin: auto; background: var(--surface); border-radius: 28px; padding: 20px; box-shadow: 0 15px 35px rgba(0,0,0,.06); opacity: 0; transform: translateY(20px); transition: 0.6s cubic-bezier(0.2, 1, 0.3, 1); }
        .card.visible { opacity: 1; transform: translateY(0); }
        .title { text-align: center; font-size: 26px; font-weight: 900; color: var(--primary); margin: 0; letter-spacing: -0.5px; }
        .queue-box { background: linear-gradient(135deg, #FFF9F0 0%, #FFF2E0 100%); border: 2px solid var(--accent); border-radius: 20px; padding: 15px; text-align: center; margin: 20px 0; }
        .queue-number { font-size: 42px; font-weight: 900; color: var(--primary); display: block; }
        .mode-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-option { flex: 1; padding: 12px 5px; text-align: center; border-radius: 18px; border: 2px solid var(--soft); cursor: pointer; background: #fff; transition: 0.3s; font-weight: 700; font-size: 12px; }
        .mode-option.active { background: #FFF3E6; border-color: var(--accent); color: var(--primary); transform: translateY(-2px); box-shadow: 0 8px 15px rgba(243,156,18,0.15); }
        .section-title { font-size: 13px; font-weight: 800; margin: 25px 0 10px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .box { background: #fff; border: 1.5px solid var(--soft); border-radius: 16px; padding: 4px 15px; transition: 0.3s; margin-bottom: 10px;}
        input, textarea, select { width: 100%; padding: 12px 0; border: none; font-family: inherit; font-size: 14px; background: transparent; color: var(--dark); }
        .cat-container { border: 1.5px solid var(--soft); border-radius: 20px; margin-bottom: 12px; overflow: hidden; background: #fff; }
        .cat-header { padding: 16px 20px; font-weight: 800; background: #FBF8F3; display: flex; justify-content: space-between; cursor: pointer; color: var(--primary); }
        .menu-list { display: none; padding: 0 20px; }
        .menu-list.active { display: block; }
        .menu-item { padding: 15px 0; border-bottom: 1px dashed var(--soft); }
        .qty-control { display: flex; align-items: center; gap: 12px; }
        .btn-qty { width: 34px; height: 34px; border-radius: 10px; border: none; background: var(--primary); color: #fff; font-weight: bold; cursor: pointer; }
        .sticky-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.92); backdrop-filter: blur(15px); padding: 15px 20px; border-top: 1px solid var(--soft); z-index: 999; }
        .btn-main { background: var(--primary); color: #fff; padding: 16px 30px; border-radius: 18px; border: none; font-weight: 800; width: 100%; cursor: pointer; }
        #welcome-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 10002; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 10001; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #fff; width: 90%; max-width: 360px; border-radius: 32px; padding: 35px; text-align: center; }
    </style>
</head>
<body>

<div id="toast-container" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10005;"></div>

<div id="welcome-overlay">
    <div style="background:white; padding:40px; border-radius:32px; text-align:center; max-width:400px;">
        <div style="font-size:60px;">üìç</div>
        <h2>Validasi Lokasi</h2>
        <p style="color:#666; margin-bottom:25px;">Izinkan akses GPS untuk menghitung ongkir jalan raya secara otomatis.</p>
        <button class="btn-main" onclick="startApp()">IZINKAN & MULAI</button>
    </div>
</div>

<div id="modalConfirm" class="modal-overlay">
    <div class="modal-box">
        <h3>üöÄ Kirim Pesanan?</h3>
        <p>Pastikan menu sudah sesuai. Kami akan menghubungkan Anda ke WhatsApp.</p>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="closeModal()" style="flex:1; padding:15px; border-radius:15px; border:none; background:#eee;">Batal</button>
            <button id="btnFinal" onclick="submitOrder()" style="flex:1; padding:15px; border-radius:15px; border:none; background:var(--primary); color:white; font-weight:bold;">Kirim!</button>
        </div>
    </div>
</div>

<div class="card" id="main-content">
    <h1 class="title">cloudkitchen.dyg++</h1>
    <p style="text-align:center; font-size:11px; color:#888;">Sekaran, Gunungpati, Semarang</p>
    
    <div class="queue-box">
        <small style="color:var(--accent); font-weight:bold;">ANTREAN SAAT INI</small>
        <span class="queue-number" id="noAntrean">#0</span>
    </div>

    <div class="mode-selector">
        <div id="mDine" class="mode-option active" onclick="changeMode('DINE IN', this)">üçΩÔ∏è DINE IN</div>
        <div id="mTake" class="mode-option" onclick="changeMode('TAKE AWAY', this)">üõçÔ∏è TAKE AWAY</div>
        <div id="mDeliv" class="mode-option" onclick="changeMode('DELIVERY', this)">üõµ DELIVERY</div>
    </div>

    <div id="map" style="height:150px; border-radius:20px; margin-bottom:20px; border:1px solid #ddd;"></div>

    <div class="section-title">üë§ Data Pemesan</div>
    <div class="box"><input type="text" id="custName" placeholder="Nama Anda..."></div>
    <div id="boxMeja" class="box"><input type="number" id="tableNo" placeholder="Nomor Meja..."></div>
    <div id="boxAlamat" class="box" style="display:none;"><textarea id="addressDetail" placeholder="Alamat Lengkap & Patokan..."></textarea></div>

    <div class="section-title">üç¥ Menu</div>
    <div id="menu-container">Memuat menu...</div>

    <div class="section-title">üìù Catatan</div>
    <div class="box"><textarea id="orderNote" placeholder="Contoh: Pedas sekali, tanpa bawang..."></textarea></div>

    <div id="summary-section" style="display:none; padding:20px; background:#f9f9f9; border-radius:20px; margin-top:20px;">
        <div id="order-list"></div>
        <div id="delivery-fee-row" style="display:none; justify-content:space-between; color:var(--accent); font-weight:bold; margin-top:10px;">
            <span>Ongkir (<span id="distDisplay">0</span> km)</span>
            <span id="feeDisplay">Rp 0</span>
        </div>
        <hr>
        <div style="display:flex; justify-content:space-between; font-weight:900; font-size:18px;">
            <span>TOTAL</span>
            <span>Rp <span id="totalDisplay">0</span></span>
        </div>
    </div>
</div>

<div class="sticky-bar">
    <button id="btnOrder" class="btn-main" onclick="openModal()" disabled>PILIH MENU DULU</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const CONFIG = {
        WEB_APP_URL: 'https://script.google.com/macros/s/AKfycbxVJVb69eXyaJjOnmdyPoKUx2veyVRw33NRc7V5VhfrAclmdRgIEu2rjZN0FwXhIzz20g/exec', // <--- GANTI INI
        MENU_CSV: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQZGCGtu4xfKCj0zCGB2BldzF2fLjFCIOfVSXBAMeTM-3KGHfC9mZ_bhfaTnikwxd5427w4ULtotTJH/pub?gid=2132421401&single=true&output=csv',      // <--- GANTI INI
        WARUNG: [-7.045132799426078, 110.39216011095742],
        WA: { DINE: '6281393048132', DELIV: '6289601522700' },
        TOKEN: 'dyg-access-v2'
    };

    let menuData = [], cart = [], currentMode = 'DINE IN', userCoords = null, userDist = 0;

    async function startApp() {
        navigator.geolocation.getCurrentPosition(async (pos) => {
            userCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            try {
                const url = `https://router.project-osrm.org/route/v1/driving/${userCoords.lng},${userCoords.lat};${CONFIG.WARUNG[1]},${CONFIG.WARUNG[0]}?overview=false`;
                const r = await fetch(url); const d = await r.json();
                userDist = d.routes[0].distance;
            } catch(e) { userDist = L.latLng(userCoords.lat, userCoords.lng).distanceTo(L.latLng(CONFIG.WARUNG)) * 1.3; }
            
            initMap();
            document.getElementById('welcome-overlay').style.display = 'none';
            document.getElementById('main-content').classList.add('visible');
            await loadMenu();
            syncQueue();
        }, () => alert("GPS wajib aktif!"));
    }

    async function loadMenu() {
        const r = await fetch(CONFIG.MENU_CSV);
        const t = await r.text();
        menuData = t.split('\n').slice(1).map((row, i) => {
            const c = row.split(',');
            return { id: 'm'+i, kat: c[0], nama: c[1], harga: parseInt(c[2]) };
        }).filter(m => m.nama);
        renderMenu();
    }

    function renderMenu() {
        const container = document.getElementById('menu-container');
        const cats = [...new Set(menuData.map(m => m.kat))];
        container.innerHTML = cats.map(cat => `
            <div class="cat-container">
                <div class="cat-header" onclick="this.nextElementSibling.classList.toggle('active')">${cat} <span>‚ñº</span></div>
                <div class="menu-list">
                    ${menuData.filter(m => m.kat === cat).map(m => `
                        <div class="menu-item" style="display:flex; justify-content:space-between; align-items:center;">
                            <div><b>${m.nama}</b><br><small>Rp ${m.harga.toLocaleString()}</small></div>
                            <div class="qty-control">
                                <button class="btn-qty" onclick="updateCart('${m.id}', -1)">-</button>
                                <span id="qty-${m.id}">0</span>
                                <button class="btn-qty" onclick="updateCart('${m.id}', 1)">+</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    function updateCart(id, change) {
        const item = menuData.find(m => m.id === id);
        if (change > 0) cart.push(item);
        else { const idx = cart.findIndex(c => c.id === id); if(idx !== -1) cart.splice(idx, 1); }
        refreshUI();
    }

    function refreshUI() {
        let sub = 0; const counts = {};
        cart.forEach(c => { sub += c.harga; counts[c.id] = (counts[c.id] || 0) + 1; });
        menuData.forEach(m => document.getElementById(`qty-${m.id}`).innerText = counts[m.id] || 0);

        let ongkir = currentMode === 'DELIVERY' ? (userDist < 2000 ? 3000 : 5000) : 0;
        document.getElementById('delivery-fee-row').style.display = currentMode === 'DELIVERY' ? 'flex' : 'none';
        document.getElementById('distDisplay').innerText = (userDist/1000).toFixed(1);
        document.getElementById('feeDisplay').innerText = "Rp " + ongkir.toLocaleString();

        const total = sub + ongkir;
        document.getElementById('totalDisplay').innerText = total.toLocaleString();
        document.getElementById('summary-section').style.display = sub > 0 ? 'block' : 'none';
        document.getElementById('btnOrder').disabled = sub === 0;
        document.getElementById('btnOrder').innerText = sub === 0 ? "PILIH MENU DULU" : `KONFIRMASI RP ${total.toLocaleString()}`;
        
        document.getElementById('order-list').innerHTML = Object.entries(counts).map(([id, q]) => {
            const m = menuData.find(x => x.id === id);
            return `<div style="display:flex; justify-content:space-between;"><span>${q}x ${m.nama}</span><span>Rp ${(m.harga*q).toLocaleString()}</span></div>`;
        }).join('');
    }

    async function submitOrder() {
        const name = document.getElementById('custName').value;
        if(!name) return alert("Isi nama!");
        const btn = document.getElementById('btnFinal');
        btn.innerText = "Memproses..."; btn.disabled = true;

        const pRows = cart.map(c => `${c.nama}`);
        const params = new URLSearchParams({
            token: CONFIG.TOKEN, nama: name, mode: currentMode, 
            pesanan: pRows.join(', '), total: document.getElementById('totalDisplay').innerText.replace(/\D/g,''),
            catatan: document.getElementById('orderNote').value
        });

        try {
            const resp = await fetch(CONFIG.WEB_APP_URL + "?" + params.toString());
            const qNo = await resp.text();
            const waMsg = `Halo CloudKitchen!\nAntrean: #${qNo}\nNama: ${name}\nMode: ${currentMode}\nPesanan: ${pRows.join(', ')}\nTotal: Rp ${document.getElementById('totalDisplay').innerText}`;
            window.open(`https://wa.me/${currentMode==='DELIVERY'?CONFIG.WA.DELIV:CONFIG.WA.DINE}?text=${encodeURIComponent(waMsg)}`, '_blank');
            location.reload();
        } catch(e) { alert("Gagal kirim!"); btn.disabled = false; }
    }

    function changeMode(m, el) {
        currentMode = m;
        document.querySelectorAll('.mode-option').forEach(o => o.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('boxMeja').style.display = m === 'DINE IN' ? 'block' : 'none';
        document.getElementById('boxAlamat').style.display = m === 'DELIVERY' ? 'block' : 'none';
        refreshUI();
    }

    function initMap() {
        const map = L.map('map', {zoomControl:false}).setView([userCoords.lat, userCoords.lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker([userCoords.lat, userCoords.lng]).addTo(map);
        L.circle(CONFIG.WARUNG, {radius: 150, color: 'brown'}).addTo(map);
    }

    async function syncQueue() {
        while (true) {
            try {
                const r = await fetch(CONFIG.WEB_APP_URL + `?waitQueue=true&token=${CONFIG.TOKEN}`);
                const n = await r.text();
                document.getElementById('noAntrean').innerText = "#" + n;
            } catch(e) { await new Promise(r => setTimeout(r, 5000)); }
        }
    }
    function openModal() { document.getElementById('modalConfirm').style.display = 'flex'; }
    function closeModal() { document.getElementById('modalConfirm').style.display = 'none'; }
</script>
</body>
</html>