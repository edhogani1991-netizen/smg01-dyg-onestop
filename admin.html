<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CLOUDkitchen.dyg++ POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0f172a; height: 100dvh; display: flex; justify-content: center; overflow: hidden; }
        .pos-container { width: 100%; max-width: 1000px; background: #F1F5F9; display: flex; flex-direction: column; }
        .menu-item { position: relative; background: white; padding: 8px; border-radius: 8px; border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.2s; }
        .menu-item:active { transform: scale(0.95); background: #f0fdf4; }
        .badge-count { position: absolute; top: -4px; right: -4px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; border: 2px solid white; }
        .scroll-custom::-webkit-scrollbar { width: 4px; }
        .scroll-custom::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .btn-pay-opt { padding: 6px; font-size: 10px; font-weight: 800; border-radius: 6px; border: 1px solid #e2e8f0; background: white; }
    </style>
</head>
<body>

<div class="pos-container shadow-2xl">
    <div class="bg-[#1B4332] text-white p-2 flex justify-between items-center">
        <h1 class="text-sm font-black italic text-emerald-400">dyg++ <span class="text-white opacity-50">RETAIL</span></h1>
        <div class="flex gap-4 text-right">
            <div><p class="text-[7px] uppercase opacity-60">Poin Member</p><p id="v-member-pts" class="text-xs font-black text-yellow-400">0 Pts</p></div>
            <div class="border-l pl-3"><p class="text-[7px] uppercase opacity-60">Est. Poin</p><p id="v-earn-pts" class="text-xs font-black text-emerald-400">+0</p></div>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <div class="flex-1 flex flex-col bg-white">
            <div class="p-2 border-b"><input type="text" id="menuSearch" oninput="renderMenu()" placeholder="Cari..." class="w-full p-2 bg-slate-100 rounded text-xs outline-none focus:ring-1 ring-emerald-500"></div>
            <div id="menu-render" class="grid grid-cols-4 gap-2 p-2 overflow-y-auto scroll-custom"></div>
        </div>

        <div class="w-80 border-l bg-white flex flex-col">
            <div class="p-3 bg-slate-50 border-b space-y-2">
                <input type="text" id="noWA" placeholder="WA Member (Enter)" class="w-full p-2 text-xs border rounded font-bold" onkeypress="if(event.key==='Enter') checkMember()">
                <div id="redeem-area" class="hidden flex items-center justify-between bg-yellow-100 p-2 rounded border border-yellow-200">
                    <button onclick="adjRedeem(-1)" class="w-6 h-6 bg-white rounded font-bold">-</button>
                    <div class="text-center"><span id="v-redeem-qty" class="text-xs font-black">0</span><p class="text-[7px] uppercase">Redeem (x1000)</p></div>
                    <button onclick="adjRedeem(1)" class="w-6 h-6 bg-white rounded font-bold">+</button>
                </div>
            </div>

            <div id="cart-list" class="flex-1 overflow-y-auto p-2 space-y-1 scroll-custom"></div>

            <div class="p-3 border-t bg-slate-50 space-y-2">
                <div class="text-[10px] font-bold space-y-1">
                    <div class="flex justify-between text-slate-400"><span>Subtotal</span><span id="v-subtotal">0</span></div>
                    <div class="flex justify-between text-red-500 italic"><span>Redeem</span><span id="v-discount">0</span></div>
                    <div class="flex justify-between text-base font-black text-[#1B4332] pt-1 border-t"><span>TOTAL</span><span id="v-total">0</span></div>
                </div>

                <select id="pay-method" onchange="toggleCashUI()" class="w-full p-2 bg-white border rounded text-xs font-black outline-none">
                    <option value="CASH">ðŸ’µ TUNAI</option>
                    <option value="QRIS">ðŸ“± QRIS</option>
                    <option value="CARD">ðŸ’³ KARTU</option>
                </select>

                <div id="cash-ui" class="grid grid-cols-2 gap-1">
                    <button onclick="setCash('pas')" class="btn-pay-opt bg-emerald-50 text-emerald-700">UANG PAS</button>
                    <button onclick="setCash(50000)" class="btn-pay-opt">50.000</button>
                    <button onclick="setCash(100000)" class="btn-pay-opt">100.000</button>
                    <input type="number" id="cash-input" placeholder="Bayar..." class="p-1 border rounded text-xs font-bold">
                </div>

                <button onclick="submitOrder()" id="btn-order" class="w-full bg-[#1B4332] text-white py-2.5 rounded-lg font-black text-xs shadow-lg active:scale-95 transition-all">BAYAR & CETAK</button>
            </div>
        </div>
    </div>
</div>

<script>
const CONFIG = {
    API: "https://script.google.com/macros/s/AKfycbzs0X1yPt9NReX3fWJYx6LUukaYXYmfYsxCpcNvJUbI6EXC9wGxSmPcY29S-vIZnNejJQ/exec",
    CSV: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZGCGtu4xfKCj0zCGB2BldzF2fLjFCIOfVSXBAMeTM-3KGHfC9mZ_bhfaTnikwxd5427w4ULtotTJH/pub?gid=2132421401&single=true&output=csv",
    TOKEN: "dyg-access-v2"
};

let cart = {}, menuData = [], redeemQty = 0, memberPts = 0, activeWA = "";

async function loadMenu() {
    const r = await fetch(CONFIG.CSV);
    const t = await r.text();
    menuData = t.split("\n").slice(1).map(l => { const c = l.split(","); return { nama: c[1], harga: parseInt(c[2]) || 0 }; }).filter(m => m.nama);
    renderMenu();
}

function renderMenu() {
    const cont = document.getElementById("menu-render");
    const search = document.getElementById("menuSearch").value.toLowerCase();
    cont.innerHTML = "";
    menuData.filter(m => m.nama.toLowerCase().includes(search)).forEach(m => {
        const q = cart[m.nama]?.qty || 0;
        cont.innerHTML += `<div onclick="addCart('${m.nama}', ${m.harga})" class="menu-item">
            ${q > 0 ? `<div class="badge-count">${q}</div>` : ''}
            <p class="text-[9px] font-extrabold uppercase leading-tight h-6 overflow-hidden">${m.nama}</p>
            <p class="text-emerald-600 font-bold text-[10px]">Rp ${m.harga.toLocaleString()}</p>
        </div>`;
    });
}

function addCart(n, p) {
    if (cart[n]) cart[n].qty++; else cart[n] = { price: p, qty: 1 };
    updateUI();
}

function updateQty(n, delta) {
    cart[n].qty += delta;
    if (cart[n].qty <= 0) delete cart[n];
    redeemQty = 0; updateUI();
}

async function checkMember() {
    const wa = document.getElementById("noWA").value;
    const r = await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=cekMember&noWA=${wa}`);
    const d = await r.json();
    if (d.exists) {
        memberPts = d.poin; activeWA = wa;
        document.getElementById("v-member-pts").innerText = memberPts.toLocaleString() + " Pts";
        document.getElementById("redeem-area").classList.remove("hidden");
    } else { alert("Member Tidak Ada!"); }
}

function adjRedeem(d) {
    const sub = Object.values(cart).reduce((s, i) => s + i.price * i.qty, 0);
    const limit = Math.min(Math.floor(memberPts/1000), Math.floor(sub/(10000*1.2)));
    const nv = redeemQty + d;
    if (nv >= 0 && nv <= limit) { redeemQty = nv; updateUI(); }
}

function updateUI() {
    renderMenu();
    const list = document.getElementById("cart-list"); list.innerHTML = "";
    let sub = 0;
    Object.keys(cart).forEach(n => {
        sub += cart[n].price * cart[n].qty;
        list.innerHTML += `<div class="flex justify-between items-center bg-slate-50 p-1.5 rounded border border-slate-100">
            <span class="text-[9px] font-black uppercase w-2/3 truncate">${n}</span>
            <div class="flex items-center gap-2">
                <button onclick="updateQty('${n}',-1)" class="w-4 h-4 bg-white border rounded text-[10px]">-</button>
                <span class="text-[10px] font-bold">${cart[n].qty}</span>
                <button onclick="updateQty('${n}',1)" class="w-4 h-4 bg-white border rounded text-[10px]">+</button>
            </div>
        </div>`;
    });
    const pot = redeemQty * 10000; const grand = Math.max(0, sub - pot);
    document.getElementById("v-subtotal").innerText = "Rp " + sub.toLocaleString();
    document.getElementById("v-discount").innerText = "- Rp " + pot.toLocaleString();
    document.getElementById("v-total").innerText = "Rp " + grand.toLocaleString();
    document.getElementById("v-earn-pts").innerText = "+" + (Math.floor(grand / 20000) * 100);
    document.getElementById("v-redeem-qty").innerText = redeemQty;
}

function setCash(v) { 
    const g = parseInt(document.getElementById("v-total").innerText.replace(/[^0-9]/g, ''));
    document.getElementById("cash-input").value = (v === 'pas') ? g : v;
}

function toggleCashUI() { document.getElementById("cash-ui").style.display = (document.getElementById("pay-method").value === "CASH") ? "grid" : "none"; }

async function submitOrder() {
    const totalRaw = document.getElementById("v-total").innerText.replace(/[^0-9]/g, '');
    const grand = parseInt(totalRaw);
    if (grand <= 0 && Object.keys(cart).length === 0) return;

    const btn = document.getElementById("btn-order");
    btn.innerText = "MENYIMPAN...";
    btn.disabled = true;

    try {
        const p = Object.keys(cart).map(n => `${n} (x${cart[n].qty})`).join(", ");
        const url = `${CONFIG.API}?token=${CONFIG.TOKEN}&action=processOrder&total=${grand}&noWA=${activeWA}&redeemQty=${redeemQty}&method=${document.getElementById("pay-method").value}&pesanan=${encodeURIComponent(p)}`;
        
        const res = await fetch(url);
        const result = await res.text();

        if (result === "SUCCESS") {
            // STRUK RETAIL (TANPA NOMOR ANTREAN)
            let esc = "\x1B\x40\x1B\x61\x01\x1B\x21\x10dyg++ RETAIL\x1B\x21\x00\n";
            esc += "Tgl: " + new Date().toLocaleString() + "\n";
            esc += "--------------------------------\n\x1B\x61\x00";
            
            Object.keys(cart).forEach(n => {
                esc += `${n}\n`;
                esc += `${cart[n].qty} x ${cart[n].price.toLocaleString()} = ${(cart[n].qty * cart[n].price).toLocaleString()}\n`;
            });

            esc += "--------------------------------\n";
            esc += "TOTAL: Rp " + grand.toLocaleString() + "\n";
            if (activeWA) {
                esc += "Member: " + activeWA + "\n";
                esc += "Poin Baru: " + document.getElementById("v-earn-pts").innerText + "\n";
            }
            esc += "\x1B\x61\x01\nTERIMA KASIH\n\x1B\x61\x01dyg.com\n\n\n\n\n";

            if (window.AppInventor) window.AppInventor.setWebViewString("PRINT|" + esc);
            alert("Transaksi Berhasil & Tersimpan!");
            location.reload();
        }
    } catch (e) {
        alert("Gagal Koneksi ke Server!");
        btn.innerText = "BAYAR & CETAK";
        btn.disabled = false;
    }
}
window.onload = loadMenu;
</script>
</body>
</html>