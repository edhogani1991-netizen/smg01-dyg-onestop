<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLOUDkitchen.dyg++ POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc;
        }

        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        .menu-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .menu-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.05);
        }

        .cart-sticky {
            box-shadow: 0 -10px 25px -5px rgba(0, 0, 0, 0.05);
        }

        /* Responsive Grid adjustment */
        @media (max-width: 768px) {
            .main-layout { flex-direction: column; overflow-y: auto; }
            .menu-section { width: 100%; height: auto; }
            .cart-section { 
                width: 100%; 
                position: sticky; 
                bottom: 0; 
                max-height: 80vh;
                border-top-left-radius: 24px;
                border-top-right-radius: 24px;
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden text-slate-900">

    <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 px-4 md:px-8 py-4 flex flex-wrap justify-between items-center shrink-0 gap-4">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-200">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
            </div>
            <div>
                <h1 class="text-lg font-extrabold text-slate-800 leading-none">CLOUDkitchen.dyg++ <span class="text-blue-600">POS</span></h1>
                <div id="memberInfo" class="text-[10px] font-semibold text-slate-400 mt-1 uppercase tracking-wider italic">Silahkan cek member...</div>
            </div>
        </div>
        
        <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-2xl w-full md:w-auto">
            <input id="nohp" type="text" placeholder="No. WA Member" class="bg-transparent border-none px-4 py-2 text-sm focus:ring-0 outline-none flex-1 md:w-40">
            <button onclick="cekMember()" class="bg-white text-blue-600 shadow-sm hover:bg-blue-600 hover:text-white px-5 py-2 rounded-xl text-xs font-bold transition-all">Cek Member</button>
        </div>
    </header>

    <main class="flex flex-1 overflow-hidden main-layout">
        
        <section class="menu-section flex-1 flex flex-col bg-[#f8fafc] overflow-hidden">
            <div class="p-4 md:p-6 flex flex-col md:flex-row gap-4 items-center">
                <div class="relative flex-1 w-full">
                    <span class="absolute left-4 top-3.5 opacity-40 text-lg">üîç</span>
                    <input type="text" id="searchInput" oninput="filterMenu()" placeholder="Cari menu..." class="w-full pl-12 pr-4 py-3.5 bg-white border border-slate-200 rounded-2xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all shadow-sm">
                </div>
                <select id="categoryFilter" onchange="filterMenu()" class="w-full md:w-56 bg-white border border-slate-200 rounded-2xl px-4 py-3.5 text-sm font-semibold focus:ring-2 focus:ring-blue-500 outline-none shadow-sm cursor-pointer">
                    <option value="ALL">Semua Kategori</option>
                </select>
            </div>

            <div id="menuList" class="px-4 md:px-6 pb-6 grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 overflow-y-auto custom-scroll content-start">
                </div>
        </section>

        <section class="cart-section w-full md:w-[380px] lg:w-[420px] flex flex-col bg-white border-l border-slate-100 shadow-2xl md:shadow-none">
            <div class="p-5 border-b border-slate-50 flex justify-between items-center bg-white">
                <div class="flex items-center gap-2">
                    <span class="text-xl">üõçÔ∏è</span>
                    <h2 class="font-bold text-slate-800 text-sm uppercase tracking-widest">Pesanan</h2>
                </div>
                <button onclick="location.reload()" class="bg-red-50 text-red-500 hover:bg-red-500 hover:text-white px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all uppercase">Reset</button>
            </div>

            <div id="cartList" class="flex-1 overflow-y-auto custom-scroll p-5 space-y-4">
                <div class="flex flex-col items-center justify-center h-full text-slate-300 opacity-60">
                    <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                        <span class="text-4xl">üõí</span>
                    </div>
                    <p class="text-sm font-medium">Keranjang masih kosong</p>
                </div>
            </div>

            <div class="p-6 bg-slate-50/80 backdrop-blur-md border-t border-slate-200 space-y-4 cart-sticky">
                <div class="space-y-3">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-slate-500 font-medium">üè∑Ô∏è Diskon/Voucher</span>
                        <div class="flex items-center gap-2">
                            <span class="text-red-500 font-bold">- Rp</span>
                            <input id="voucher" type="number" oninput="renderCart()" placeholder="0" class="w-24 text-right bg-white border border-slate-200 rounded-lg px-2 py-1 focus:ring-2 focus:ring-red-400 outline-none font-bold text-red-600">
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-end py-2">
                        <div>
                            <span class="block text-[10px] font-bold text-slate-400 uppercase tracking-wider">Total Pembayaran</span>
                            <span class="text-3xl font-black text-slate-900 leading-none">Rp <span id="total">0</span></span>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <select id="metode" onchange="renderCash()" class="w-full border border-slate-200 rounded-2xl p-4 text-sm font-bold bg-white shadow-sm focus:ring-2 focus:ring-blue-500 outline-none appearance-none cursor-pointer">
                        <option value="CASH">üíµ TUNAI (CASH)</option>
                        <option value="QRIS">üì± QRIS</option>
                        <option value="CARD">üí≥ KARTU DEBIT</option>
                    </select>

                    <div id="cashBox" class="space-y-3"></div>

                    <button onclick="submitOrder()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-extrabold text-lg shadow-xl shadow-blue-200 transition-all active:scale-[0.97] flex items-center justify-center gap-3">
                        BAYAR SEKARANG
                    </button>
                </div>
            </div>
        </section>
    </main>

<script>
/* ================= DATA & LOGIC TETAP SAMA ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyvU5fQpE_UFq_mnfAMvhCNJ97f1SvVRpXv_qrZh96lj8IBPot8xRdQ34Iz1n-HVmiuzg/exec";
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZGCGtu4xfKCj0zCGB2BldzF2fLjFCIOfVSXBAMeTM-3KGHfC9mZ_bhfaTnikwxd5427w4ULtotTJH/pub?gid=2132421401&single=true&output=csv";
const TOKEN = "dyg-access-v2";

let MENU = [];
let cart = {};
let member = null;

async function loadMenu() {
    try {
        const response = await fetch(CSV_URL);
        const data = await response.text();
        const rows = data.split("\n").slice(1);
        MENU = rows.map(row => {
            const cols = row.split(",");
            return {
                kategori: cols[0]?.trim() || "Lainnya",
                nama: cols[1]?.trim(),
                harga: parseInt(cols[2]?.trim()) || 0
            };
        }).filter(m => m.nama);
        populateCategories();
        renderMenu();
    } catch (e) { console.error("Gagal load data menu", e); }
}

function populateCategories() {
    const cats = [...new Set(MENU.map(m => m.kategori))];
    const select = document.getElementById("categoryFilter");
    cats.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c; opt.innerText = c;
        select.appendChild(opt);
    });
}

function renderMenu() {
    const list = document.getElementById("menuList");
    const search = document.getElementById("searchInput").value.toLowerCase();
    const filter = document.getElementById("categoryFilter").value;
    list.innerHTML = "";
    MENU.forEach((m, i) => {
        if ((filter === "ALL" || m.kategori === filter) && (m.nama.toLowerCase().includes(search))) {
            const el = document.createElement("div");
            el.className = "menu-card bg-white p-5 rounded-[2rem] border border-slate-100 flex flex-col justify-between cursor-pointer relative group";
            el.onclick = () => addItem(i);
            el.innerHTML = `
                <div>
                    <span class="inline-block px-2.5 py-1 bg-blue-50 text-blue-600 text-[9px] font-extrabold rounded-lg uppercase tracking-wider mb-3">${m.kategori}</span>
                    <div class="font-bold text-slate-800 text-sm leading-snug group-hover:text-blue-600 transition-colors">${m.nama}</div>
                </div>
                <div class="flex justify-between items-center mt-5">
                    <div class="text-base font-black text-slate-900">Rp ${m.harga.toLocaleString()}</div>
                    <div class="bg-slate-900 text-white rounded-xl p-2 group-hover:bg-blue-600 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    </div>
                </div>
                <span id="badge-${i}" class="hidden absolute -top-2 -right-2 bg-blue-600 text-white text-[11px] w-7 h-7 flex items-center justify-center rounded-full font-bold shadow-lg ring-4 ring-white"></span>
            `;
            list.appendChild(el);
        }
    });
    updateBadges();
}

function filterMenu() { renderMenu(); }
function addItem(i) {
    if (!cart[i]) cart[i] = { qty: 0, ...MENU[i] };
    cart[i].qty++;
    renderCart();
}
function removeItem(i) {
    cart[i].qty--;
    if (cart[i].qty <= 0) delete cart[i];
    renderCart();
}
function updateBadges() {
    MENU.forEach((_, i) => {
        const badge = document.getElementById("badge-" + i);
        if (badge) {
            if (cart[i]) {
                badge.innerText = cart[i].qty;
                badge.classList.remove("hidden");
            } else { badge.classList.add("hidden"); }
        }
    });
}

function renderCart() {
    let html = "";
    let total = 0;
    Object.keys(cart).forEach(i => {
        const item = cart[i];
        total += item.qty * item.harga;
        html += `
            <div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-100 shadow-sm animate-in slide-in-from-right-4 duration-200">
                <div class="flex-1">
                    <div class="font-bold text-slate-800 text-sm">${item.nama}</div>
                    <div class="text-[11px] font-bold text-blue-600 mt-0.5">@ Rp ${item.harga.toLocaleString()}</div>
                </div>
                <div class="flex items-center gap-3 bg-slate-50 rounded-xl p-1">
                    <button onclick="removeItem(${i})" class="w-7 h-7 rounded-lg bg-white shadow-sm flex items-center justify-center font-bold text-slate-400 hover:text-red-500 transition-colors">Ôºç</button>
                    <span class="font-black text-xs w-4 text-center text-slate-700">${item.qty}</span>
                    <button onclick="addItem(${i})" class="w-7 h-7 rounded-lg bg-white shadow-sm flex items-center justify-center font-bold text-slate-400 hover:text-blue-600 transition-colors">Ôºã</button>
                </div>
            </div>
        `;
    });
    const voucher = Number(document.getElementById("voucher").value || 0);
    document.getElementById("cartList").innerHTML = html || `<div class="flex flex-col items-center justify-center h-full text-slate-300 opacity-60"><div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mb-4"><span class="text-4xl">üõí</span></div><p class="text-sm font-medium">Keranjang masih kosong</p></div>`;
    document.getElementById("total").innerText = (total - voucher).toLocaleString();
    updateBadges();
}

function cekMember() {
    const nohp = document.getElementById("nohp").value.trim();
    if (!nohp) return;
    document.getElementById("memberInfo").innerText = "Mengecek...";
    fetch(`${API_URL}?token=${TOKEN}&action=cekMember&noHP=${nohp}`)
        .then(r => r.json())
        .then(d => {
            if (d.exists) {
                member = d;
                document.getElementById("memberInfo").innerHTML = `<span class="text-blue-600">‚úÖ ${d.nama}</span> | Poin: <span class="font-extrabold text-slate-700">${d.poin}</span>`;
            } else {
                member = null;
                document.getElementById("memberInfo").innerHTML = `<span class="text-red-500">‚ùå Bukan Member</span>`;
            }
        });
}

function renderCash() {
    const metode = document.getElementById("metode").value;
    const box = document.getElementById("cashBox");
    if (metode !== "CASH") { box.innerHTML = ""; return; }
    box.innerHTML = `
        <div class="bg-blue-600 p-5 rounded-3xl shadow-xl shadow-blue-100 text-white">
            <label class="text-[9px] font-black uppercase tracking-[0.2em] opacity-80 block mb-2">Input Uang Tunai</label>
            <div class="flex items-center">
                <span class="text-xl font-bold opacity-70 mr-2">Rp</span>
                <input id="bayar" type="number" placeholder="0" class="w-full bg-transparent border-none text-2xl font-black text-white outline-none p-0 placeholder:text-blue-300">
            </div>
            <div class="flex gap-2 mt-4">
                ${[20000, 50000, 100000].map(v => `<button onclick="quickCash(${v})" class="flex-1 bg-blue-500/30 backdrop-blur-sm border border-white/20 py-2.5 rounded-xl text-[10px] font-black hover:bg-white hover:text-blue-600 transition-all uppercase">${v/1000}rb</button>`).join("")}
            </div>
            <div class="mt-4 pt-4 border-t border-white/10 flex justify-between items-center">
                <span class="text-xs font-bold opacity-80">Kembalian</span>
                <span class="text-lg font-black tracking-wide">Rp <span id="kembali">0</span></span>
            </div>
        </div>
    `;
}

function quickCash(v) { document.getElementById("bayar").value = v; hitungKembali(); }
document.addEventListener("input", e => { if (e.target.id === "bayar") hitungKembali(); });

function hitungKembali() {
    const bayar = Number(document.getElementById("bayar")?.value || 0);
    const rawTotal = document.getElementById("total").innerText.replace(/,/g, '');
    const total = Number(rawTotal || 0);
    document.getElementById("kembali").innerText = (bayar - total).toLocaleString();
}

async function submitOrder() {
    const rawTotal = document.getElementById("total").innerText.replace(/,/g, '');
    const total = Number(rawTotal || 0);
    if (total <= 0 && Object.keys(cart).length === 0) { alert("Keranjang kosong"); return; }
    const voucher = Number(document.getElementById("voucher").value || 0);
    const finalTotal = Math.max(0, total);
    const metode = document.getElementById("metode").value;
    const noWA = document.getElementById("nohp").value || "";
    const pesanan = Object.values(cart).map(i => `${i.nama} x${i.qty}`).join(", ");
    
    // Tampilkan loading state sederhana di tombol
    const btn = event.target;
    const originalTxt = btn.innerText;
    btn.innerText = "MEMPROSES...";
    btn.disabled = true;

    try {
        const url = `${API_URL}?token=${TOKEN}&action=processPayment&total=${finalTotal}&noWA=${noWA}&redeemQty=0&voucher=${voucher}&method=${metode}&pesanan=${encodeURIComponent(pesanan)}`;
        const res = await fetch(url);
        const txt = await res.text();

        if (txt === "SUCCESS") {
            let esc = "\x1B\x40\x1B\x61\x01\x1B\x21\x10dyg++ RETAIL\x1B\x21\x00\n";
            esc += "Tgl: " + new Date().toLocaleString() + "\n--------------------------------\n\x1B\x61\x00";
            Object.values(cart).forEach(i => {
                esc += `${i.nama}\n${i.qty} x ${i.harga.toLocaleString()} = ${(i.qty*i.harga).toLocaleString()}\n`;
            });
            esc += "--------------------------------\nTOTAL: Rp " + finalTotal.toLocaleString() + "\n";
            if (noWA) esc += "Member: " + noWA + "\n";
            esc += "\nTERIMA KASIH\n\n\n\n";

            if (window.AppInventor) window.AppInventor.setWebViewString("PRINT|" + esc);
            alert("Transaksi Berhasil ‚úÖ");
            location.reload();
        } else {
            alert("Gagal menyimpan transaksi.");
            btn.innerText = originalTxt;
            btn.disabled = false;
        }
    } catch (e) {
        alert("Terjadi kesalahan sistem.");
        btn.innerText = originalTxt;
        btn.disabled = false;
    }
}

// Start
loadMenu();
renderCash();
</script>
</body>
</html>