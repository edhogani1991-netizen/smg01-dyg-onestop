<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>dyg++ POS FINAL COMPACT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .main-container { height: calc(100vh - 56px); display: flex; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 6px; align-content: start; }
        .menu-card { transition: transform 0.1s; border: 1px solid #e2e8f0; }
        .menu-card:active { transform: scale(0.96); }
        #voucherSection { transition: all 0.3s ease-in-out; max-height: 0; overflow: hidden; opacity: 0; }
        #voucherSection.open { max-height: 100px; opacity: 1; margin-top: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col">

<header class="h-[52px] bg-white border-b border-slate-200 px-4 flex justify-between items-center shrink-0">
    <div class="flex items-center gap-3">
        <h1 class="text-lg font-extrabold text-blue-700 tracking-tighter">CLOUDkitchen.dyg++</h1>
        <div id="memberInfo" class="hidden md:block text-[10px] text-slate-500 italic truncate max-w-[150px]">Ready</div>
    </div>
    
    <div class="flex items-center gap-3">
        <div id="shiftArea" class="flex items-center gap-2">
            <button id="btnOpenShift" onclick="manageShift('open')" class="bg-emerald-600 text-white px-2 py-1.5 rounded-lg text-[10px] font-bold">BUKA SHIFT</button>
            <button id="btnCloseShift" onclick="manageShift('close')" class="bg-rose-600 text-white px-2 py-1.5 rounded-lg text-[10px] font-bold hidden">TUTUP SHIFT</button>
        </div>
        
        <div class="flex items-center gap-1 border-l border-slate-200 pl-3">
            <input id="nohp" type="text" placeholder="No WA" class="bg-slate-100 rounded-lg px-3 py-1.5 text-xs outline-none w-24 md:w-36">
            <button onclick="cekMember()" class="bg-blue-600 text-white px-3 py-1.5 rounded-lg text-[11px] font-bold">Cek</button>
        </div>
    </div>
</header>

<main class="flex flex-1 overflow-hidden main-container">
    <section class="flex-1 flex flex-col bg-slate-50 overflow-hidden">
        <div class="p-2 flex gap-2 bg-white border-b border-slate-200">
            <input type="text" id="searchInput" oninput="renderMenu()" placeholder="Cari menu..." class="flex-1 px-3 py-1.5 bg-slate-100 rounded-lg text-xs outline-none">
            <select id="categoryFilter" onchange="renderMenu()" class="bg-slate-100 rounded-lg px-2 py-1.5 text-xs font-semibold outline-none w-28">
                <option value="ALL">Semua</option>
            </select>
        </div>
        <div id="menuList" class="menu-grid p-2 overflow-y-auto custom-scroll flex-1"></div>
    </section>

    <section class="cart-panel w-[310px] flex flex-col bg-white border-l border-slate-200 shrink-0">
        <div class="p-2 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <h2 class="font-bold text-slate-700 text-[10px] uppercase tracking-widest">üõí KERANJANG</h2>
            <button onclick="location.reload()" class="text-[9px] text-red-500 font-bold">RESET</button>
        </div>
        <div id="cartList" class="flex-1 overflow-y-auto custom-scroll p-2 space-y-1.5">
            <div class="flex flex-col items-center justify-center h-full text-slate-300 text-[10px]">Kosong</div>
        </div>

        <div class="p-2 bg-white border-t border-slate-200">
            <div id="pointDiscWrapper" class="hidden flex justify-between px-1 text-[10px] font-bold text-red-600 mb-1 animate-pulse">
                <span>PROMO POIN MEMBER</span>
                <span>- Rp <span id="pointDiscNominal">0</span></span>
            </div>

            <div class="flex justify-between items-center mb-1 px-1">
                <span class="font-bold text-slate-500 text-[10px]">TOTAL BELANJA</span>
                <span class="text-xs font-bold text-slate-700">Rp <span id="totalKotor">0</span></span>
            </div>

            <div class="flex justify-between items-center mb-1 px-1">
                <span class="font-bold text-slate-700 text-[11px]">TOTAL TAGIHAN</span>
                <span class="text-xl font-black text-blue-700 leading-none">Rp <span id="total">0</span></span>
            </div>

            <div class="space-y-1.5">
                <select id="metode" onchange="renderCash()" class="w-full border border-slate-200 rounded-md p-1.5 text-[11px] font-bold outline-none">
                    <option value="CASH">üíµ TUNAI</option>
                    <option value="QRIS">üì± QRIS</option>
                </select>
                <div id="cashBox"></div>
                <button id="btnSubmitOrder" onclick="submitOrder()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold text-[12px] uppercase">Bayar & Cetak</button>
            </div>
        </div>
    </section>
</main>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwTo5_KeeT_HN7T1zMJG8EEQV1B4GoUic3he6eFQtUk4KAR3NSMb0Ml9x2IvBJ7_TEnIA/exec";
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZGCGtu4xfKCj0zCGB2BldzF2fLjFCIOfVSXBAMeTM-3KGHfC9mZ_bhfaTnikwxd5427w4ULtotTJH/pub?gid=2132421401&single=true&output=csv";
const TOKEN = "dyg-access-v2";

let MENU = [], cart = {}, member = null, redeemQty = 0, pointDiscount = 0, shiftOpen = false, pendingOrder = null;

async function checkShiftStatus() {
    try {
        const res = await fetch(`${API_URL}?token=${TOKEN}&action=getShiftStatus`);
        const status = await res.text();
        shiftOpen = (status === "OPEN");
        document.getElementById("btnOpenShift").classList.toggle("hidden", shiftOpen);
        document.getElementById("btnCloseShift").classList.toggle("hidden", !shiftOpen);
        const btnSubmit = document.getElementById("btnSubmitOrder");
        btnSubmit.disabled = !shiftOpen;
        if (!shiftOpen) btnSubmit.innerText = "BUKA SHIFT DULU";
    } catch (e) { console.error(e); }
}

async function loadMenu() {
    const response = await fetch(CSV_URL);
    const data = await response.text();
    const rows = data.split("\n").slice(1);
    MENU = rows.map(row => {
        const c = row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
        return { kategori: c[0]?.trim(), nama: c[1]?.trim(), harga: parseInt(c[2]) || 0 };
    }).filter(m => m.nama);
    
    const cats = [...new Set(MENU.map(m => m.kategori))];
    const select = document.getElementById("categoryFilter");
    select.innerHTML = '<option value="ALL">Semua</option>';
    cats.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`);
    renderMenu();
}

function renderMenu() {
    const list = document.getElementById("menuList");
    const search = document.getElementById("searchInput").value.toLowerCase();
    const filter = document.getElementById("categoryFilter").value;
    list.innerHTML = "";
    MENU.forEach((m, i) => {
        if ((filter === "ALL" || m.kategori === filter) && m.nama.toLowerCase().includes(search)) {
            list.innerHTML += `
            <div class="menu-card bg-white p-2 rounded-lg shadow-sm flex flex-col justify-between cursor-pointer" onclick="addItem(${i})">
                <div>
                    <div class="text-[7px] font-bold text-blue-500 uppercase">${m.kategori}</div>
                    <div class="font-bold text-slate-800 text-[10px] leading-tight line-clamp-2">${m.nama}</div>
                </div>
                <div class="text-[10px] font-black text-slate-900 mt-2">Rp${m.harga.toLocaleString()}</div>
            </div>`;
        }
    });
}

function addItem(i) {
    if (!cart[i]) cart[i] = { ...MENU[i], qty: 0 };
    cart[i].qty++;
    renderCart();
}

function removeItem(i) {
    cart[i].qty--;
    if (cart[i].qty <= 0) delete cart[i];
    renderCart();
}

function renderCart() {
    let html = "", kotor = 0;
    Object.keys(cart).forEach(i => {
        const item = cart[i];
        kotor += item.qty * item.harga;
        html += `
        <div class="flex justify-between items-center bg-slate-50 p-1.5 rounded-md border border-slate-100">
            <span class="font-bold text-slate-800 text-[10px] flex-1 truncate">${item.nama}</span>
            <div class="flex items-center gap-1.5">
                <button onclick="removeItem(${i})" class="w-5 h-5 bg-white border rounded text-[10px]">Ôºç</button>
                <span class="font-bold text-[10px]">${item.qty}</span>
                <button onclick="addItem(${i})" class="w-5 h-5 bg-white border rounded text-[10px]">Ôºã</button>
            </div>
        </div>`;
    });
    document.getElementById("totalKotor").innerText = kotor.toLocaleString();
    const bersih = Math.max(0, kotor - pointDiscount);
    document.getElementById("total").innerText = bersih.toLocaleString();
    document.getElementById("cartList").innerHTML = html || '<div class="text-center text-slate-300 text-[10px]">Kosong</div>';
    document.getElementById("pointDiscWrapper").classList.toggle("hidden", pointDiscount <= 0);
    document.getElementById("pointDiscNominal").innerText = pointDiscount.toLocaleString();
    renderCash();
}

function renderCash() {
    const box = document.getElementById("cashBox");
    const total = Number(document.getElementById("total").innerText.replace(/\D/g,''));
    if (document.getElementById("metode").value !== "CASH" || total <= 0) { box.innerHTML = ""; return; }
    box.innerHTML = `
    <div class="bg-blue-50 p-1.5 rounded-md border border-blue-100 space-y-1 mt-1">
        <input id="bayar" type="number" oninput="hitungKembali()" placeholder="Uang Tunai" class="w-full bg-white border rounded px-2 py-1 text-right text-[11px] font-black outline-none">
        <div class="flex justify-between text-[9px] font-bold text-blue-700 px-1">
            <span>KEMBALI</span><span>Rp <span id="kembali">0</span></span>
        </div>
    </div>`;
}

function hitungKembali() {
    const t = Number(document.getElementById("total").innerText.replace(/\D/g,''));
    const b = Number(document.getElementById("bayar").value);
    document.getElementById("kembali").innerText = Math.max(0, b - t).toLocaleString();
}

function cekMember() {
    const no = document.getElementById("nohp").value.trim();
    if (!no) return;
    document.getElementById("memberInfo").innerText = "Mengecek...";
    fetch(`${API_URL}?token=${TOKEN}&action=cekMember&noHP=${no}`)
        .then(r => r.json()).then(d => {
            if (d.exists) {
                member = d;
                document.getElementById("memberInfo").innerHTML = `<span class="text-blue-600 font-bold">‚úÖ ${d.nama} (${d.poin} Poin)</span>`;
                if (d.poin >= 500) {
                    let maxTukar = Math.floor(d.poin / 500) * 500;
                    if (confirm(`Tukarkan ${maxTukar} poin untuk diskon Rp${(maxTukar * 10).toLocaleString()}?`)) {
                        redeemQty = maxTukar;
                        pointDiscount = maxTukar * 10;
                        renderCart();
                    }
                }
            } else {
                alert("Nomor tidak terdaftar");
                member = null;
            }
        });
}

function submitOrder() {
    if (!shiftOpen) return alert("Buka shift dulu!");
    const total = Number(document.getElementById("total").innerText.replace(/\D/g,''));
    if (total <= 0) return alert("Keranjang kosong!");

    const btn = document.getElementById("btnSubmitOrder");
    btn.innerText = "MENCETAK..."; btn.disabled = true;

    const trxId = "TRX-" + Date.now();
    const pesanan = Object.values(cart).map(i => `${i.nama} x${i.qty}`).join(", ");
    
    pendingOrder = { total, noWA: document.getElementById("nohp").value || "-", pesanan, metode: document.getElementById("metode").value, trxId };

    const earn = (member) ? Math.floor(total / 20000) * 100 : 0;
    const totalPoinAkhir = (member) ? (Number(member.poin) + earn - redeemQty) : 0;

    let esc = "\x1B\x40\x1B\x61\x01\x1B\x21\x10dyg++ CLOUD KITCHEN\x1B\x21\x00\n";
    esc += "ID: " + trxId + "\n--------------------------------\n\x1B\x61\x00";
    Object.values(cart).forEach(i => esc += `${i.nama}\n${i.qty} x ${i.harga} = ${i.qty * i.harga}\n`);
    esc += "--------------------------------\n";
    esc += "TOTAL   : Rp " + total.toLocaleString() + "\n";
    esc += "MEMBER  : " + (member ? member.nama : "-") + "\n";
    esc += "POIN +  : " + earn + "\n";
    esc += "SISA POIN: " + totalPoinAkhir + "\n";
    esc += "--------------------------------\n\x1B\x61\x01TERIMA KASIH\n\n\n\n\n";

    if (window.AppInventor) {
        window.AppInventor.setWebViewString("PRINT|" + esc);
        setTimeout(prosesSimpanKeCloud, 2000);
    } else {
        console.log(esc);
        prosesSimpanKeCloud();
    }
}

async function prosesSimpanKeCloud() {
    const p = new URLSearchParams({
        token: TOKEN, action: "processPayment",
        total: pendingOrder.total, pesanan: pendingOrder.pesanan,
        method: pendingOrder.metode, trxId: pendingOrder.trxId,
        noWA: pendingOrder.noWA, redeemQty: redeemQty
    });
    await fetch(`${API_URL}?${p.toString()}`, { mode: 'no-cors' });
    alert("Transaksi Berhasil!");
    location.reload();
}

async function manageShift(type) {
    if (type === 'open') {
        if (!confirm("Buka shift?")) return;
        await fetch(`${API_URL}?token=${TOKEN}&action=openShift`, { mode: 'no-cors' });
        setTimeout(() => location.reload(), 1000);
    } else {
        if (!confirm("Tutup shift & Cetak Laporan?")) return;
        const res = await fetch(`${API_URL}?token=${TOKEN}&action=getShiftReport`);
        const r = await res.json();
        
        let esc = "\x1B\x40\x1B\x61\x01\x1B\x21\x10LAPORAN TUTUP SHIFT\x1B\x21\x00\n";
        esc += (r.shiftName || "Shift") + "\n--------------------------------\n\x1B\x61\x00";
        esc += "Total Trx       : " + r.totalTrx + "\n";
        esc += "Total Pemasukan : Rp " + (r.totalPemasukan || 0).toLocaleString() + "\n";
        esc += "  - CASH        : Rp " + (r.cash || 0).toLocaleString() + "\n";
        esc += "  - QRIS        : Rp " + (r.qris || 0).toLocaleString() + "\n";
        esc += "--------------------------------\nINFO MEMBER & POIN:\n";
        const memberList = Object.keys(r.members || {});
        esc += "Total Member    : " + memberList.length + "\n";
        esc += "Poin Didapat    : " + (r.totalPoinDapat || 0) + "\n";
        esc += "Poin Ditukar    : " + (r.totalPoinRedeem || 0) + "\n";
        if (memberList.length > 0) {
            esc += "RINCIAN POIN MEMBER:\n";
            memberList.forEach(m => esc += `- ${m}: +${r.members[m]}\n`);
        }
        esc += "\n\n\n\n\n";

        if (window.AppInventor) window.AppInventor.setWebViewString("PRINT|" + esc);
        setTimeout(async () => {
            await fetch(`${API_URL}?token=${TOKEN}&action=closeShift`, { mode: 'no-cors' });
            location.reload();
        }, 2000);
    }
}

window.onload = () => { loadMenu(); checkShiftStatus(); };
</script>
</body>
</html>