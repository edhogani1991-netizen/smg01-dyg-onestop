<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>dyg++ POS ULTIMATE V7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Plus Jakarta Sans',sans-serif;background:#0f172a;display:flex;justify-content:center;height:100dvh;overflow:hidden}
        .pos-container{width:100%;max-width:1100px;background:#F1F5F9;display:flex;flex-direction:column}
        .main-content{display:flex;flex:1;overflow:hidden}
        .menu-side{flex:1;display:flex;flex-direction:column;background:#F8FAFC;border-right:1px solid #e2e8f0}
        .admin-side{width:360px;display:flex;flex-direction:column;background:white;border-left:2px solid #cbd5e1;height:100%}
        .scroll-area{flex:1;overflow-y:auto;padding:12px}
        .collapse-content{display:none}
        .handle{cursor:pointer;background:#1e293b;color:#fbbf24;text-align:center;font-size:10px;padding:12px;font-weight:800;border-radius:8px;margin-bottom:8px;text-transform:uppercase}
        .handle-member{background:#1e40af;color:white}
        .badge-qty { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 99px; font-weight: 800; border: 2px solid white; }
        .payment-btn{background:#e2e8f0; padding:8px; border-radius:8px; font-size:10px; font-weight:800; text-align:center; cursor:pointer}
        .btn-locked{background:#cbd5e1 !important; color:#94a3b8 !important; cursor:not-allowed !important}
    </style>
</head>
<body>

<div class="pos-container shadow-2xl">
    <div class="bg-[#1B4332] text-white p-3 flex justify-between items-center shrink-0">
        <h1 class="text-lg font-black italic text-emerald-400 uppercase tracking-tighter">dyg++ POS</h1>
        <div id="v-header-cash" class="text-lg font-black text-emerald-400 font-mono">Rp 0</div>
    </div>

    <div class="main-content">
        <div class="menu-side overflow-y-auto">
            <div class="p-2 border-b bg-white flex gap-2">
                <select id="cat-select" onchange="filterCat(this.value)" class="flex-1 p-2 bg-slate-100 border rounded-lg text-[10px] font-black uppercase outline-none"></select>
                <input type="text" id="menuSearch" oninput="renderMenu()" placeholder="Cari menu..." class="w-32 p-2 bg-slate-100 border rounded-lg text-[10px] font-bold outline-none">
            </div>
            <div id="menu-render" class="grid grid-cols-4 gap-2 p-3"></div>
        </div>

        <div class="admin-side">
            <div class="scroll-area space-y-2">
                
                <div onclick="toggleSection('sec-finance')" class="handle">üìä FINANCE DASHBOARD</div>
                <div id="sec-finance" class="collapse-content space-y-3 p-3 bg-slate-100 rounded-xl border mb-2">
                    <div class="bg-white p-2 rounded-lg shadow-sm border text-[10px] font-bold">
                        <table class="w-full">
                            <tr><td>MODAL</td><td id="t-modal" class="text-right">0</td></tr>
                            <tr class="text-emerald-600"><td>CASH IN</td><td id="t-cash" class="text-right">0</td></tr>
                            <tr class="text-blue-600"><td>QRIS/TRF</td><td id="t-qris" class="text-right">0</td></tr>
                            <tr class="text-red-500"><td>BIAYA OUT</td><td id="t-out" class="text-right">0</td></tr>
                        </table>
                    </div>
                    
                    <div class="space-y-2">
                        <div class="flex gap-2">
                            <input type="number" id="input-modal" placeholder="Input Modal..." class="flex-1 p-2 border rounded text-xs font-bold outline-none">
                            <button id="btn-buka-shift" onclick="bukaShift()" class="bg-emerald-600 text-white px-4 rounded font-black text-[9px]">BUKA</button>
                        </div>
                        <button id="btn-tutup-shift" onclick="tutupShift()" class="w-full bg-red-600 text-white py-2 rounded font-black text-[10px] hidden uppercase shadow-md">Tutup Shift & Settle</button>
                    </div>

                    <div class="grid grid-cols-2 gap-2 border-t pt-2">
                        <button onclick="saveFinance('pengeluaran', 'Biaya')" class="bg-orange-500 text-white p-2 rounded text-[9px] font-black uppercase shadow-sm">Pengeluaran</button>
                        <button onclick="saveFinance('online_food', 'Online')" class="bg-purple-500 text-white p-2 rounded text-[9px] font-black uppercase shadow-sm">Online Food</button>
                    </div>
                </div>

                <div onclick="toggleSection('sec-member')" class="handle handle-member">üé´ MEMBER & VOUCHER</div>
                <div id="sec-member" class="collapse-content space-y-3 p-3 bg-blue-50 rounded-xl border border-blue-200 mb-2">
                    <div class="bg-white p-2 rounded shadow-sm border">
                        <input type="number" id="member-hp" placeholder="No HP Member" class="w-full p-2 border rounded text-xs font-bold mb-2 outline-none">
                        <button onclick="cekMember()" class="w-full bg-blue-600 text-white py-2 rounded font-black text-[9px] uppercase">Cek Poin</button>
                    </div>
                    <div id="member-info" class="mt-2 hidden p-2 bg-blue-600 text-white rounded text-[10px]">
                        <p id="m-nama" class="font-black"></p><p id="m-poin" class="font-bold text-yellow-300"></p>
                        <button id="btn-redeem" onclick="applyRedeem()" class="mt-2 w-full bg-white text-blue-700 py-1.5 rounded font-black uppercase">Tukar Poin</button>
                    </div>
                    <div class="bg-white p-2 rounded shadow-sm border">
                        <input type="text" id="voucher-code" placeholder="Kode Voucher..." class="w-full p-2 border rounded text-xs font-bold mb-2 outline-none uppercase">
                        <button onclick="applyVoucher()" class="w-full bg-slate-800 text-white py-2 rounded font-black text-[9px] uppercase">Gunakan Voucher</button>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-2 border-2 border-slate-200 min-h-[140px]">
                    <div id="cart-list" class="space-y-2"></div>
                </div>
            </div>

            <div class="sticky-bottom p-4 border-t-2 bg-white">
                <div class="flex justify-between items-center mb-3">
                    <select id="pay-method" onchange="togglePayView()" class="w-full p-2 bg-slate-100 border rounded font-black text-[11px] outline-none">
                        <option value="TUNAI">üíµ PEMBAYARAN TUNAI</option>
                        <option value="QRIS">üì± QRIS / TRANSFER</option>
                        <option value="KARTU">üí≥ KARTU DEBIT/CC</option>
                    </select>
                </div>

                <div id="cash-input-area" class="space-y-2 mb-3">
                    <input type="number" id="input-bayar" oninput="hitungKembalian()" placeholder="Jumlah Uang..." class="w-full p-3 bg-yellow-50 border-2 border-yellow-200 rounded-xl text-lg font-black outline-none">
                    <div id="smart-chips" class="grid grid-cols-4 gap-1"></div>
                    <div class="flex justify-between text-[11px] font-black text-blue-600 px-1">
                        <span>KEMBALIAN:</span><span id="v-kembali">Rp 0</span>
                    </div>
                </div>

                <div class="flex justify-between text-[#1B4332] mb-1">
                    <span class="font-black text-[11px] uppercase">Total</span>
                    <span id="v-total" class="text-3xl font-black">Rp 0</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="btConnect()" class="bg-slate-200 text-slate-700 px-4 rounded-xl text-lg">üñ®Ô∏è</button>
                    <button onclick="submitOrder()" id="btn-order" class="flex-1 bg-[#1B4332] text-white py-4 rounded-2xl font-black text-[14px] shadow-lg uppercase">Bayar & Cetak</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const CONFIG={
    API:"https://script.google.com/macros/s/AKfycbxAVxXCITylZ2S3W1Hpc-zmj6bib4iM-O71-Ka4KjzdUxFGkRR-5Yc2dnmJNnR3JJK3Cw/exec",
    CSV:"https://docs.google.com/spreadsheets/d/e/2PACX-1vQZGCGtu4xfKCj0zCGB2BldzF2fLjFCIOfVSXBAMeTM-3KGHfC9mZ_bhfaTnikwxd5427w4ULtotTJH/pub?gid=2132421401&single=true&output=csv",
    TOKEN:"dyg-access-v2"
};

let cart={}, menuData=[], activeCat='ALL', memberData=null, discount=0, finalTotal=0;

// --- UTILITY ---
function toggleSection(id){ document.getElementById(id).style.display = (document.getElementById(id).style.display === "block") ? "none" : "block"; }
function togglePayView(){ document.getElementById("cash-input-area").style.display = (document.getElementById("pay-method").value === "TUNAI") ? "block" : "none"; }
function btConnect(){ if(window.AppInventor) window.AppInventor.setWebViewString("CONNECT"); }

// --- SHIFT SYSTEM ---
function checkShiftStatus() {
    const isShiftOpen = localStorage.getItem("shiftActive") === "true";
    const btnBuka = document.getElementById("btn-buka-shift");
    const inputModal = document.getElementById("input-modal");
    if(isShiftOpen) {
        btnBuka.classList.add("btn-locked"); btnBuka.disabled = true; btnBuka.innerText = "OPENED";
        inputModal.disabled = true; inputModal.value = localStorage.getItem("modalValue");
        document.getElementById("btn-tutup-shift").classList.remove("hidden");
    }
}

async function bukaShift() {
¬† ¬† const val = document.getElementById("input-modal").value;
¬† ¬† if(!val || val <= 0) return alert("Isi Modal!");
¬† ¬†¬†
¬† ¬† // Ini akan menambah baris baru di sheet 'modal' dengan jam SEKARANG
¬† ¬† // Jam ini yang akan jadi patokan getFinance untuk menghitung transaksi ke depan
¬† ¬† await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=saveFinance&type=modal&data=${encodeURIComponent(JSON.stringify(["","Modal Awal",val]))}`);
¬† ¬†¬†
¬† ¬† localStorage.setItem("shiftActive", "true");¬†
¬† ¬† localStorage.setItem("modalValue", val);
¬† ¬† location.reload();¬†
}

lalu ini sudah sesuai kan,,aku tinggal ganti saja yg lama dengan ini?
async function tutupShift() {
    const f = window.finData;
    // Hitung saldo yang seharusnya ada di laci (Modal + Cash - Out)
    const sys = (f.totalModal + f.totalCash) - f.totalOut;
    
    const fisik = prompt("Input Total Uang Fisik di Laci saat ini:", sys);
    if(fisik === null) return; // Batal jika klik cancel
    
    const konfirmasi = confirm("Yakin ingin TUTUP SHIFT? Semua angka laporan akan di-restart ke 0.");
    if(!konfirmasi) return;

    try {
        const pay = JSON.stringify({ 
            sys: sys, 
            fisik: fisik, 
            selisih: fisik - sys 
        });

        // 1. Kirim data settle ke server
        await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=settle&data=${encodeURIComponent(pay)}`);
        
        // 2. Hapus data lokal di browser
        localStorage.removeItem("shiftActive");
        localStorage.removeItem("modalValue");

        // 3. RESTART UI secara manual agar jadi 0 semua tanpa nunggu server
        resetDashboardUI();

        alert("Shift Berhasil Ditutup & Laporan Di-restart!");
        
        // 4. Refresh halaman untuk memastikan kondisi bersih
        location.reload();
    } catch(e) {
        alert("Gagal koneksi saat tutup shift. Coba lagi.");
    }
}

function resetDashboardUI() {
    // Reset angka di Header
    document.getElementById("v-header-cash").innerText = "Rp 0";
    
    // Reset angka di Tabel Dashboard
    document.getElementById("t-modal").innerText = "0";
    document.getElementById("t-cash").innerText = "0";
    document.getElementById("t-qris").innerText = "0";
    document.getElementById("t-out").innerText = "0";
    
    // Reset variabel global
    window.finData = { totalModal:0, totalCash:0, totalQris:0, totalOut:0, totalOnline:0 };
}

// --- DASHBOARD MONITOR ---
async function updateMonitor() {
    try {
        const r = await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=getFinance&ts=${new Date().getTime()}`);
        const f = await r.json(); window.finData = f;
        document.getElementById("v-header-cash").innerText = "Rp " + ((f.totalModal + f.totalCash) - f.totalOut).toLocaleString();
        document.getElementById("t-modal").innerText = Number(f.totalModal).toLocaleString();
        document.getElementById("t-cash").innerText = Number(f.totalCash).toLocaleString();
        document.getElementById("t-qris").innerText = Number(f.totalQris).toLocaleString();
        document.getElementById("t-out").innerText = Number(f.totalOut).toLocaleString();
    } catch(e) {}
}

async function saveFinance(t, l) {
    if(localStorage.getItem("shiftActive") !== "true") return alert("Buka Shift Dulu!");
    const v = prompt("Nominal " + l + ":");
    if(!v) return;
    await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=saveFinance&type=${t}&data=${encodeURIComponent(JSON.stringify(["",l,v]))}`);
    updateMonitor();
}

// --- TRANSAKSI & PRINT ---
async function submitOrder(){
    if(localStorage.getItem("shiftActive") !== "true") return alert("Buka Shift Dulu!");
    if(finalTotal <= 0) return alert("Keranjang kosong!");
    const method = document.getElementById("pay-method").value;
    const bayar = document.getElementById("input-bayar").value || 0;
    if(method === "TUNAI" && bayar < finalTotal) return alert("Uang kurang!");

    document.getElementById("btn-order").disabled = true;
    try {
        const hp = memberData ? memberData.noHP : "";
        await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=processOrder&total=${finalTotal}&noHP=${hp}&poinRedeem=${discount}&pesanan=${encodeURIComponent(JSON.stringify(cart))}&method=${method}`);
        
        // FUNGSI PRINT ESC/POS
        let esc = "\x1B\x40\x1B\x61\x01dyg++ POS SECURE\n--------------------------------\n\x1B\x61\x00";
        Object.keys(cart).forEach(n => {
            esc += `${n.toUpperCase()}\n${cart[n].qty} x ${cart[n].price.toLocaleString()} = ${(cart[n].qty*cart[n].price).toLocaleString()}\n`;
        });
        if(discount > 0) esc += `POTONGAN: -${discount.toLocaleString()}\n`;
        esc += `--------------------------------\nTOTAL  : Rp ${finalTotal.toLocaleString()}\nBAYAR  : Rp ${Number(bayar).toLocaleString()}\nMETODE : ${method}\n\x1B\x61\x01\nTERIMA KASIH\n\n\n\n\n`;
        
        if (window.AppInventor) window.AppInventor.setWebViewString("PRINT|" + esc);
        
        alert("Berhasil!"); location.reload();
    } catch(e){ alert("Gagal!"); document.getElementById("btn-order").disabled = false; }
}

// --- SISTEM KERANJANG & SMART CHIPS ---
function updateCartUI(){
    let sub=0; const l=document.getElementById("cart-list"); l.innerHTML="";
    Object.keys(cart).forEach(n=>{
        sub += cart[n].price * cart[n].qty;
        l.innerHTML+=`<div class="flex justify-between items-center text-[10px] font-black uppercase"><span>${n} x${cart[n].qty}</span><div class="flex gap-1"><button onclick="changeQty('${n}',-1)" class="w-5 h-5 bg-slate-200 rounded">-</button><button onclick="changeQty('${n}',1)" class="w-5 h-5 bg-slate-800 text-white rounded">+</button></div></div>`;
    });
    finalTotal = Math.max(0, sub - discount);
    document.getElementById("v-total").innerText="Rp "+ finalTotal.toLocaleString();
    const chips = [finalTotal]; [10000, 20000, 50000, 100000].forEach(n => { if(n > finalTotal) chips.push(n); });
    const area = document.getElementById("smart-chips"); area.innerHTML="";
    [...new Set(chips)].sort((a,b)=>a-b).slice(0,4).forEach(amt => {
        area.innerHTML += `<div onclick="setCash(${amt})" class="payment-btn">${amt === finalTotal ? 'PAS' : amt.toLocaleString()}</div>`;
    });
}
function setCash(amt){ document.getElementById("input-bayar").value = amt; hitungKembalian(); }
function hitungKembalian(){
    const b = document.getElementById("input-bayar").value || 0;
    document.getElementById("v-kembali").innerText = "Rp " + (b - finalTotal > 0 ? (b - finalTotal).toLocaleString() : 0);
}
function changeQty(n, d) { cart[n].qty += d; if(cart[n].qty <= 0) delete cart[n]; updateCartUI(); renderMenu(); }
function addToCart(n,p){ cart[n]={price:p, qty:(cart[n]?.qty||0)+1}; updateCartUI(); renderMenu(); }

// --- DATA & MENU ---
async function loadMenu(){
    const r=await fetch(CONFIG.CSV); const t=await r.text();
    menuData = t.split("\n").slice(1).map(r => { const c = r.split(","); return { kat: c[0]?.trim(), nama: c[1]?.trim(), harga: parseInt(c[2]) || 0 }; }).filter(m => m.nama);
    document.getElementById("cat-select").innerHTML = ["ALL", ...new Set(menuData.map(m => m.kat))].map(c => `<option value="${c}">${c}</option>`).join("");
    renderMenu();
}
function renderMenu(){
    const c=document.getElementById("menu-render"); const s=document.getElementById("menuSearch").value.toLowerCase(); c.innerHTML="";
    menuData.filter(m => (activeCat === 'ALL' || m.kat === activeCat) && m.nama.toLowerCase().includes(s)).forEach(m=>{
        const q = cart[m.nama]?.qty || 0;
        c.innerHTML+=`<div onclick="addToCart('${m.nama}',${m.harga})" class="relative bg-white p-3 rounded-xl shadow-sm border border-slate-200 active:scale-95 cursor-pointer text-[10px] font-black uppercase"><div>${m.nama}</div><div class="text-emerald-600">Rp ${m.harga.toLocaleString()}</div>${q>0?`<div class="badge-qty">${q}</div>`:''}</div>`;
    });
}
function filterCat(v){ activeCat=v; renderMenu(); }
async function cekMember() {
    const hp = document.getElementById("member-hp").value; if(!hp) return;
    const r = await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=cekMember&noHP=${hp}`);
    const d = await r.json();
    if(d.exists) {
        memberData = d; memberData.noHP = hp;
        document.getElementById("m-nama").innerText = d.nama; document.getElementById("m-poin").innerText = "Poin: " + d.poin.toLocaleString();
        document.getElementById("member-info").classList.remove("hidden");
        document.getElementById("btn-redeem").style.display = d.poin >= 5000 ? "block" : "none";
    }
}
function applyRedeem(){ discount = memberData.poin; updateCartUI(); }
function applyVoucher(){ alert("Voucher sedang divalidasi..."); }

window.onload=()=>{ loadMenu(); updateMonitor(); checkShiftStatus(); }
</script>
</body>
</html>