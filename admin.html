<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>dyg++ POS Compact</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .main-container { height: calc(100vh - 56px); display: flex; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 6px; align-content: start; }
        @media (max-width: 640px) {
            .menu-grid { grid-template-columns: repeat(2, 1fr); }
            .main-container { flex-direction: column; overflow-y: auto; height: calc(100vh - 60px); }
            .cart-panel { width: 100% !important; height: auto !important; border-l: none; border-t: 2px solid #e2e8f0; }
        }
        .menu-card { transition: transform 0.1s; border: 1px solid #e2e8f0; }
        .menu-card:active { transform: scale(0.96); }
        #voucherSection { transition: all 0.3s ease-in-out; max-height: 0; overflow: hidden; opacity: 0; }
        #voucherSection.open { max-height: 100px; opacity: 1; margin-top: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col">

<header class="h-[52px] bg-white border-b border-slate-200 px-4 flex justify-between items-center shrink-0">
    <div class="flex items-center gap-3">
        <h1 class="text-lg font-extrabold text-blue-700 tracking-tighter">CLOUDkitchen.dyg++ <span class="text-slate-400 font-medium">RETAIL</span></h1>
        <div id="memberInfo" class="hidden md:block text-[10px] text-slate-500 italic truncate max-w-[150px]">Cek member...</div>
    </div>
    
    <div id="shiftArea" class="flex items-center gap-2">
    <div id="shiftAlert" class="hidden flex items-center gap-1 bg-amber-100 border border-amber-300 px-2 py-1 rounded-md animate-pulse">
        <span class="text-amber-600">‚ö†Ô∏è</span>
        <span id="alertText" class="text-[9px] font-bold text-amber-800 uppercase tracking-tighter"></span>
    </div>
            <button id="btnOpenShift" onclick="manageShift('open')" class="bg-emerald-600 hover:bg-emerald-700 text-white px-2 py-1.5 rounded-lg text-[10px] font-bold transition">BUKA SHIFT</button>
            <button id="btnCloseShift" onclick="manageShift('close')" class="bg-rose-600 hover:bg-rose-700 text-white px-2 py-1.5 rounded-lg text-[10px] font-bold transition hidden">TUTUP SHIFT</button>
        </div>
        
        <div class="flex items-center gap-1">
            <input id="nohp" type="text" placeholder="No WA" class="bg-slate-100 border-none rounded-lg px-3 py-1.5 text-xs focus:ring-2 focus:ring-blue-500 outline-none w-24 md:w-36">
            <button onclick="cekMember()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-[11px] font-bold transition">Cek</button>
        </div>
    </div>
</header>

<main class="flex flex-1 overflow-hidden main-container">
    <section class="flex-1 flex flex-col bg-slate-50 overflow-hidden">
        <div class="p-2 flex gap-2 bg-white border-b border-slate-200">
            <input type="text" id="searchInput" oninput="filterMenu()" placeholder="Cari menu..." class="flex-1 px-3 py-1.5 bg-slate-100 border-none rounded-lg text-xs outline-none focus:ring-2 focus:ring-blue-500">
            <select id="categoryFilter" onchange="filterMenu()" class="bg-slate-100 border-none rounded-lg px-2 py-1.5 text-xs font-semibold outline-none w-28">
                <option value="ALL">Semua</option>
            </select>
        </div>
        <div id="menuList" class="menu-grid p-2 overflow-y-auto custom-scroll flex-1"></div>
    </section>

    <section class="cart-panel w-[310px] flex flex-col bg-white border-l border-slate-200 shrink-0">
        <div class="p-2 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <h2 class="font-bold text-slate-700 text-[10px] uppercase tracking-widest flex items-center gap-1"><span>üõí</span> KERANJANG</h2>
            <button onclick="location.reload()" class="text-[9px] text-red-500 font-bold hover:underline">RESET</button>
        </div>
        <div id="cartList" class="flex-1 overflow-y-auto custom-scroll p-2 space-y-1.5">
            <div class="flex flex-col items-center justify-center h-full text-slate-300"><p class="text-[10px]">Kosong</p></div>
        </div>

        <div class="p-2 bg-white border-t border-slate-200">
    <div class="mb-1">
        <button onclick="toggleVoucher()" class="flex items-center gap-1 text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">
            <span>üè∑Ô∏è</span> KODE UNIK VOUCHER <span id="vouchArrow">‚ñº</span>
        </button>
        <div id="voucherSection">
            <div class="flex flex-col py-1 px-1">
                <label class="text-[9px] text-slate-500 font-bold mb-1 uppercase tracking-tighter">Masukkan Kode Unik:</label>
                <input id="voucher" type="text" placeholder="CONTOH: PROMO10K" class="w-full border-b-2 border-blue-400 bg-blue-50/50 px-2 py-1 outline-none font-bold text-blue-700 text-sm placeholder:text-slate-300 placeholder:font-normal uppercase">
            </div>
        </div>
    </div>

    <div id="pointDiscWrapper" class="hidden flex justify-between px-1 text-[10px] font-bold text-red-600 mb-1 animate-pulse">
        <span>PROMO POIN MEMBER</span>
        <span>- Rp <span id="pointDiscNominal">0</span></span>
    </div>

<div class="flex justify-between items-center mb-1 px-1 border-t border-slate-100 pt-1">
    <span class="font-bold text-slate-700 text-[11px]">TOTAL TAGIHAN</span>
    <span class="text-xl font-black text-blue-700 leading-none">Rp <span id="total">0</span></span>
</div>
<div class="flex justify-between items-center mb-1 px-1">
    <span class="font-bold text-slate-700 text-[11px]">TOTAL</span>
    <span class="text-lg font-black text-blue-700 leading-none">Rp <span id="total">0</span></span>
</div>

    <div class="space-y-1.5">
        <select id="metode" onchange="renderCash()" class="w-full border border-slate-200 rounded-md p-1.5 text-[11px] font-bold bg-white outline-none">
            <option value="CASH">üíµ TUNAI</option>
            <option value="QRIS">üì± QRIS</option>
            <option value="CARD">üí≥ KARTU</option>
        </select>
        <div id="cashBox" class="empty:hidden"></div>
        <button id="btnSubmitOrder" onclick="submitOrder()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-bold text-[12px] shadow-sm transition active:scale-95 uppercase">Bayar & Cetak</button>
    </div>
        </div>
    </section>
</main>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxqeTBO66KcBbjSH6rAL-iQKqnfJO8Q7qYMXddlK_eqprDV5ehZ2aSWdPDX7fVgSpkHOg/exec";
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZGCGtu4xfKCj0zCGB2BldzF2fLjFCIOfVSXBAMeTM-3KGHfC9mZ_bhfaTnikwxd5427w4ULtotTJH/pub?gid=2132421401&single=true&output=csv";
const TOKEN = "dyg-access-v2";

// Global variabel untuk menyimpan tanggal buka shift
let shiftOpenedDate = null;

async function checkShiftAlert() {
    const alertBox = document.getElementById("shiftAlert");
    const alertText = document.getElementById("alertText");
    const status = document.getElementById("btnCloseShift").classList.contains("hidden") ? "CLOSED" : "OPEN";

    // Jika shift sedang tutup, sembunyikan alert
    if (status === "CLOSED") {
        alertBox.classList.add("hidden");
        return;
    }

    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();

    // 1. Ambil info kapan shift dibuka (kita asumsikan dari ID shift atau data server)
    // Untuk akurasi, kita bandingkan tanggal sekarang dengan tanggal buka shift
    // (Misal: shiftOpenedDate diset saat checkShiftStatus)
    
    if (shiftOpenedDate) {
        const diffTime = Math.abs(now - shiftOpenedDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        // LOGIKA 1: Melebihi 2 Hari
        if (diffDays > 2) {
            alertBox.classList.remove("hidden");
            alertText.innerText = "CLOSINGMU SUDAH MELAMPAUI BATAS KESALAHAN";
            return;
        }
    }

    // LOGIKA 2: Jam 03:30 (Pagi)
    // Sesuai jam operasional Anda yang sampai jam 5 pagi
    if (currentHour === 3 && currentMinute >= 30 || currentHour > 3 && currentHour < 6) {
        alertBox.classList.remove("hidden");
        alertText.innerText = "JANGAN LUPA TUTUP SHIFT, SAAT AKAN CLOSING";
    } else {
        alertBox.classList.add("hidden");
    }
}

// Update fungsi checkShiftStatus yang sudah ada agar menyimpan tanggal buka
async function checkShiftStatus() {
    try {
        const res = await fetch(`${API_URL}?token=${TOKEN}&action=getShiftStatus`);
        const status = await res.text();
        
        // Asumsi: Kita butuh tanggal buka shift. 
        // Anda bisa memodifikasi backend untuk mengirimkan "OPEN|2026-02-06"
        if (status.includes("OPEN")) {
            // Kita simpan tanggal hari ini sebagai patokan awal jika server tidak kirim tanggal
            if(!shiftOpenedDate) shiftOpenedDate = new Date(); 
            
            document.getElementById("btnOpenShift").classList.add("hidden");
            document.getElementById("btnCloseShift").classList.remove("hidden");
        } else {
            shiftOpenedDate = null;
            document.getElementById("btnOpenShift").classList.remove("hidden");
            document.getElementById("btnCloseShift").classList.add("hidden");
        }
        checkShiftAlert(); // Jalankan cek alert
    } catch (e) { console.error(e); }
}

// Jalankan pengecekan setiap 1 menit
setInterval(checkShiftAlert, 60000);

let MENU = [], cart = {}, member = null, redeemQty = 0, pointDiscount = 0;

function toggleVoucher() {
    const v = document.getElementById('voucherSection');
    const a = document.getElementById('vouchArrow');
    v.classList.toggle('open');
    a.innerText = v.classList.contains('open') ? '‚ñ≤' : '‚ñº';
}

async function loadMenu() {
    try {
        const response = await fetch(CSV_URL);
        const data = await response.text();
        const rows = data.split("\n").slice(1);
        MENU = rows.map(row => {
            const cols = row.split(",");
            return { kategori: cols[0]?.trim() || "Lainnya", nama: cols[1]?.trim(), harga: parseInt(cols[2]?.trim()) || 0 };
        }).filter(m => m.nama);
        populateCategories();
        renderMenu();
    } catch (e) { console.error(e); }
}

function populateCategories() {
    const cats = [...new Set(MENU.map(m => m.kategori))];
    const select = document.getElementById("categoryFilter");
    cats.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c; opt.innerText = c;
        select.appendChild(opt);
    });
}

function renderMenu() {
    const list = document.getElementById("menuList");
    const search = document.getElementById("searchInput").value.toLowerCase();
    const filter = document.getElementById("categoryFilter").value;
    list.innerHTML = "";
    MENU.forEach((m, i) => {
        if ((filter === "ALL" || m.kategori === filter) && (m.nama.toLowerCase().includes(search))) {
            const el = document.createElement("div");
            el.className = "menu-card bg-white p-2 rounded-lg shadow-sm flex flex-col justify-between cursor-pointer relative";
            el.onclick = () => addItem(i);
            el.innerHTML = `<div><div class="text-[7px] font-bold text-blue-500 uppercase">${m.kategori}</div><div class="font-bold text-slate-800 text-[10px] leading-tight line-clamp-2">${m.nama}</div></div>
                <div class="flex justify-between items-center mt-1.5"><div class="text-[10px] font-black text-slate-900">Rp${m.harga.toLocaleString()}</div><div class="bg-blue-50 text-blue-600 rounded p-0.5"><svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/></svg></div></div>
                <span id="badge-${i}" class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-[8px] w-4 h-4 flex items-center justify-center rounded-full font-bold border-white border"></span>`;
            list.appendChild(el);
        }
    });
    updateBadges();
}

function filterMenu() { renderMenu(); }
function addItem(i) { if (!cart[i]) cart[i] = { qty: 0, ...MENU[i] }; cart[i].qty++; renderCart(); }
function removeItem(i) { cart[i].qty--; if (cart[i].qty <= 0) delete cart[i]; renderCart(); }
function updateBadges() {
    MENU.forEach((_, i) => {
        const b = document.getElementById("badge-" + i);
        if (b) { if (cart[i]) { b.innerText = cart[i].qty; b.classList.remove("hidden"); } else { b.classList.add("hidden"); } }
    });
}

function renderCart() {
    let h = ""; let t = 0;
    Object.keys(cart).forEach(i => {
        const item = cart[i]; t += item.qty * item.harga;
        h += `<div class="flex justify-between items-center bg-slate-50 p-1.5 rounded-md border border-slate-100"><div class="flex-1 min-w-0 pr-1"><div class="font-bold text-slate-800 text-[10px] truncate">${item.nama}</div></div><div class="flex items-center gap-1.5"><button onclick="removeItem(${i})" class="w-5 h-5 rounded bg-white border flex items-center justify-center text-[10px]">Ôºç</button><span class="font-bold text-[10px] w-3 text-center">${item.qty}</span><button onclick="addItem(${i})" class="w-5 h-5 rounded bg-white border flex items-center justify-center text-[10px]">Ôºã</button></div></div>`;
    });
    
    const final = Math.max(0, t - pointDiscount);
    document.getElementById("total").innerText = final.toLocaleString();
    
    const pWrapper = document.getElementById("pointDiscWrapper");
    if (pointDiscount > 0) {
        pWrapper.classList.remove("hidden");
        document.getElementById("pointDiscNominal").innerText = pointDiscount.toLocaleString();
    } else {
        pWrapper.classList.add("hidden");
    }

    document.getElementById("cartList").innerHTML = h || `<div class="flex flex-col items-center justify-center h-full text-slate-300"><p class="text-[9px]">Kosong</p></div>`;
    updateBadges();
    if(document.getElementById("metode").value === "CASH") renderCash();
}

function renderCash() {
    const m = document.getElementById("metode").value;
    const b = document.getElementById("cashBox");
    if (m !== "CASH") { b.innerHTML = ""; return; }
    const currentTotal = Number(document.getElementById("total").innerText.replace(/[^0-9]/g, '') || 0);
    const denoms = [1000, 2000, 5000, 10000, 20000, 50000, 100000];
    let btns = `<button onclick="quickCash(${currentTotal})" class="flex-1 bg-blue-600 text-white border py-0.5 rounded text-[8px] font-bold">Uang Pas</button>`;
    denoms.forEach(v => { 
        if (v > currentTotal) btns += `<button onclick="quickCash(${v})" class="flex-1 bg-white border py-0.5 rounded text-[8px] font-bold hover:bg-blue-600 hover:text-white">${v/1000}K</button>`; 
    });
    b.innerHTML = `<div class="bg-blue-50 p-1.5 rounded-md border border-blue-100 space-y-1">
        <div class="flex justify-between items-center px-1">
            <label class="text-[8px] font-bold text-blue-700">TUNAI</label>
            <input id="bayar" type="number" oninput="hitungKembali()" placeholder="0" class="w-24 bg-white border border-blue-300 rounded px-1 text-right text-[11px] font-black outline-none focus:ring-1 focus:ring-blue-500">
        </div>
        <div class="flex flex-wrap gap-1">${btns}</div>
        <div id="kembaliWrapper" class="flex justify-between items-center text-[9px] font-bold px-1 text-blue-700">
            <span>KEMBALI</span>
            <span>Rp <span id="kembali">0</span></span>
        </div>
    </div>`;
}

function quickCash(v) { 
    const input = document.getElementById("bayar");
    if(input) { 
        input.value = v; 
        hitungKembali(); 
    }
}

function hitungKembali() {
    const inputBayar = document.getElementById("bayar");
    const displayKembali = document.getElementById("kembali");
    const wrapper = document.getElementById("kembaliWrapper");
    if (!inputBayar || !displayKembali) return;
    const t = Number(document.getElementById("total").innerText.replace(/[^0-9]/g, '') || 0);
    const b = Number(inputBayar.value || 0);
    const s = b - t;
    if (s < 0) { 
        displayKembali.innerText = "Kurang " + Math.abs(s).toLocaleString(); 
        wrapper.classList.remove("text-blue-700");
        wrapper.classList.add("text-red-600");
    } else { 
        displayKembali.innerText = s.toLocaleString(); 
        wrapper.classList.remove("text-red-600");
        wrapper.classList.add("text-blue-700");
    }
}

// Simpan variabel ini di luar fungsi agar bisa diakses oleh prosesSimpanKeCloud
let pendingOrder = null;

async function submitOrder() {
    // 1. Ambil total tagihan
    const total = Number(document.getElementById("total").innerText.replace(/[^0-9]/g, '') || 0);
    
    // 2. Validasi keranjang
    if (total <= 0 && Object.keys(cart).length === 0) {
        return alert("Keranjang masih kosong!");
    }

    const btn = document.querySelector("button[onclick='submitOrder()']");
    btn.innerText = "MENCETAK..."; 
    btn.disabled = true;

    // 3. Siapkan Data Transaksi (Simpan sementara di variabel pendingOrder)
    const now = new Date();
    const trxId = "TRX-" + now.getHours() + now.getMinutes() + now.getSeconds() + "-" + Math.floor(Math.random() * 100);
    const noWA = document.getElementById("nohp").value || "-";
    const pesanan = Object.values(cart).map(i => `${i.nama} x${i.qty}`).join(", ");
    const kodeVoucher = document.getElementById("voucher").value;
    const metode = document.getElementById("metode").value;

    pendingOrder = { 
        total, 
        noWA, 
        pesanan, 
        kodeVoucher, 
        metode, 
        trxId 
    };

    // 4. Susun Format Struk untuk Printer
    let esc = "\x1B\x40\x1B\x61\x01\x1B\x21\x10CLOUDkitchendyg++\x1B\x21\x00\n";
    esc += "ID: " + trxId + "\n";
    esc += "Tgl: " + now.toLocaleString('id-ID') + "\n";
    esc += "--------------------------------\n\x1B\x61\x00";
    
    Object.values(cart).forEach(item => { 
        esc += `${item.nama}\n${item.qty} x ${item.harga.toLocaleString()} = ${(item.qty * item.harga).toLocaleString()}\n`; 
    });
    
    esc += "--------------------------------\n";
    esc += "TOTAL    : Rp " + total.toLocaleString() + "\n";
    esc += "METODE   : " + metode + "\n";

    // LOGIKA MEMBER & POIN TETAP TAMPIL
    // Jika bukan member, namaMember akan tetap "-" dan poinDapat akan "0"
    const namaMemberStruk = (member && member.nama) ? member.nama : "-";
    const poinDidapatStruk = (namaMemberStruk !== "-") ? Math.floor(total / 20000) * 100 : 0;

    esc += "MEMBER   : " + namaMemberStruk + "\n";
    esc += "DAPAT POIN: " + poinDidapatStruk + "\n";

    if (redeemQty > 0) esc += "REDEEM   : " + redeemQty + " Poin\n";
    if (kodeVoucher)   esc += "VOUCHER  : " + kodeVoucher + "\n";
    
    esc += "--------------------------------\n";
    esc += "\x1B\x61\x01TERIMA KASIH\x1B\x61\x00\n";
    esc += "\x1B\x61\x01powered by cloudkitchendyg++\x1B\x61\x00\n\n\n\n\n";

    // 5. KIRIM PERINTAH KE APP INVENTOR
    // Menambahkan prefix "PRINT|" agar dideteksi oleh blok IF di App Inventor
    if (window.AppInventor) {
        window.AppInventor.setWebViewString("PRINT|" + esc);
    } else {
        // Jika buka di browser biasa (untuk testing)
        console.log("Simulasi Cetak:\n" + esc);
        // Di browser kita panggil manual suksesnya karena tidak ada bluetooth
        setTimeout(() => { onPrintSuccess_Mock(); }, 1000); 
    }
}

// Fungsi simulasi jika tidak pakai App Inventor (hanya untuk tes di laptop)
function onPrintSuccess_Mock() {
    if(confirm("Simulasi: Apakah cetak berhasil?")) {
        prosesSimpanKeCloud();
    } else {
        const btn = document.querySelector("button[onclick='submitOrder()']");
        btn.innerText = "Bayar & Cetak";
        btn.disabled = false;
    }
}
function cekMember() {
    const no = document.getElementById("nohp").value.trim(); if (!no) return;
    document.getElementById("memberInfo").innerText = "Mengecek...";
    fetch(`${API_URL}?token=${TOKEN}&action=cekMember&noHP=${no}`)
        .then(r => r.json()).then(d => {
            if (d.exists) { 
                member = d; 
                document.getElementById("memberInfo").innerHTML = `<span class="text-blue-600 font-bold">‚úÖ ${d.nama} (${d.poin || 0} Poin)</span>`;
                
                if (d.poin >= 500) {
                    let maxTukarPoin = Math.floor(d.poin / 500) * 500;
                    let nominalPotongan = (maxTukarPoin / 500) * 5000;

                    if (confirm(`Member memiliki ${d.poin} poin.\nTukarkan ${maxTukarPoin} poin untuk diskon Rp${nominalPotongan.toLocaleString()}?`)) {
                        redeemQty = maxTukarPoin; 
                        pointDiscount = nominalPotongan;
                        renderCart();
                        alert(`Berhasil! Poin ditukar diskon.`);
                    }
                }
            } else { 
                member = null; redeemQty = 0; pointDiscount = 0; renderCart();
                document.getElementById("memberInfo").innerHTML = `<span class="text-red-500 font-bold">‚ùå Bukan Member</span>`; 
            }
        });
}
// Pantau laporan dari App Inventor setiap 1 detik
setInterval(function() {
    if (window.AppInventor) {
        let laporan = window.AppInventor.getWebViewString();
        
        if (laporan === "SUCCESS") {
            window.AppInventor.setWebViewString(""); // Reset agar tidak kirim data berulang
            prosesSimpanKeCloud(); // Panggil fungsi kirim data ke Google Sheets
        } 
        else if (laporan === "FAILED") {
            window.AppInventor.setWebViewString(""); // Reset
            alert("‚ö†Ô∏è GAGAL CETAK: Bluetooth printer tidak terhubung!");
            
            // Aktifkan kembali tombol agar kasir bisa coba lagi
            const btn = document.querySelector("button[onclick='submitOrder()']");
            if(btn) { btn.innerText = "Bayar & Cetak"; btn.disabled = false; }
        }
    }
}, 1000);

// Fungsi utama untuk kirim data ke Google Sheets
async function prosesSimpanKeCloud() {
    if (!pendingOrder) return;
    const p = pendingOrder;
    
    const btn = document.querySelector("button[onclick='submitOrder()']");
    if(btn) btn.innerText = "MENYIMPAN DATA...";

    try {
        // Encode URI agar karakter aneh pada pesanan tidak memutus link
        const url = `${API_URL}?token=${TOKEN}&action=processPayment&total=${p.total}&noWA=${p.noWA}&method=${p.metode}&pesanan=${encodeURIComponent(p.pesanan)}&trxId=${p.trxId}&voucher=${encodeURIComponent(p.kodeVoucher)}&redeemQty=${redeemQty}`;
        
        const res = await fetch(url);
        const serverResponse = await res.text();
        
        // SINKRONISASI: Kita paksa jadi huruf besar semua agar tidak bentrok (Success vs SUCCESS)
        if (serverResponse.toUpperCase().includes("SUCCESS")) {
            alert("‚úÖ Transaksi Berhasil & Data Tersimpan!");
            location.reload(); 
        } else {
            // Jika server merespon tapi bukan "Success" (misal: "Action Not Found")
            alert("‚ö†Ô∏è Respon Server: " + serverResponse);
            if(btn) { btn.innerText = "Bayar & Cetak"; btn.disabled = false; }
        }
    } catch (e) {
        // INI BAGIAN JIKA JARINGAN TIDAK AMAN / MATI
        alert("‚ùå KONEKSI INTERNET PUTUS!\nData gagal masuk ke Cloud. Mohon cek sinyal/wifi Anda.");
        if(btn) { btn.innerText = "COBA SIMPAN LAGI"; btn.disabled = false; }
    }
}
// Fungsi untuk mengecek status shift saat aplikasi dibuka
async function checkShiftStatus() {
    try {
        const res = await fetch(`${API_URL}?token=${TOKEN}&action=getShiftStatus`);
        const status = await res.text();
        
        const btnOpen = document.getElementById("btnOpenShift");
        const btnClose = document.getElementById("btnCloseShift");
        const btnSubmit = document.getElementById("btnSubmitOrder");

        if (status === "OPEN") {
            btnOpen.classList.add("hidden");
            btnClose.classList.remove("hidden");
            btnSubmit.disabled = false;
            btnSubmit.innerText = "Bayar & Cetak";
            btnSubmit.classList.remove("opacity-50", "grayscale");
        } else {
            btnOpen.classList.remove("hidden");
            btnClose.classList.add("hidden");
            // Kunci tombol transaksi jika belum buka shift
            btnSubmit.disabled = true;
            btnSubmit.innerText = "BUKA SHIFT DULU";
            btnSubmit.classList.add("opacity-50", "grayscale");
        }
    } catch (e) { console.error("Gagal cek shift", e); }
}

async function manageShift(type) {
    if (type === 'open') {
        if (!confirm("Buka shift sekarang?")) return;
        const res = await fetch(`${API_URL}?token=${TOKEN}&action=openShift`);
        const result = await res.text();
        if (result) { alert("Shift Dimulai!"); location.reload(); }
    } else {
        if (!confirm("Tutup shift dan CETAK LAPORAN?")) return;

        // 1. Ambil data laporan dari Server
        const res = await fetch(`${API_URL}?token=${TOKEN}&action=getShiftReport`);
        const r = await res.json();

        if (r === "NO_ACTIVE_SHIFT") return alert("Tidak ada shift aktif");

        // 2. Susun format teks untuk Printer
        let esc = "\x1B\x40\x1B\x61\x01\x1B\x21\x10LAPORAN TUTUP SHIFT\x1B\x21\x00\n";
        esc += r.shiftName + "\n";
        esc += "--------------------------------\n\x1B\x61\x00";
        esc += "Total Trx       : " + r.totalTrx + "\n";
        esc += "Total Pemasukan : Rp " + r.totalPemasukan.toLocaleString() + "\n";
        esc += "  - CASH        : Rp " + r.cash.toLocaleString() + "\n";
        esc += "  - QRIS        : Rp " + r.qris.toLocaleString() + "\n";
        esc += "  - CARD        : Rp " + r.card.toLocaleString() + "\n";
        esc += "--------------------------------\n";
        esc += "DAFTAR MEMBER HARI INI:\n";
        
        const memberKeys = Object.keys(r.members);
        if (memberKeys.length > 0) {
            memberKeys.forEach(m => {
                esc += "- " + m + " (+" + r.members[m] + " Poin)\n";
            });
        } else {
            esc += "(Tidak ada transaksi member)\n";
        }
        
        esc += "--------------------------------\n";
        esc += "\n\n\n\n";

        // 3. Kirim ke Printer via App Inventor
        if (window.AppInventor) {
            window.AppInventor.setWebViewString("PRINT|" + esc);
            
            // Beri jeda 2 detik agar printer sempat memproses sebelum shift ditutup & reload
            setTimeout(async () => {
                await fetch(`${API_URL}?token=${TOKEN}&action=closeShift`);
                alert("Laporan Dicetak & Shift Ditutup!");
                location.reload();
            }, 2000);
        } else {
            console.log("Mock Report:\n" + esc);
            await fetch(`${API_URL}?token=${TOKEN}&action=closeShift`);
            location.reload();
        }
    }
}
// Tambahkan checkShiftStatus() ke dalam window.onload Anda yang sudah ada
window.onload = () => {
    loadMenu();
    checkShiftStatus();
};
</script>
</body>
</html>