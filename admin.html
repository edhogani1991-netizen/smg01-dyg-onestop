<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLOUDkitchen.dyg++ POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .menu-card { transition: all 0.2s ease; }
        .menu-card:active { transform: scale(0.95); }
    </style>
</head>

<body class="bg-slate-100 h-screen flex flex-col">

    <header class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold text-blue-700 tracking-tight">dyg++ <span class="text-slate-400 font-medium">RETAIL</span></h1>
            <div class="h-6 w-px bg-slate-200"></div>
            <div id="memberInfo" class="text-sm font-medium text-slate-500 italic">Silahkan cek member...</div>
        </div>
        <div class="flex items-center gap-3">
            <input id="nohp" type="text" placeholder="Nomor WA Member" class="bg-slate-100 border-none rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none w-48">
            <button onclick="cekMember()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">Cek Member</button>
        </div>
    </header>

    <main class="flex flex-1 overflow-hidden">
        
        <section class="w-[65%] flex flex-col border-r border-slate-200 bg-slate-50">
            <div class="p-4 flex gap-3 bg-white border-b border-slate-200">
                <div class="relative flex-1">
                    <span class="absolute left-3 top-2.5 text-slate-400">üîç</span>
                    <input type="text" id="searchInput" oninput="filterMenu()" placeholder="Cari menu favorit..." class="w-full pl-10 pr-4 py-2 bg-slate-100 border-none rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <select id="categoryFilter" onchange="filterMenu()" class="bg-slate-100 border-none rounded-xl px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none min-w-[150px]">
                    <option value="ALL">Semua Kategori</option>
                </select>
            </div>

            <div id="menuList" class="p-4 grid grid-cols-2 gap-4 overflow-y-auto custom-scroll content-start">
                </div>
        </section>

        <section class="w-[35%] flex flex-col bg-white">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                <h2 class="font-bold text-slate-800 uppercase text-xs tracking-widest">Keranjang Belanja</h2>
                <button onclick="location.reload()" class="text-xs text-red-500 font-medium">Reset</button>
            </div>

            <div id="cartList" class="flex-1 overflow-y-auto custom-scroll p-4 space-y-3">
                <div class="flex flex-col items-center justify-center h-full text-slate-300">
                    <span class="text-4xl mb-2">üõí</span>
                    <p class="text-sm">Belum ada pesanan</p>
                </div>
            </div>

            <div class="p-4 bg-slate-50 border-t border-slate-200 space-y-4">
                <div class="space-y-2">
                    <div class="flex justify-between text-sm">
                        <span class="text-slate-500">Voucher</span>
                        <input id="voucher" type="number" oninput="renderCart()" placeholder="0" class="w-24 text-right border-b border-slate-300 bg-transparent focus:border-blue-500 outline-none font-bold text-red-600">
                    </div>
                    <div class="flex justify-between items-center pt-2">
                        <span class="font-bold text-slate-700 text-lg">Total</span>
                        <span class="text-2xl font-black text-blue-700">Rp <span id="total">0</span></span>
                    </div>
                </div>

                <div class="space-y-3">
                    <select id="metode" onchange="renderCash()" class="w-full border border-slate-200 rounded-xl p-3 text-sm font-semibold bg-white shadow-sm">
                        <option value="CASH">üíµ TUNAI (CASH)</option>
                        <option value="QRIS">üì± QRIS</option>
                        <option value="CARD">üí≥ KARTU DEBIT</option>
                    </select>

                    <div id="cashBox" class="space-y-3"></div>

                    <button onclick="submitOrder()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-blue-200 transition-all active:scale-[0.98]">
                        BAYAR & CETAK STRUK
                    </button>
                </div>
            </div>
        </section>
    </main>

<script>
/* ================= CONFIG & DATA ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyvU5fQpE_UFq_mnfAMvhCNJ97f1SvVRpXv_qrZh96lj8IBPot8xRdQ34Iz1n-HVmiuzg/exec";
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZGCGtu4xfKCj0zCGB2BldzF2fLjFCIOfVSXBAMeTM-3KGHfC9mZ_bhfaTnikwxd5427w4ULtotTJH/pub?gid=2132421401&single=true&output=csv";
const TOKEN = "dyg-access-v2";

let MENU = [];
let cart = {};
let member = null;

/* ================= LOAD DATA ================= */
async function loadMenu() {
    try {
        const response = await fetch(CSV_URL);
        const data = await response.text();
        const rows = data.split("\n").slice(1);
        
        MENU = rows.map(row => {
            const cols = row.split(",");
            return {
                kategori: cols[0]?.trim() || "Lainnya",
                nama: cols[1]?.trim(),
                harga: parseInt(cols[2]?.trim()) || 0
            };
        }).filter(m => m.nama);

        populateCategories();
        renderMenu();
    } catch (e) {
        console.error("Gagal load data menu", e);
    }
}

function populateCategories() {
    const cats = [...new Set(MENU.map(m => m.kategori))];
    const select = document.getElementById("categoryFilter");
    cats.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c; opt.innerText = c;
        select.appendChild(opt);
    });
}

/* ================= RENDERER ================= */
function renderMenu() {
    const list = document.getElementById("menuList");
    const search = document.getElementById("searchInput").value.toLowerCase();
    const filter = document.getElementById("categoryFilter").value;

    list.innerHTML = "";
    MENU.forEach((m, i) => {
        if ((filter === "ALL" || m.kategori === filter) && (m.nama.toLowerCase().includes(search))) {
            const el = document.createElement("div");
            el.className = "menu-card bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between hover:border-blue-300 cursor-pointer relative overflow-hidden";
            el.onclick = () => addItem(i);
            el.innerHTML = `
                <div>
                    <div class="text-[10px] font-bold text-blue-500 uppercase tracking-tight">${m.kategori}</div>
                    <div class="font-bold text-slate-800 mt-1 leading-tight">${m.nama}</div>
                </div>
                <div class="flex justify-between items-end mt-4">
                    <div class="text-sm font-black text-slate-900">Rp ${m.harga.toLocaleString()}</div>
                    <div class="bg-slate-100 text-blue-600 rounded-lg p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <span id="badge-${i}" class="hidden absolute top-0 right-0 bg-blue-600 text-white text-[10px] px-2 py-1 rounded-bl-xl font-bold italic"></span>
            `;
            list.appendChild(el);
        }
    });
    updateBadges();
}

function filterMenu() { renderMenu(); }

/* ================= CORE FUNCTIONS (UNCHANGED LOGIC) ================= */
function addItem(i) {
    if (!cart[i]) cart[i] = { qty: 0, ...MENU[i] };
    cart[i].qty++;
    renderCart();
}

function removeItem(i) {
    cart[i].qty--;
    if (cart[i].qty <= 0) delete cart[i];
    renderCart();
}

function updateBadges() {
    MENU.forEach((_, i) => {
        const badge = document.getElementById("badge-" + i);
        if (badge) {
            if (cart[i]) {
                badge.innerText = cart[i].qty + "x";
                badge.classList.remove("hidden");
            } else {
                badge.classList.add("hidden");
            }
        }
    });
}

function renderCart() {
    let html = "";
    let total = 0;

    Object.keys(cart).forEach(i => {
        const item = cart[i];
        total += item.qty * item.harga;
        html += `
            <div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                <div class="flex-1">
                    <div class="font-bold text-slate-800 text-sm">${item.nama}</div>
                    <div class="text-xs text-slate-500">Rp ${item.harga.toLocaleString()}</div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="removeItem(${i})" class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center shadow-sm text-slate-600">Ôºç</button>
                    <span class="font-bold text-sm w-4 text-center">${item.qty}</span>
                    <button onclick="addItem(${i})" class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center shadow-sm text-slate-600">Ôºã</button>
                </div>
            </div>
        `;
    });

    const voucher = Number(document.getElementById("voucher").value || 0);
    document.getElementById("cartList").innerHTML = html || `<div class="flex flex-col items-center justify-center h-full text-slate-300"><span class="text-4xl mb-2">üõí</span><p class="text-sm">Belum ada pesanan</p></div>`;
    document.getElementById("total").innerText = (total - voucher).toLocaleString();
    updateBadges();
}

function cekMember() {
    const nohp = document.getElementById("nohp").value.trim();
    if (!nohp) return;
    document.getElementById("memberInfo").innerText = "Mengecek...";
    fetch(`${API_URL}?token=${TOKEN}&action=cekMember&noHP=${nohp}`)
        .then(r => r.json())
        .then(d => {
            if (d.exists) {
                member = d;
                document.getElementById("memberInfo").innerHTML = `<span class="text-blue-600">‚úÖ ${d.nama}</span> | Poin: <span class="font-bold">${d.poin}</span>`;
            } else {
                member = null;
                document.getElementById("memberInfo").innerHTML = `<span class="text-red-500">‚ùå Bukan Member</span>`;
            }
        });
}

function renderCash() {
    const metode = document.getElementById("metode").value;
    const box = document.getElementById("cashBox");
    if (metode !== "CASH") { box.innerHTML = ""; return; }

    box.innerHTML = `
        <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
            <label class="text-[10px] font-bold uppercase text-blue-500 block mb-1">Uang Diterima</label>
            <input id="bayar" type="number" placeholder="0" class="w-full bg-transparent border-none text-xl font-black text-blue-900 outline-none p-0">
            <div class="flex gap-2 mt-3">
                ${[20000, 50000, 100000].map(v => `<button onclick="quickCash(${v})" class="flex-1 bg-white border border-blue-200 py-2 rounded-xl text-[10px] font-bold hover:bg-blue-600 hover:text-white transition shadow-sm">${v/1000}K</button>`).join("")}
            </div>
            <div class="mt-3 pt-3 border-t border-blue-100 flex justify-between items-center font-bold text-sm text-blue-800">
                <span>Kembali</span>
                <span>Rp <span id="kembali">0</span></span>
            </div>
        </div>
    `;
}

function quickCash(v) { document.getElementById("bayar").value = v; hitungKembali(); }
document.addEventListener("input", e => { if (e.target.id === "bayar") hitungKembali(); });

function hitungKembali() {
    const bayar = Number(document.getElementById("bayar")?.value || 0);
    const rawTotal = document.getElementById("total").innerText.replace(/,/g, '');
    const total = Number(rawTotal || 0);
    document.getElementById("kembali").innerText = (bayar - total).toLocaleString();
}

async function submitOrder() {
    const rawTotal = document.getElementById("total").innerText.replace(/,/g, '');
    const total = Number(rawTotal || 0);
    if (total <= 0 && Object.keys(cart).length === 0) { alert("Keranjang kosong"); return; }

    const voucher = Number(document.getElementById("voucher").value || 0);
    const finalTotal = Math.max(0, total);
    const metode = document.getElementById("metode").value;
    const noWA = document.getElementById("nohp").value || "";

    const pesanan = Object.values(cart).map(i => `${i.nama} x${i.qty}`).join(", ");
    const url = `${API_URL}?token=${TOKEN}&action=processPayment&total=${finalTotal}&noWA=${noWA}&redeemQty=0&voucher=${voucher}&method=${metode}&pesanan=${encodeURIComponent(pesanan)}`;

    const res = await fetch(url);
    const txt = await res.text();

    if (txt === "SUCCESS") {
        let esc = "\x1B\x40\x1B\x61\x01\x1B\x21\x10dyg++ RETAIL\x1B\x21\x00\n";
        esc += "Tgl: " + new Date().toLocaleString() + "\n--------------------------------\n\x1B\x61\x00";
        Object.values(cart).forEach(i => {
            esc += `${i.nama}\n${i.qty} x ${i.harga.toLocaleString()} = ${(i.qty*i.harga).toLocaleString()}\n`;
        });
        esc += "--------------------------------\nTOTAL: Rp " + finalTotal.toLocaleString() + "\n";
        if (noWA) esc += "Member: " + noWA + "\n";
        esc += "\nTERIMA KASIH\n\n\n\n";

        if (window.AppInventor) window.AppInventor.setWebViewString("PRINT|" + esc);
        alert("Transaksi Berhasil");
        location.reload();
    } else {
        alert("Gagal menyimpan");
    }
}

// Start
loadMenu();
renderCash();
</script>
</body>
</html>