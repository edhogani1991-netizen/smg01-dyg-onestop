<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>dyg++ SECURE POS</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

<style>
body{font-family:'Plus Jakarta Sans',sans-serif;background:#0f172a;display:flex;justify-content:center;height:100dvh;overflow:hidden}
.pos-container{width:100%;max-width:1100px;background:#F1F5F9;display:flex;flex-direction:column}
.main-content{display:flex;flex:1;overflow:hidden}
.menu-side{flex:1;display:flex;flex-direction:column;background:#F8FAFC;border-right:1px solid #e2e8f0}
.admin-side{width:360px;display:flex;flex-direction:column;background:white;border-left:2px solid #cbd5e1;height:100%}
.scroll-area{flex:1;overflow-y:auto;padding:12px}
.sticky-bottom{shrink:0;background:#f8fafc;border-top:4px solid #fff}
.collapse-content{display:none}
.swipe-handle{cursor:pointer;background:#1e293b;color:#fbbf24;text-align:center;font-size:9px;padding:10px;font-weight:800;border-radius:8px;margin-bottom:5px}
.monitor-table td{padding:4px 0;font-size:10px;font-weight:bold}
.scroll-custom::-webkit-scrollbar{width:4px}
.scroll-custom::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px}

/* Style khusus cetak agar tidak tampil di layar tapi rapi di kertas */
@media print {
    body * { visibility: hidden; }
    #print-section, #print-section * { visibility: visible; }
    #print-section { position: absolute; left: 0; top: 0; width: 58mm; }
}
</style>
</head>

<body>

<div class="pos-container shadow-2xl">
<div class="bg-[#1B4332] text-white p-3 flex justify-between items-center shrink-0">
<h1 class="text-lg font-black italic tracking-tighter text-emerald-400">dyg++ <span class="text-white opacity-50 ml-2">POS SECURE</span></h1>
<div class="text-right">
<p class="text-[8px] uppercase opacity-60">Fisik Laci (Sistem)</p>
<p id="v-cash" class="text-lg font-black text-emerald-400">Rp 0</p>
</div>
</div>

<div class="main-content">
<div class="menu-side overflow-y-auto scroll-custom">
<div class="p-2 border-b bg-white flex gap-2">
<select id="cat-select" onchange="filterCat(this.value)" class="flex-1 p-2 bg-slate-100 border rounded-lg text-[10px] font-black"></select>
<input type="text" id="menuSearch" oninput="renderMenu()" placeholder="Cari..." class="w-32 p-2 bg-slate-100 border rounded-lg text-[10px] font-bold">
</div>
<div id="menu-render" class="grid grid-cols-4 gap-2 p-3"></div>
</div>

<div class="admin-side">
<div class="scroll-area space-y-3">

<div onclick="toggleSwipe()" class="swipe-handle">ðŸ“‚ KLIK UNTUK MONITOR & FINANCE OPERASIONAL</div>

<div id="collapsible-section" class="collapse-content space-y-3">
<div class="bg-slate-900 text-white rounded-xl p-3 shadow-lg border-b-4 border-emerald-500">
<table class="w-full monitor-table">
<tr><td>Modal Awal</td><td id="m-modal" class="text-right text-blue-300">Rp 0</td></tr>
<tr><td>Cash Masuk</td><td id="m-cash" class="text-right text-emerald-400">Rp 0</td></tr>
<tr><td>Belanja/Out</td><td id="m-out" class="text-right text-red-400">- Rp 0</td></tr>
<tr><td>QRIS</td><td id="m-qris" class="text-right text-orange-400">Rp 0</td></tr>
<tr><td>Online Food</td><td id="m-online" class="text-right text-purple-400">Rp 0</td></tr>
</table>
</div>
</div>

<div class="bg-white rounded-xl p-2 border-2 border-slate-200 min-h-[150px]">
<p class="text-[9px] font-black text-slate-400 mb-2 uppercase italic border-b pb-1 text-center">Keranjang</p>
<div id="cart-list" class="space-y-1"></div>
</div>
</div>

<div class="sticky-bottom p-4">
<div class="flex justify-between text-slate-500">
<span class="font-bold text-[10px]">SUBTOTAL</span>
<span id="v-subtotal" class="font-bold text-[11px]">Rp 0</span>
</div>
<div class="flex justify-between text-orange-600">
<span class="font-bold text-[10px]">POTONGAN</span>
<span id="v-discount" class="font-bold text-[11px]">- Rp 0</span>
</div>
<div class="flex justify-between text-[#1B4332] mb-2">
<span class="font-black text-[12px]">TOTAL</span>
<span id="v-total" class="text-3xl font-black">Rp 0</span>
</div>
<button onclick="submitOrder()" id="btn-order" class="w-full bg-[#1B4332] text-white py-4 rounded-2xl font-black text-[14px] shadow-lg">BAYAR & CETAK</button>
</div>
</div>
</div>
</div>

<script>
const CONFIG={
API:"https://script.google.com/macros/s/AKfycbwgE4TNuajMZy34ZOQKcHbUniCm6wU-a4rjGESFZC_1r6wUBVm_EwUZKvqchK-Pk6jL/exec",
CSV:"https://docs.google.com/spreadsheets/d/e/2PACX-1vQZGCGtu4xfKCj0zCGB2BldzF2fLjFCIOfVSXBAMeTM-3KGHfC9mZ_bhfaTnikwxd5427w4ULtotTJH/pub?gid=2132421401&single=true&output=csv",
TOKEN:"dyg-access-v2"
};

let cart={},menuData=[],activeCat='ALL',discountMember=0;

function toggleSwipe(){
const s=document.getElementById("collapsible-section");
s.style.display=s.style.display==="block"?"none":"block";
}

function addToCart(n,p){cart[n]={price:p,qty:(cart[n]?.qty||0)+1};updateCartUI()}
function changeQty(n,d){cart[n].qty+=d;if(cart[n].qty<=0)delete cart[n];updateCartUI()}

function updateCartUI(){
let sub=0;const l=document.getElementById("cart-list");l.innerHTML="";
Object.keys(cart).forEach(n=>{
sub+=cart[n].price*cart[n].qty;
l.innerHTML+=`<div class="flex justify-between text-[9px]"><span>${n} x${cart[n].qty}</span><span>${(cart[n].price*cart[n].qty).toLocaleString()}</span></div>`;
});
document.getElementById("v-subtotal").innerText="Rp "+sub.toLocaleString();
document.getElementById("v-discount").innerText="- Rp "+discountMember.toLocaleString();
document.getElementById("v-total").innerText="Rp "+(sub-discountMember).toLocaleString();
}

// FUNGSI CETAK UTAMA (Mendukung Bluetooth via RawBT)
function fastPrint58mm(htmlContent){
    const printerWidth = "58mm";
    const fullHtml = `
        <!DOCTYPE html>
        <html>
        <head>
            <style>
                body { font-family: 'Courier New', monospace; width: ${printerWidth}; padding: 0; margin: 0; font-size: 12px; }
                .c { text-align: center; }
                .r { text-align: right; }
                .b { font-weight: bold; }
                hr { border-top: 1px dashed #000; margin: 5px 0; }
                table { width: 100%; border-collapse: collapse; }
            </style>
        </head>
        <body>${htmlContent}</body>
        </html>`;

    // Cek jika Mobile (Android/iOS)
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    if (isMobile) {
        // Kirim ke RawBT (Wajib install RawBT di Android)
        window.location.href = "rawbt:base64," + btoa(unescape(encodeURIComponent(fullHtml)));
    } else {
        // Mode Desktop
        const iframe = document.createElement("iframe");
        iframe.style.display = "none";
        document.body.appendChild(iframe);
        const doc = iframe.contentWindow.document;
        doc.open(); doc.write(fullHtml); doc.close();
        setTimeout(() => {
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
            document.body.removeChild(iframe);
        }, 500);
    }
}

async function submitOrder(){
    const subtotal = Object.values(cart).reduce((s,i)=>s+i.price*i.qty,0);
    const total = subtotal - discountMember;
    if(!total) return;

    const btn = document.getElementById("btn-order");
    btn.innerText = "PROCESSING...";
    btn.disabled = true;

    try {
        // Kirim ke Google Apps Script
        await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=processOrder&total=${total}`);

        // Buat Konten Struk
        let receiptHtml = `
            <div class="c b">dyg++ POS SECURE</div>
            <div class="c">${new Date().toLocaleString('id-ID')}</div>
            <hr>
            <table>
        `;

        Object.keys(cart).forEach(n => {
            receiptHtml += `
                <tr>
                    <td>${n} x${cart[n].qty}</td>
                    <td class="r">${(cart[n].price * cart[n].qty).toLocaleString()}</td>
                </tr>
            `;
        });

        receiptHtml += `
            </table>
            <hr>
            <table>
                <tr class="b"><td>TOTAL</td><td class="r">Rp ${total.toLocaleString()}</td></tr>
            </table>
            <hr>
            <div class="c">TERIMA KASIH</div>
            <br><br>
        `;

        // Panggil fungsi cetak
        fastPrint58mm(receiptHtml);

        // Reset & Reload
        alert("Transaksi Berhasil!");
        location.reload();

    } catch (e) {
        alert("Error Koneksi!");
        btn.innerText = "BAYAR & CETAK";
        btn.disabled = false;
    }
}

async function loadMenu(){
    try {
        const r=await fetch(CONFIG.CSV);
        const t=await r.text();
        menuData=t.split("\n").slice(1).map(r=>{
            const c=r.split(",");
            return {kat:c[0], nama:c[1], harga:parseInt(c[2])||0}
        }).filter(m=>m.nama);
        renderMenu();
    } catch(e) { console.error("Gagal muat menu"); }
}

function renderMenu(){
    const c=document.getElementById("menu-render");
    const search = document.getElementById("menuSearch").value.toLowerCase();
    c.innerHTML="";
    menuData.filter(m => m.nama.toLowerCase().includes(search)).forEach(m=>{
        c.innerHTML+=`
            <div onclick="addToCart('${m.nama}',${m.harga})" class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 active:scale-95 transition-transform cursor-pointer">
                <p class="text-[10px] font-black leading-tight h-8 overflow-hidden">${m.nama}</p>
                <p class="text-emerald-600 font-bold text-[9px] mt-1">Rp ${m.harga.toLocaleString()}</p>
            </div>`;
    });
}

window.onload=loadMenu;
</script>

</body>
</html>