<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>dyg++ POS Compact</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #f1f5f9; }
        
        /* Scrollbar Halus */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Ukuran Fit Layar */
        .main-container { height: calc(100vh - 56px); }
        .menu-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 8px; 
            align-content: start;
        }

        @media (max-width: 640px) {
            .menu-grid { grid-template-columns: repeat(2, 1fr); }
            .main-container { flex-direction: column; overflow-y: auto; height: calc(100vh - 60px); }
            .cart-panel { width: 100% !important; height: auto !important; border-l: none; border-t: 2px solid #e2e8f0; }
        }

        .menu-card {
            transition: transform 0.1s;
            border: 1px solid #e2e8f0;
        }
        .menu-card:active { transform: scale(0.96); }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="h-[56px] bg-white border-b border-slate-200 px-4 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-3">
            <h1 class="text-lg font-extrabold text-blue-700 tracking-tighter">dyg++ <span class="text-slate-400 font-medium">RETAIL</span></h1>
            <div id="memberInfo" class="hidden md:block text-[11px] text-slate-500 italic truncate max-w-[150px]">Cek member...</div>
        </div>
        <div class="flex items-center gap-2">
            <input id="nohp" type="text" placeholder="No WA" class="bg-slate-100 border-none rounded-lg px-3 py-1.5 text-xs focus:ring-2 focus:ring-blue-500 outline-none w-28 md:w-40">
            <button onclick="cekMember()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition">Cek</button>
        </div>
    </header>

    <main class="flex flex-1 overflow-hidden main-container">
        <section class="flex-1 flex flex-col bg-slate-50 overflow-hidden">
            <div class="p-2 md:p-3 flex gap-2 bg-white border-b border-slate-200 shadow-sm">
                <input type="text" id="searchInput" oninput="filterMenu()" placeholder="Cari menu..." class="flex-1 px-3 py-1.5 bg-slate-100 border-none rounded-lg text-xs outline-none focus:ring-2 focus:ring-blue-500">
                <select id="categoryFilter" onchange="filterMenu()" class="bg-slate-100 border-none rounded-lg px-2 py-1.5 text-xs font-semibold outline-none w-32">
                    <option value="ALL">Semua</option>
                </select>
            </div>

            <div id="menuList" class="menu-grid p-2 md:p-3 overflow-y-auto custom-scroll flex-1">
                </div>
        </section>

        <section class="cart-panel w-[320px] md:w-[360px] flex flex-col bg-white border-l border-slate-200 shrink-0">
            <div class="p-3 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h2 class="font-bold text-slate-700 text-[11px] uppercase tracking-widest flex items-center gap-2">
                    <span>üõí</span> KERANJANG
                </h2>
                <button onclick="location.reload()" class="text-[10px] text-red-500 font-bold hover:underline">RESET</button>
            </div>

            <div id="cartList" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-2">
                <div class="flex flex-col items-center justify-center h-full text-slate-300">
                    <p class="text-xs">Kosong</p>
                </div>
            </div>

            <div class="p-3 bg-slate-50 border-t border-slate-200 space-y-2">
                <div class="flex justify-between items-center text-xs">
                    <span class="text-slate-500">Voucher (Rp)</span>
                    <input id="voucher" type="number" oninput="renderCart()" placeholder="0" class="w-20 text-right border-b border-blue-300 bg-transparent focus:border-blue-600 outline-none font-bold text-red-600">
                </div>
                
                <div class="flex justify-between items-center py-1">
                    <span class="font-bold text-slate-700 text-sm">TOTAL</span>
                    <span class="text-xl font-black text-blue-700">Rp <span id="total">0</span></span>
                </div>

                <div class="space-y-2">
                    <select id="metode" onchange="renderCash()" class="w-full border border-slate-200 rounded-lg p-2 text-xs font-bold bg-white">
                        <option value="CASH">üíµ TUNAI</option>
                        <option value="QRIS">üì± QRIS</option>
                        <option value="CARD">üí≥ KARTU</option>
                    </select>

                    <div id="cashBox" class="empty:hidden"></div>

                    <button onclick="submitOrder()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-extrabold text-sm shadow-md transition active:scale-95">
                        BAYAR & CETAK
                    </button>
                </div>
            </div>
        </section>
    </main>

<script>
/* ================= LOGIC (TIDAK DISENTUH SAMA SEKALI) ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyvU5fQpE_UFq_mnfAMvhCNJ97f1SvVRpXv_qrZh96lj8IBPot8xRdQ34Iz1n-HVmiuzg/exec";
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZGCGtu4xfKCj0zCGB2BldzF2fLjFCIOfVSXBAMeTM-3KGHfC9mZ_bhfaTnikwxd5427w4ULtotTJH/pub?gid=2132421401&single=true&output=csv";
const TOKEN = "dyg-access-v2";

let MENU = [];
let cart = {};
let member = null;

async function loadMenu() {
    try {
        const response = await fetch(CSV_URL);
        const data = await response.text();
        const rows = data.split("\n").slice(1);
        MENU = rows.map(row => {
            const cols = row.split(",");
            return {
                kategori: cols[0]?.trim() || "Lainnya",
                nama: cols[1]?.trim(),
                harga: parseInt(cols[2]?.trim()) || 0
            };
        }).filter(m => m.nama);
        populateCategories();
        renderMenu();
    } catch (e) { console.error("Gagal load data menu", e); }
}

function populateCategories() {
    const cats = [...new Set(MENU.map(m => m.kategori))];
    const select = document.getElementById("categoryFilter");
    cats.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c; opt.innerText = c;
        select.appendChild(opt);
    });
}

function renderMenu() {
    const list = document.getElementById("menuList");
    const search = document.getElementById("searchInput").value.toLowerCase();
    const filter = document.getElementById("categoryFilter").value;
    list.innerHTML = "";
    MENU.forEach((m, i) => {
        if ((filter === "ALL" || m.kategori === filter) && (m.nama.toLowerCase().includes(search))) {
            const el = document.createElement("div");
            el.className = "menu-card bg-white p-2.5 rounded-xl shadow-sm flex flex-col justify-between cursor-pointer relative";
            el.onclick = () => addItem(i);
            el.innerHTML = `
                <div>
                    <div class="text-[8px] font-bold text-blue-500 uppercase">${m.kategori}</div>
                    <div class="font-bold text-slate-800 text-[11px] mt-0.5 leading-tight line-clamp-2">${m.nama}</div>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <div class="text-[11px] font-black text-slate-900">Rp${m.harga.toLocaleString()}</div>
                    <div class="bg-blue-50 text-blue-600 rounded-md p-0.5">
                        <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/></svg>
                    </div>
                </div>
                <span id="badge-${i}" class="hidden absolute -top-1 -right-1 bg-red-600 text-white text-[9px] w-5 h-5 flex items-center justify-center rounded-full font-bold border-2 border-white shadow-sm"></span>
            `;
            list.appendChild(el);
        }
    });
    updateBadges();
}

function filterMenu() { renderMenu(); }
function addItem(i) {
    if (!cart[i]) cart[i] = { qty: 0, ...MENU[i] };
    cart[i].qty++;
    renderCart();
}
function removeItem(i) {
    cart[i].qty--;
    if (cart[i].qty <= 0) delete cart[i];
    renderCart();
}
function updateBadges() {
    MENU.forEach((_, i) => {
        const badge = document.getElementById("badge-" + i);
        if (badge) {
            if (cart[i]) {
                badge.innerText = cart[i].qty;
                badge.classList.remove("hidden");
            } else { badge.classList.add("hidden"); }
        }
    });
}

function renderCart() {
    let html = "";
    let total = 0;
    Object.keys(cart).forEach(i => {
        const item = cart[i];
        total += item.qty * item.harga;
        html += `
            <div class="flex justify-between items-center bg-slate-50 p-2 rounded-lg border border-slate-100">
                <div class="flex-1 min-w-0 pr-2">
                    <div class="font-bold text-slate-800 text-[11px] truncate">${item.nama}</div>
                    <div class="text-[10px] text-slate-500">Rp ${item.harga.toLocaleString()}</div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="removeItem(${i})" class="w-6 h-6 rounded-md bg-white border border-slate-200 flex items-center justify-center text-xs shadow-sm">Ôºç</button>
                    <span class="font-bold text-xs w-3 text-center">${item.qty}</span>
                    <button onclick="addItem(${i})" class="w-6 h-6 rounded-md bg-white border border-slate-200 flex items-center justify-center text-xs shadow-sm">Ôºã</button>
                </div>
            </div>
        `;
    });
    const voucher = Number(document.getElementById("voucher").value || 0);
    document.getElementById("cartList").innerHTML = html || `<div class="flex flex-col items-center justify-center h-full text-slate-300"><p class="text-[10px]">Keranjang Kosong</p></div>`;
    document.getElementById("total").innerText = (total - voucher).toLocaleString();
    updateBadges();
}

function cekMember() {
    const nohp = document.getElementById("nohp").value.trim();
    if (!nohp) return;
    document.getElementById("memberInfo").innerText = "Mengecek...";
    fetch(`${API_URL}?token=${TOKEN}&action=cekMember&noHP=${nohp}`)
        .then(r => r.json())
        .then(d => {
            if (d.exists) {
                member = d;
                document.getElementById("memberInfo").innerHTML = `<span class="text-blue-600 font-bold">‚úÖ ${d.nama}</span>`;
            } else {
                member = null;
                document.getElementById("memberInfo").innerHTML = `<span class="text-red-500 font-bold">‚ùå Bukan Member</span>`;
            }
        });
}

function renderCash() {
    const metode = document.getElementById("metode").value;
    const box = document.getElementById("cashBox");
    if (metode !== "CASH") { box.innerHTML = ""; return; }
    box.innerHTML = `
        <div class="bg-blue-50 p-2.5 rounded-lg border border-blue-100 space-y-2">
            <div class="flex justify-between items-center">
                <label class="text-[9px] font-bold text-blue-700">BAYAR TUNAI</label>
                <input id="bayar" type="number" placeholder="0" class="w-24 bg-transparent border-b border-blue-400 text-right text-sm font-black text-blue-900 outline-none">
            </div>
            <div class="flex gap-1">
                ${[20000, 50000, 100000].map(v => `<button onclick="quickCash(${v})" class="flex-1 bg-white border border-blue-200 py-1 rounded text-[9px] font-bold hover:bg-blue-600 hover:text-white transition">${v/1000}K</button>`).join("")}
            </div>
            <div class="flex justify-between items-center text-[10px] font-bold text-blue-800 border-t border-blue-100 pt-1">
                <span>KEMBALI</span>
                <span>Rp <span id="kembali">0</span></span>
            </div>
        </div>
    `;
}

function quickCash(v) { document.getElementById("bayar").value = v; hitungKembali(); }
document.addEventListener("input", e => { if (e.target.id === "bayar") hitungKembali(); });

function hitungKembali() {
    const bayar = Number(document.getElementById("bayar")?.value || 0);
    const rawTotal = document.getElementById("total").innerText.replace(/,/g, '');
    const total = Number(rawTotal || 0);
    document.getElementById("kembali").innerText = (bayar - total).toLocaleString();
}

async function submitOrder() {
    const rawTotal = document.getElementById("total").innerText.replace(/,/g, '');
    const total = Number(rawTotal || 0);
    if (total <= 0 && Object.keys(cart).length === 0) { alert("Keranjang kosong"); return; }

    const voucher = Number(document.getElementById("voucher").value || 0);
    const finalTotal = Math.max(0, total);
    const metode = document.getElementById("metode").value;
    const noWA = document.getElementById("nohp").value || "";
    const pesanan = Object.values(cart).map(i => `${i.nama} x${i.qty}`).join(", ");

    const res = await fetch(`${API_URL}?token=${TOKEN}&action=processPayment&total=${finalTotal}&noWA=${noWA}&redeemQty=0&voucher=${voucher}&method=${metode}&pesanan=${encodeURIComponent(pesanan)}`);
    const txt = await res.text();

    if (txt === "SUCCESS") {
        let esc = "\x1B\x40\x1B\x61\x01\x1B\x21\x10dyg++ RETAIL\x1B\x21\x00\n";
        esc += "Tgl: " + new Date().toLocaleString() + "\n--------------------------------\n\x1B\x61\x00";
        Object.values(cart).forEach(i => {
            esc += `${i.nama}\n${i.qty} x ${i.harga.toLocaleString()} = ${(i.qty*i.harga).toLocaleString()}\n`;
        });
        esc += "--------------------------------\nTOTAL: Rp " + finalTotal.toLocaleString() + "\n";
        if (noWA) esc += "Member: " + noWA + "\n";
        esc += "\nTERIMA KASIH\n\n\n\n";

        if (window.AppInventor) window.AppInventor.setWebViewString("PRINT|" + esc);
        alert("Berhasil!");
        location.reload();
    } else {
        alert("Gagal menyimpan");
    }
}

// Start
loadMenu();
renderCash();
</script>
</body>
</html>