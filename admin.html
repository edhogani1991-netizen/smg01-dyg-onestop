<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>dyg++ POS SMART PAY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Plus Jakarta Sans',sans-serif;background:#0f172a;display:flex;justify-content:center;height:100dvh;overflow:hidden}
        .pos-container{width:100%;max-width:1100px;background:#F1F5F9;display:flex;flex-direction:column}
        .main-content{display:flex;flex:1;overflow:hidden}
        .menu-side{flex:1;display:flex;flex-direction:column;background:#F8FAFC;border-right:1px solid #e2e8f0}
        .admin-side{width:360px;display:flex;flex-direction:column;background:white;border-left:2px solid #cbd5e1;height:100%}
        .scroll-area{flex:1;overflow-y:auto;padding:12px}
        .collapse-content{display:none}
        .handle{cursor:pointer;background:#1e293b;color:#fbbf24;text-align:center;font-size:10px;padding:12px;font-weight:800;border-radius:8px;margin-bottom:8px;text-transform:uppercase}
        .handle-member{background:#1e40af;color:white}
        .badge-qty { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 99px; font-weight: 800; border: 2px solid white; }
        .payment-btn{background:#e2e8f0; padding:8px; border-radius:8px; font-size:10px; font-weight:800; text-align:center; cursor:pointer}
        .payment-btn:active{background:#cbd5e1; scale:0.95}
    </style>
</head>
<body>

<div class="pos-container shadow-2xl">
    <div class="bg-[#1B4332] text-white p-3 flex justify-between items-center shrink-0">
        <h1 class="text-lg font-black italic text-emerald-400 uppercase">dyg++ POS</h1>
        <div id="v-header-cash" class="text-lg font-black text-emerald-400 font-mono">Rp 0</div>
    </div>

    <div class="main-content">
        <div class="menu-side overflow-y-auto">
            <div class="p-2 border-b bg-white flex gap-2">
                <select id="cat-select" onchange="filterCat(this.value)" class="flex-1 p-2 bg-slate-100 border rounded-lg text-[10px] font-black uppercase outline-none"></select>
                <input type="text" id="menuSearch" oninput="renderMenu()" placeholder="Cari..." class="w-32 p-2 bg-slate-100 border rounded-lg text-[10px] font-bold outline-none">
            </div>
            <div id="menu-render" class="grid grid-cols-4 gap-2 p-3"></div>
        </div>

        <div class="admin-side">
            <div class="scroll-area space-y-2">
                
                <div onclick="toggleSection('sec-finance')" class="handle">ðŸ“Š FINANCE DASHBOARD</div>
                <div id="sec-finance" class="collapse-content space-y-3 p-3 bg-slate-100 rounded-xl border mb-2">
                    <div class="bg-white p-2 rounded-lg shadow-sm border text-[10px] font-bold">
                        <table class="w-full">
                            <tr><td>MODAL</td><td id="t-modal" class="text-right">0</td></tr>
                            <tr class="text-emerald-600"><td>CASH IN</td><td id="t-cash" class="text-right">0</td></tr>
                            <tr class="text-blue-600"><td>QRIS/TRF</td><td id="t-qris" class="text-right">0</td></tr>
                            <tr class="text-red-500"><td>BIAYA OUT</td><td id="t-out" class="text-right">0</td></tr>
                        </table>
                    </div>
                    <button id="btn-tutup-shift" onclick="tutupShift()" class="w-full bg-red-600 text-white py-2 rounded font-black text-[10px] hidden uppercase">Tutup Shift</button>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="saveFinance('pengeluaran', 'Biaya')" class="bg-orange-500 text-white p-2 rounded text-[9px] font-black uppercase">Pengeluaran</button>
                        <button onclick="saveFinance('online_food', 'Online')" class="bg-purple-500 text-white p-2 rounded text-[9px] font-black uppercase">Online Food</button>
                    </div>
                </div>

                <div onclick="toggleSection('sec-member')" class="handle handle-member">ðŸŽ« MEMBER & VOUCHER</div>
                <div id="sec-member" class="collapse-content space-y-3 p-3 bg-blue-50 rounded-xl border border-blue-200 mb-2">
                    <input type="number" id="member-hp" placeholder="No HP Member" class="w-full p-2 border rounded text-xs font-bold mb-1">
                    <button onclick="cekMember()" class="w-full bg-blue-600 text-white py-2 rounded font-black text-[9px] uppercase">Cek Member</button>
                    <div id="member-info" class="mt-2 hidden p-2 bg-blue-600 text-white rounded text-[10px]">
                        <p id="m-nama" class="font-black"></p><p id="m-poin" class="font-bold text-yellow-300"></p>
                        <button onclick="applyRedeem()" class="mt-2 w-full bg-white text-blue-700 py-1.5 rounded font-black uppercase">Pakai Poin</button>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-2 border-2 border-slate-200 min-h-[140px]">
                    <div id="cart-list" class="space-y-2"></div>
                </div>
            </div>

            <div class="sticky-bottom p-4 border-t-2 bg-white">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-[10px] font-black opacity-50 uppercase">Metode:</span>
                    <select id="pay-method" onchange="togglePayView()" class="p-1 bg-slate-100 border rounded font-black text-[11px] outline-none">
                        <option value="TUNAI">ðŸ’µ TUNAI</option>
                        <option value="QRIS">ðŸ“± QRIS / TRANSFER</option>
                        <option value="KARTU">ðŸ’³ KARTU DEBIT/CC</option>
                    </select>
                </div>

                <div id="cash-input-area" class="space-y-2 mb-3">
                    <div class="flex gap-2">
                        <input type="number" id="input-bayar" oninput="hitungKembalian()" placeholder="Jumlah Uang..." class="flex-1 p-3 bg-yellow-50 border-2 border-yellow-200 rounded-xl text-lg font-black outline-none">
                    </div>
                    <div id="smart-chips" class="grid grid-cols-4 gap-1"></div>
                    <div class="flex justify-between text-[11px] font-black text-blue-600 px-1">
                        <span>KEMBALIAN:</span><span id="v-kembali">Rp 0</span>
                    </div>
                </div>

                <div class="flex justify-between text-[#1B4332] mb-1">
                    <span class="font-black text-[11px] uppercase">Total</span>
                    <span id="v-total" class="text-3xl font-black">Rp 0</span>
                </div>
                <button onclick="submitOrder()" id="btn-order" class="w-full bg-[#1B4332] text-white py-4 rounded-2xl font-black text-[14px] shadow-lg uppercase">Bayar & Cetak</button>
            </div>
        </div>
    </div>
</div>

<script>
const CONFIG={
    API:"https://script.google.com/macros/s/AKfycbwgE4TNuajMZy34ZOQKcHbUniCm6wU-a4rjGESFZC_1r6wUBVm_EwUZKvqchK-Pk6jL/exec",
    CSV:"https://docs.google.com/spreadsheets/d/e/2PACX-1vQZGCGtu4xfKCj0zCGB2BldzF2fLjFCIOfVSXBAMeTM-3KGHfC9mZ_bhfaTnikwxd5427w4ULtotTJH/pub?gid=2132421401&single=true&output=csv",
    TOKEN:"dyg-access-v2"
};

let cart={}, menuData=[], activeCat='ALL', memberData=null, discount=0, finalTotal=0;

function toggleSection(id){ document.getElementById(id).style.display = (document.getElementById(id).style.display === "block") ? "none" : "block"; }

function togglePayView(){
    const method = document.getElementById("pay-method").value;
    document.getElementById("cash-input-area").style.display = (method === "TUNAI") ? "block" : "none";
}

function updateCartUI(){
    let sub=0; const l=document.getElementById("cart-list"); l.innerHTML="";
    Object.keys(cart).forEach(n=>{
        sub += cart[n].price * cart[n].qty;
        l.innerHTML+=`<div class="flex justify-between items-center text-[10px] font-black uppercase"><span>${n} x${cart[n].qty}</span><div class="flex gap-1"><button onclick="changeQty('${n}',-1)" class="w-5 h-5 bg-slate-200 rounded">-</button><button onclick="changeQty('${n}',1)" class="w-5 h-5 bg-slate-800 text-white rounded">+</button></div></div>`;
    });
    finalTotal = Math.max(0, sub - discount);
    document.getElementById("v-total").innerText="Rp "+ finalTotal.toLocaleString();
    generateSmartChips();
}

function generateSmartChips(){
    const area = document.getElementById("smart-chips"); area.innerHTML="";
    if(finalTotal <= 0) return;
    const chips = [finalTotal]; // Uang Pas
    [10000, 20000, 50000, 100000].forEach(nominal => { if(nominal > finalTotal) chips.push(nominal); });
    [...new Set(chips)].sort((a,b)=>a-b).slice(0,4).forEach(amt => {
        area.innerHTML += `<div onclick="setCash(${amt})" class="payment-btn">${amt === finalTotal ? 'PAS' : amt.toLocaleString()}</div>`;
    });
}

function setCash(amt){ document.getElementById("input-bayar").value = amt; hitungKembalian(); }

function hitungKembalian(){
    const bayar = document.getElementById("input-bayar").value || 0;
    const kembali = bayar - finalTotal;
    document.getElementById("v-kembali").innerText = "Rp " + (kembali > 0 ? kembali.toLocaleString() : 0);
}

// --- CORE FUNCTIONS ---
async function cekMember() {
    const hp = document.getElementById("member-hp").value;
    const r = await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=cekMember&noHP=${hp}`);
    const d = await r.json();
    if(d.exists) {
        memberData = d; memberData.noHP = hp;
        document.getElementById("m-nama").innerText = d.nama;
        document.getElementById("m-poin").innerText = "Poin: " + d.poin;
        document.getElementById("member-info").classList.remove("hidden");
    }
}

function applyRedeem(){ discount = memberData.poin; updateCartUI(); }

async function submitOrder(){
    if(finalTotal <= 0) return alert("Keranjang kosong!");
    const method = document.getElementById("pay-method").value;
    const bayar = document.getElementById("input-bayar").value || 0;
    if(method === "TUNAI" && bayar < finalTotal) return alert("Uang kurang!");

    const btn = document.getElementById("btn-order");
    btn.innerText = "PROSES..."; btn.disabled = true;
    
    try {
        const hp = memberData ? memberData.noHP : "";
        // Tambahkan info metode bayar ke GAS
        await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=processOrder&total=${finalTotal}&noHP=${hp}&poinRedeem=${discount}&pesanan=${encodeURIComponent(JSON.stringify(cart))}&method=${method}`);
        alert("Transaksi Berhasil!"); location.reload();
    } catch(e){ alert("Gagal!"); btn.disabled = false; }
}

async function updateMonitor() {
    const r = await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=getFinance`);
    const f = await r.json();
    window.finData = f;
    document.getElementById("v-header-cash").innerText = "Rp " + ((f.totalModal + f.totalCash) - f.totalOut).toLocaleString();
    document.getElementById("t-modal").innerText = f.totalModal.toLocaleString();
    document.getElementById("t-cash").innerText = f.totalCash.toLocaleString();
    document.getElementById("t-qris").innerText = f.totalQris.toLocaleString();
    document.getElementById("t-out").innerText = f.totalOut.toLocaleString();
}

// Init
function addToCart(n,p){ cart[n]={price:p, qty:(cart[n]?.qty||0)+1}; updateCartUI(); renderMenu(); }
function changeQty(n, d) { cart[n].qty += d; if(cart[n].qty <= 0) delete cart[n]; updateCartUI(); renderMenu(); }
async function loadMenu(){
    const r=await fetch(CONFIG.CSV); const t=await r.text();
    menuData = t.split("\n").slice(1).map(r => { const c = r.split(","); return { kat: c[0]?.trim(), nama: c[1]?.trim(), harga: parseInt(c[2]) || 0 }; }).filter(m => m.nama);
    document.getElementById("cat-select").innerHTML = ["ALL", ...new Set(menuData.map(m => m.kat))].map(c => `<option value="${c}">${c}</option>`).join("");
    renderMenu();
}
function renderMenu(){
    const c=document.getElementById("menu-render"); const s=document.getElementById("menuSearch").value.toLowerCase(); c.innerHTML="";
    menuData.filter(m => (activeCat === 'ALL' || m.kat === activeCat) && m.nama.toLowerCase().includes(s)).forEach(m=>{
        const q = cart[m.nama]?.qty || 0;
        c.innerHTML+=`<div onclick="addToCart('${m.nama}',${m.harga})" class="relative bg-white p-3 rounded-xl shadow-sm border border-slate-200 active:scale-95 cursor-pointer text-[10px] font-black uppercase"><div>${m.nama}</div><div class="text-emerald-600">Rp ${m.harga.toLocaleString()}</div>${q>0?`<div class="badge-qty">${q}</div>`:''}</div>`;
    });
}
function filterCat(v){ activeCat=v; renderMenu(); }
window.onload=()=>{ loadMenu(); updateMonitor(); }
</script>
</body>
</html>