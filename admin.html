<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLOUDkitchen.dyg++ POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .btn-qty { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; }
        .sticky-bottom { position: sticky; bottom: 0; background: white; border-top: 1px solid #e5e7eb; }
        input[type="number"]::-webkit-inner-spin-button { display: none; }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 antialiased pb-20">

    <header class="bg-blue-700 text-white p-4 shadow-md mb-4">
        <h1 class="text-xl font-bold flex items-center gap-2">
            <span>üßæ</span> Admin Kasir dyg++
        </h1>
    </header>

    <div class="max-w-4xl mx-auto px-4">
        
        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
            
            <div class="md:col-span-7">
                <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-slate-200">
                    <h2 class="text-sm font-semibold uppercase tracking-wider text-slate-500 mb-3">Loyalty Member</h2>
                    <div class="flex gap-2">
                        <input id="nohp" type="text" placeholder="Nomor WA (08...)" class="border border-slate-300 p-2 rounded-lg flex-1 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <button onclick="cekMember()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-black transition">
                            Cek
                        </button>
                    </div>
                    <div id="memberInfo" class="mt-2 text-xs font-medium text-blue-600"></div>
                </div>

                <div id="menuContainer">
                    </div>
            </div>

            <div class="md:col-span-5">
                <div class="sticky top-4 space-y-4">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="bg-slate-50 px-4 py-3 border-b border-slate-200">
                            <h2 class="font-bold text-slate-700">Detail Pesanan</h2>
                        </div>
                        <div id="cartList" class="p-4 space-y-3 max-h-[300px] overflow-y-auto text-sm">
                            <p class="text-slate-400 text-center py-4">Belum ada item</p>
                        </div>
                        <div class="p-4 bg-slate-50 border-t border-slate-200">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-slate-500">Subtotal</span>
                                <span class="font-semibold">Rp <span id="total">0</span></span>
                            </div>
                            <div class="flex justify-between items-center text-red-600">
                                <span class="text-xs">Voucher/Diskon</span>
                                <span class="font-semibold text-sm">- Rp <span id="valVoucher">0</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="font-bold text-slate-700 mb-3">Pembayaran</h2>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="text-[10px] font-bold uppercase text-slate-400">Voucher</label>
                                <input id="voucher" type="number" oninput="updateVoucherText()" placeholder="Nominal" class="border p-2 w-full rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>

                            <div>
                                <label class="text-[10px] font-bold uppercase text-slate-400">Metode</label>
                                <select id="metode" onchange="renderCash()" class="border p-2 w-full rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                    <option value="CASH">üíµ Tunai (Cash)</option>
                                    <option value="QRIS">üì± QRIS</option>
                                    <option value="CARD">üí≥ Kartu Debet/Kredit</option>
                                </select>
                            </div>

                            <div id="cashBox" class="bg-blue-50 p-3 rounded-lg border border-blue-100"></div>

                            <button onclick="submitOrder()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 transition-all active:scale-95">
                                BAYAR & CETAK STRUK
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyvU5fQpE_UFq_mnfAMvhCNJ97f1SvVRpXv_qrZh96lj8IBPot8xRdQ34Iz1n-HVmiuzg/exec";
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZGCGtu4xfKCj0zCGB2BldzF2fLjFCIOfVSXBAMeTM-3KGHfC9mZ_bhfaTnikwxd5427w4ULtotTJH/pub?gid=2132421401&single=true&output=csv";
const TOKEN = "dyg-access-v2";

let MENU = [];
let cart = {};
let member = null;

/* ================= FETCH DATA MENU CSV ================= */
async function loadMenu() {
    try {
        const response = await fetch(CSV_URL);
        const data = await response.text();
        const rows = data.split("\n").slice(1); // Skip header
        
        MENU = rows.map(row => {
            const cols = row.split(",");
            return {
                kategori: cols[0]?.trim() || "Lainnya",
                nama: cols[1]?.trim(),
                harga: parseInt(cols[2]?.trim()) || 0
            };
        }).filter(m => m.nama); // Buang baris kosong

        renderMenu();
    } catch (e) {
        console.error("Gagal load menu", e);
    }
}

function renderMenu() {
    const container = document.getElementById("menuContainer");
    container.innerHTML = "";
    
    // Group by kategori
    const groups = MENU.reduce((acc, item) => {
        (acc[item.kategori] = acc[item.kategori] || []).push(item);
        return acc;
    }, {});

    for (const cat in groups) {
        const section = document.createElement("div");
        section.className = "mb-6";
        section.innerHTML = `
            <h3 class="font-bold text-slate-700 mb-3 flex items-center gap-2">
                <span class="w-1 h-4 bg-blue-600 rounded-full"></span> ${cat}
            </h3>
            <div class="menu-grid">
                ${groups[cat].map((m) => {
                    const idx = MENU.indexOf(m);
                    return `
                    <div onclick="addItem(${idx})" class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm active:bg-blue-50 cursor-pointer transition-all relative overflow-hidden group">
                        <div class="font-bold text-sm text-slate-700">${m.nama}</div>
                        <div class="text-blue-600 font-medium text-xs">Rp ${m.harga.toLocaleString()}</div>
                        <span id="badge-${idx}" class="hidden absolute top-0 right-0 bg-red-500 text-white text-[10px] px-2 py-1 rounded-bl-lg font-bold">0</span>
                    </div>
                    `;
                }).join("")}
            </div>
        `;
        container.appendChild(section);
    }
}

/* ================= LOGIC (Fungsi Asli Dipertahankan) ================= */

function addItem(i) {
    if (!cart[i]) cart[i] = { qty: 0, ...MENU[i] };
    cart[i].qty++;
    renderCart();
}

function removeItem(i) {
    cart[i].qty--;
    if (cart[i].qty <= 0) delete cart[i];
    renderCart();
}

function renderCart() {
    let html = "";
    let total = 0;

    MENU.forEach((_, i) => {
        const badge = document.getElementById("badge-" + i);
        if (badge) badge.classList.add("hidden");
    });

    Object.keys(cart).forEach(i => {
        const item = cart[i];
        total += item.qty * item.harga;

        const badge = document.getElementById("badge-" + i);
        if(badge) {
            badge.innerText = item.qty;
            badge.classList.remove("hidden");
        }

        html += `
            <div class="flex justify-between items-center bg-slate-50 p-2 rounded-lg">
                <div class="flex-1">
                    <div class="font-bold text-slate-700">${item.nama}</div>
                    <div class="text-xs text-slate-500">Rp ${item.harga.toLocaleString()}</div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="removeItem(${i})" class="btn-qty bg-white border border-slate-300 text-slate-600 hover:bg-red-50 hover:text-red-600 transition">Ôºç</button>
                    <span class="font-bold w-4 text-center">${item.qty}</span>
                    <button onclick="addItem(${i})" class="btn-qty bg-white border border-slate-300 text-slate-600 hover:bg-green-50 hover:text-green-600 transition">Ôºã</button>
                </div>
            </div>
        `;
    });

    document.getElementById("cartList").innerHTML = html || `<p class="text-slate-400 text-center py-4">Belum ada item</p>`;
    document.getElementById("total").innerText = total.toLocaleString();
    if(document.getElementById("bayar")) hitungKembali();
}

function updateVoucherText() {
    const val = document.getElementById("voucher").value || 0;
    document.getElementById("valVoucher").innerText = Number(val).toLocaleString();
}

function cekMember() {
    const nohp = document.getElementById("nohp").value.trim();
    if (!nohp) return;
    document.getElementById("memberInfo").innerText = "Mengecek...";
    fetch(`${API_URL}?token=${TOKEN}&action=cekMember&noHP=${nohp}`)
        .then(r => r.json())
        .then(d => {
            if (d.exists) {
                member = d;
                document.getElementById("memberInfo").innerText = `‚úÖ ${d.nama} | Poin: ${d.poin}`;
            } else {
                member = null;
                document.getElementById("memberInfo").innerText = "‚ùå Bukan member";
            }
        });
}

function renderCash() {
    const metode = document.getElementById("metode").value;
    const box = document.getElementById("cashBox");
    if (metode !== "CASH") { box.classList.add("hidden"); return; }
    box.classList.remove("hidden");

    box.innerHTML = `
        <label class="text-[10px] font-bold uppercase text-blue-400">Uang Diterima</label>
        <input id="bayar" type="number" placeholder="0" class="border-b-2 border-blue-200 bg-transparent p-2 w-full mb-2 font-bold text-lg outline-none focus:border-blue-500">
        <div class="flex gap-2 mb-3">
            ${[20000, 50000, 100000].map(v =>
                `<button onclick="quickCash(${v})" class="flex-1 bg-white border border-blue-200 py-1 rounded-md text-xs font-bold text-blue-700 hover:bg-blue-600 hover:text-white transition">${v/1000}k</button>`
            ).join("")}
        </div>
        <div class="text-sm font-bold text-blue-800 flex justify-between">
            <span>Kembalian:</span>
            <span>Rp <span id="kembali">0</span></span>
        </div>
    `;
}

function quickCash(v) {
    document.getElementById("bayar").value = v;
    hitungKembali();
}

document.addEventListener("input", e => {
    if (e.target.id === "bayar") hitungKembali();
});

function hitungKembali() {
    const bayar = Number(document.getElementById("bayar")?.value || 0);
    const rawTotal = document.getElementById("total").innerText.replace(/,/g, '');
    const total = Number(rawTotal || 0);
    const voucher = Number(document.getElementById("voucher").value || 0);
    const kembali = bayar - (total - voucher);
    document.getElementById("kembali").innerText = kembali.toLocaleString();
}

async function submitOrder() {
    const rawTotal = document.getElementById("total").innerText.replace(/,/g, '');
    const total = Number(rawTotal || 0);
    if (total <= 0) { alert("Keranjang kosong"); return; }

    const voucher = Number(document.getElementById("voucher").value || 0);
    const finalTotal = Math.max(0, total - voucher);
    const metode = document.getElementById("metode").value;
    const noWA = document.getElementById("nohp").value || "";

    const pesanan = Object.values(cart)
        .map(i => `${i.nama} x${i.qty}`)
        .join(", ");

    const url = `${API_URL}?token=${TOKEN}&action=processPayment&total=${finalTotal}&noWA=${noWA}&redeemQty=0&voucher=${voucher}&method=${metode}&pesanan=${encodeURIComponent(pesanan)}`;

    try {
        const res = await fetch(url);
        const txt = await res.text();

        if (txt === "SUCCESS") {
            // Logic Print Esc/Pos Anda
            let esc = "\x1B\x40\x1B\x61\x01\x1B\x21\x10dyg++ RETAIL\x1B\x21\x00\n";
            esc += "Tgl: " + new Date().toLocaleString() + "\n";
            esc += "--------------------------------\n\x1B\x61\x00";
            Object.values(cart).forEach(i => {
                esc += `${i.nama}\n`;
                esc += `${i.qty} x ${i.harga.toLocaleString()} = ${(i.qty*i.harga).toLocaleString()}\n`;
            });
            esc += "--------------------------------\n";
            esc += "TOTAL: Rp " + finalTotal.toLocaleString() + "\n";
            if (noWA) esc += "Member: " + noWA + "\n";
            esc += "\nTERIMA KASIH\n\n\n\n";

            if (window.AppInventor) {
                window.AppInventor.setWebViewString("PRINT|" + esc);
            }

            alert("Transaksi Berhasil");
            location.reload();
        } else {
            alert("Gagal menyimpan");
        }
    } catch (e) {
        alert("Terjadi kesalahan koneksi");
    }
}

// Jalankan load menu saat start
loadMenu();
renderCash();
</script>

</body>
</html>