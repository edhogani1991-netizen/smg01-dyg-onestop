<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>dyg++ POS Ultra Compact V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; overflow: hidden; background-color: #f1f5f9; font-size: 9px; }
        .custom-scroll::-webkit-scrollbar { width: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .main-container { height: calc(100vh - 45px); display: flex; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 4px; align-content: start; }
        .menu-card { transition: all 0.1s; border: 1px solid #e2e8f0; position: relative; height: 82px; }
        .menu-card:active { transform: scale(0.97); }
        input, select { outline: none; }
    </style>
</head>
<body class="h-screen flex flex-col">

<header class="h-[45px] bg-white border-b border-slate-200 px-3 flex justify-between items-center shrink-0">
    <div class="flex items-center gap-2">
        <h1 class="text-sm font-black text-blue-700 tracking-tighter">dyg++</h1>
        <div id="memberInfo" class="text-[8px] text-slate-400 italic truncate max-w-[100px]">Ready</div>
    </div>
    <div class="flex items-center gap-2">
        <button id="btnOpenShift" onclick="manageShift('open')" class="bg-emerald-600 text-white px-2 py-1 rounded text-[9px] font-bold">BUKA</button>
        <button id="btnCloseShift" onclick="manageShift('close')" class="bg-rose-600 text-white px-2 py-1 rounded text-[9px] font-bold hidden">TUTUP</button>
        <div class="flex items-center gap-1 border-l pl-2">
            <input id="nohp" type="text" placeholder="No WA" class="bg-slate-100 rounded px-2 py-1 text-[9px] w-24">
            <button onclick="cekMember()" class="bg-blue-600 text-white px-2 py-1 rounded text-[9px] font-bold">Cek</button>
        </div>
    </div>
</header>

<main class="flex-1 overflow-hidden main-container">
    <section class="flex-1 flex flex-col bg-slate-50 overflow-hidden">
        <div class="p-1.5 flex gap-1.5 bg-white border-b border-slate-200">
            <input type="text" id="searchInput" oninput="renderMenu()" placeholder="Cari..." class="flex-1 px-2 py-1 bg-slate-100 rounded text-[10px]">
            <select id="categoryFilter" onchange="renderMenu()" class="bg-slate-100 rounded px-1 py-1 text-[9px] font-bold w-20">
                <option value="ALL">Semua</option>
            </select>
        </div>
        <div id="menuList" class="menu-grid p-1.5 overflow-y-auto custom-scroll flex-1"></div>
    </section>

    <section class="w-[260px] flex flex-col bg-white border-l border-slate-200 shrink-0">
        <div class="p-2 border-b flex justify-between items-center bg-slate-50">
            <span class="font-bold text-[9px] text-slate-500 uppercase">Keranjang</span>
            <button onclick="location.reload()" class="text-[8px] text-red-500 font-bold">RESET</button>
        </div>
        <div id="cartList" class="flex-1 overflow-y-auto custom-scroll p-1.5 space-y-1">
            <div class="text-center text-slate-300 mt-10 text-[9px]">Kosong</div>
        </div>

        <div class="p-2 bg-slate-50 border-t border-slate-200 space-y-2">
            <div id="pointDiscWrapper" class="hidden flex justify-between text-[9px] font-bold text-red-600 animate-pulse px-1">
                <span>DISKON MEMBER</span><span>- Rp <span id="pointDiscNominal">0</span></span>
            </div>
            <div class="flex justify-between items-center text-[10px] font-black px-1">
                <span class="text-slate-500 uppercase">Total</span>
                <span class="text-blue-700 text-base">Rp <span id="total">0</span></span>
            </div>
            <div class="space-y-1.5">
                <select id="metode" onchange="renderCash()" class="w-full border rounded p-1 text-[10px] font-bold bg-white">
                    <option value="CASH">üíµ TUNAI</option>
                    <option value="QRIS">üì± QRIS</option>
                    <option value="CARD">üí≥ KARTU / EDC</option>
                </select>
                <div id="cashBox" class="space-y-1"></div>
                <button id="btnSubmitOrder" onclick="submitOrder()" class="w-full bg-blue-600 text-white py-2 rounded font-bold text-[10px] uppercase shadow-sm">Bayar & Cetak</button>
            </div>
        </div>
    </section>
</main>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwTo5_KeeT_HN7T1zMJG8EEQV1B4GoUic3he6eFQtUk4KAR3NSMb0Ml9x2IvBJ7_TEnIA/exec";
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZGCGtu4xfKCj0zCGB2BldzF2fLjFCIOfVSXBAMeTM-3KGHfC9mZ_bhfaTnikwxd5427w4ULtotTJH/pub?gid=2132421401&single=true&output=csv";
const TOKEN = "dyg-access-v2";

let MENU = [], cart = {}, member = null, redeemQty = 0, pointDiscount = 0, shiftOpen = false, pendingOrder = null;

async function checkShiftStatus() {
    try {
        const res = await fetch(`${API_URL}?token=${TOKEN}&action=getShiftStatus`);
        const status = await res.text();
        shiftOpen = (status === "OPEN");
        document.getElementById("btnOpenShift").classList.toggle("hidden", shiftOpen);
        document.getElementById("btnCloseShift").classList.toggle("hidden", !shiftOpen);
        const btnSubmit = document.getElementById("btnSubmitOrder");
        btnSubmit.disabled = !shiftOpen;
        if (!shiftOpen) btnSubmit.innerText = "SHIFT TUTUP";
    } catch (e) { console.error(e); }
}

async function loadMenu() {
    const response = await fetch(CSV_URL);
    const data = await response.text();
    const rows = data.split("\n").slice(1);
    MENU = rows.map(row => {
        const c = row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
        return { kategori: c[0]?.trim(), nama: c[1]?.trim(), harga: parseInt(c[2]) || 0 };
    }).filter(m => m.nama);
    const cats = [...new Set(MENU.map(m => m.kategori))];
    const select = document.getElementById("categoryFilter");
    select.innerHTML = '<option value="ALL">Semua</option>';
    cats.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`);
    renderMenu();
}

function renderMenu() {
    const list = document.getElementById("menuList");
    const search = document.getElementById("searchInput").value.toLowerCase();
    const filter = document.getElementById("categoryFilter").value;
    list.innerHTML = "";
    MENU.forEach((m, i) => {
        if ((filter === "ALL" || m.kategori === filter) && m.nama.toLowerCase().includes(search)) {
            const qty = cart[i] ? cart[i].qty : 0;
            list.innerHTML += `
            <div class="menu-card bg-white p-2 rounded shadow-sm flex flex-col justify-between">
                <div onclick="addItem(${i})" class="cursor-pointer">
                    <div class="text-[6px] font-bold text-blue-500 uppercase">${m.kategori}</div>
                    <div class="font-bold text-slate-800 text-[9px] leading-tight line-clamp-2">${m.nama}</div>
                    ${qty > 0 ? `<div class="absolute -top-1 -right-1 bg-red-600 text-white text-[8px] w-4 h-4 rounded-full flex items-center justify-center font-bold border border-white animate-bounce">${qty}</div>` : ''}
                </div>
                <div class="flex justify-between items-center mt-1">
                    <div class="text-[9px] font-black text-slate-900">Rp${m.harga.toLocaleString()}</div>
                    <div class="flex items-center gap-1">
                        ${qty > 0 ? `<button onclick="removeItem(${i})" class="w-4 h-4 bg-slate-100 rounded text-[10px] font-bold border border-slate-300">-</button>` : ''}
                        <button onclick="addItem(${i})" class="w-4 h-4 bg-blue-600 text-white rounded text-[10px] font-bold">+</button>
                    </div>
                </div>
            </div>`;
        }
    });
}

function addItem(i) {
    if (!cart[i]) cart[i] = { ...MENU[i], qty: 0 };
    cart[i].qty++;
    renderCart();
    renderMenu();
}

function removeItem(i) {
    if(!cart[i]) return;
    cart[i].qty--;
    if (cart[i].qty <= 0) delete cart[i];
    renderCart();
    renderMenu();
}

function renderCart() {
    let html = "", total = 0;
    Object.keys(cart).forEach(i => {
        const item = cart[i];
        total += item.qty * item.harga;
        html += `
        <div class="flex justify-between items-center bg-slate-50 p-1.5 rounded border border-slate-100">
            <div class="flex flex-col flex-1 overflow-hidden mr-2">
                <span class="font-bold text-[9px] truncate">${item.nama}</span>
                <span class="text-[8px] text-slate-500">@${item.harga.toLocaleString()}</span>
            </div>
            <div class="flex items-center gap-1.5">
                <button onclick="removeItem(${i})" class="w-4 h-4 bg-white border rounded text-[9px] flex items-center justify-center">Ôºç</button>
                <span class="font-bold text-[9px] min-w-[10px] text-center">${item.qty}</span>
                <button onclick="addItem(${i})" class="w-4 h-4 bg-white border rounded text-[9px] flex items-center justify-center">Ôºã</button>
            </div>
        </div>`;
    });
    const bersih = Math.max(0, total - pointDiscount);
    document.getElementById("total").innerText = bersih.toLocaleString();
    document.getElementById("cartList").innerHTML = html || '<div class="text-center text-slate-300 text-[10px] mt-10">Kosong</div>';
    document.getElementById("pointDiscWrapper").classList.toggle("hidden", pointDiscount <= 0);
    document.getElementById("pointDiscNominal").innerText = pointDiscount.toLocaleString();
    renderCash();
}

function renderCash() {
    const box = document.getElementById("cashBox");
    const total = Number(document.getElementById("total").innerText.replace(/\D/g,''));
    if (document.getElementById("metode").value !== "CASH" || total <= 0) { box.innerHTML = ""; return; }
    const denoms = [2000, 5000, 10000, 20000, 50000, 100000];
    let btns = `<button onclick="quickCash(${total})" class="flex-1 bg-blue-600 text-white p-1 rounded text-[8px] font-bold uppercase">Pas</button>`;
    denoms.forEach(d => { if(d > total) btns += `<button onclick="quickCash(${d})" class="flex-1 bg-white border border-blue-200 p-1 rounded text-[8px] font-bold text-blue-700">${d/1000}K</button>`; });
    box.innerHTML = `
    <div class="bg-blue-50 p-1.5 rounded space-y-1.5">
        <div class="flex gap-1 flex-wrap">${btns}</div>
        <div class="flex justify-between items-center">
            <span class="text-[9px] font-bold text-blue-700 uppercase">Bayar:</span>
            <input id="bayar" type="number" oninput="hitungKembali()" class="w-24 bg-white border border-blue-300 rounded px-1 py-0.5 text-right text-[11px] font-black outline-none">
        </div>
        <div class="flex justify-between text-[9px] font-black text-blue-800 bg-white p-1 rounded border border-blue-100">
            <span>KEMBALI</span><span>Rp <span id="kembali">0</span></span>
        </div>
    </div>`;
}

function quickCash(v) { document.getElementById("bayar").value = v; hitungKembali(); }
function hitungKembali() {
    const t = Number(document.getElementById("total").innerText.replace(/\D/g,''));
    const b = Number(document.getElementById("bayar").value);
    document.getElementById("kembali").innerText = Math.max(0, b - t).toLocaleString();
}

function cekMember() {
    const no = document.getElementById("nohp").value.trim();
    if (!no) return;
    document.getElementById("memberInfo").innerText = "Checking...";
    fetch(`${API_URL}?token=${TOKEN}&action=cekMember&noHP=${no}`).then(r => r.json()).then(d => {
        if (d.exists) {
            member = d;
            document.getElementById("memberInfo").innerHTML = `<span class="text-blue-600 font-bold">‚úÖ ${d.nama} (${d.poin} P)</span>`;
            if (d.poin >= 500) {
                let maxTukar = Math.floor(d.poin / 500) * 500;
                if (confirm(`Tukarkan ${maxTukar} poin untuk diskon Rp${(maxTukar * 10).toLocaleString()}?`)) {
                    redeemQty = maxTukar; pointDiscount = maxTukar * 10; renderCart();
                }
            }
        } else { alert("Member Tidak Ditemukan"); member = null; }
    });
}

async function submitOrder() {
    if (!shiftOpen) return alert("Buka shift dulu!");
    const total = Number(document.getElementById("total").innerText.replace(/\D/g,''));
    if (total <= 0) return alert("Keranjang kosong!");

    const btn = document.getElementById("btnSubmitOrder");
    const oriText = btn.innerText;
    btn.innerText = "MENGIRIM..."; btn.disabled = true;

    const trxId = "TRX-" + Date.now();
    const pesanan = Object.values(cart).map(i => `${i.nama} x${i.qty}`).join(", ");
    pendingOrder = { total, noWA: document.getElementById("nohp").value || "-", pesanan, metode: document.getElementById("metode").value, trxId };

    const earn = (member) ? Math.floor(total / 20000) * 100 : 0;
    const totalPoinAkhir = (member) ? (Number(member.poin) + earn - redeemQty) : 0;

    // VALIDASI CLOUD DULU (Agar Rekapan Aman)
    try {
        const isSaved = await prosesSimpanKeCloud();
        if (isSaved) {
            // CETAK STRUK
            let esc = "\x1B\x40\x1B\x61\x01\x1B\x21\x10dyg++ CLOUD KITCHEN\x1B\x21\x00\n";
            esc += "ID: " + trxId + "\n--------------------------------\n\x1B\x61\x00";
            Object.values(cart).forEach(i => esc += `${i.nama}\n${i.qty} x ${i.harga} = ${i.qty * i.harga}\n`);
            esc += "--------------------------------\n";
            esc += "TOTAL   : Rp " + total.toLocaleString() + "\n";
            esc += "METODE  : " + pendingOrder.metode + "\n";
            esc += "MEMBER  : " + (member ? member.nama : "-") + "\n";
            esc += "SISA POIN: " + totalPoinAkhir + "\n";
            esc += "--------------------------------\n\x1B\x61\x01TERIMA KASIH\n\n\n\n\n";

            if (window.AppInventor) window.AppInventor.setWebViewString("PRINT|" + esc);
            
            // REFRESH INSTAN
            location.reload();
        } else {
            throw new Error();
        }
    } catch (e) {
        alert("KONEKSI ERROR! Data gagal masuk rekapan. Coba lagi.");
        btn.innerText = oriText; btn.disabled = false;
    }
}

async function prosesSimpanKeCloud() {
    const p = new URLSearchParams({
        token: TOKEN, action: "processPayment",
        total: pendingOrder.total, pesanan: pendingOrder.pesanan,
        method: pendingOrder.metode, trxId: pendingOrder.trxId,
        noWA: pendingOrder.noWA, redeemQty: redeemQty
    });
    try {
        const res = await fetch(`${API_URL}?${p.toString()}`);
        return res.ok;
    } catch (e) { return false; }
}

async function manageShift(type) {
    if (type === 'open') {
        if (!confirm("Buka shift?")) return;
        await fetch(`${API_URL}?token=${TOKEN}&action=openShift`, { mode: 'no-cors' });
        setTimeout(() => location.reload(), 1000);
    } else {
        if (!confirm("Tutup shift & Cetak Laporan?")) return;
        const res = await fetch(`${API_URL}?token=${TOKEN}&action=getShiftReport`);
        const r = await res.json();
        let esc = "\x1B\x40\x1B\x61\x01\x1B\x21\x10LAPORAN TUTUP SHIFT\x1B\x21\x00\n";
        esc += (r.shiftName || "Shift") + "\n--------------------------------\n\x1B\x61\x00";
        esc += "Total Trx       : " + r.totalTrx + "\n";
        esc += "Total Pemasukan : Rp " + (r.totalPemasukan || 0).toLocaleString() + "\n";
        esc += "  - CASH        : Rp " + (r.cash || 0).toLocaleString() + "\n";
        esc += "  - QRIS        : Rp " + (r.qris || 0).toLocaleString() + "\n";
        esc += "--------------------------------\n";
        const memberList = Object.keys(r.members || {});
        if (memberList.length > 0) {
            esc += "RINCIAN POIN MEMBER:\n";
            memberList.forEach(m => esc += `- ${m}: +${r.members[m]}\n`);
        }
        esc += "\n\n\n\n\n";
        if (window.AppInventor) window.AppInventor.setWebViewString("PRINT|" + esc);
        setTimeout(async () => {
            await fetch(`${API_URL}?token=${TOKEN}&action=closeShift`, { mode: 'no-cors' });
            location.reload();
        }, 1500);
    }
}
window.onload = () => { loadMenu(); checkShiftStatus(); };
</script>
</body>
</html>