<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Kasir dyg++</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-4">

<h1 class="text-2xl font-bold mb-4">ðŸ§¾ Admin Kasir dyg++</h1>

<!-- MEMBER -->
<div class="bg-white p-4 rounded shadow mb-4">
  <h2 class="font-semibold mb-2">Member</h2>
  <div class="flex gap-2">
    <input id="nohp" type="text" placeholder="Nomor WA" class="border p-2 flex-1">
    <button onclick="cekMember()" class="bg-green-600 text-white px-4 rounded">
      Cek Poin
    </button>
  </div>
  <div id="memberInfo" class="mt-2 text-sm"></div>
</div>

<!-- MENU -->
<div id="menuList" class="grid grid-cols-2 gap-3 mb-4"></div>

<!-- KERANJANG -->
<div class="bg-white p-4 rounded shadow mb-4">
  <h2 class="font-semibold mb-2">Keranjang</h2>
  <div id="cartList" class="text-sm"></div>
  <div class="mt-2 font-bold">
    Total: Rp <span id="total">0</span>
  </div>
</div>

<!-- VOUCHER -->
<div class="bg-white p-4 rounded shadow mb-4">
  <h2 class="font-semibold mb-2">Voucher</h2>
  <input id="voucher" type="number" placeholder="Nominal voucher"
         class="border p-2 w-full">
</div>

<!-- PEMBAYARAN -->
<div class="bg-white p-4 rounded shadow">
  <h2 class="font-semibold mb-2">Pembayaran</h2>

  <select id="metode" onchange="renderCash()" class="border p-2 w-full mb-2">
    <option value="CASH">Tunai</option>
    <option value="QRIS">QRIS</option>
    <option value="CARD">Kartu</option>
  </select>

  <div id="cashBox"></div>

  <button onclick="submitOrder()"
          class="mt-4 bg-blue-600 text-white w-full py-2 rounded font-semibold">
    BAYAR & CETAK
  </button>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyvU5fQpE_UFq_mnfAMvhCNJ97f1SvVRpXv_qrZh96lj8IBPot8xRdQ34Iz1n-HVmiuzg/exec";
const TOKEN = "dyg-access-v2";

/* ================= DATA MENU ================= */
const MENU = [
  { nama: "Nasi Goreng", harga: 20000 },
  { nama: "Mie Goreng", harga: 18000 },
  { nama: "Es Teh", harga: 5000 },
  { nama: "Kopi", harga: 8000 }
];

let cart = {};
let member = null;

/* ================= RENDER MENU ================= */
const menuList = document.getElementById("menuList");

MENU.forEach((m, i) => {
  const el = document.createElement("div");
  el.className = "bg-white p-3 rounded shadow relative";
  el.innerHTML = `
    <div class="font-bold">${m.nama}</div>
    <div>Rp ${m.harga.toLocaleString()}</div>
    <button onclick="addItem(${i})"
            class="mt-2 bg-green-500 text-white px-3 rounded">
      Tambah
    </button>
    <span id="badge-${i}"
          class="hidden absolute top-1 right-2 bg-red-600
                 text-white text-xs px-2 rounded-full"></span>
  `;
  menuList.appendChild(el);
});

/* ================= CART ================= */
function addItem(i) {
  if (!cart[i]) cart[i] = { qty: 0, ...MENU[i] };
  cart[i].qty++;
  renderCart();
}

function removeItem(i) {
  cart[i].qty--;
  if (cart[i].qty <= 0) delete cart[i];
  renderCart();
}

function renderCart() {
  let html = "";
  let total = 0;

  MENU.forEach((_, i) => {
    const badge = document.getElementById("badge-" + i);
    if (badge) badge.classList.add("hidden");
  });

  Object.keys(cart).forEach(i => {
    const item = cart[i];
    total += item.qty * item.harga;

    const badge = document.getElementById("badge-" + i);
    badge.innerText = item.qty;
    badge.classList.remove("hidden");

    html += `
      <div class="flex justify-between mb-1">
        ${item.nama} x${item.qty}
        <div>
          <button onclick="addItem(${i})">âž•</button>
          <button onclick="removeItem(${i})">âž–</button>
        </div>
      </div>
    `;
  });

  document.getElementById("cartList").innerHTML = html || "-";
  document.getElementById("total").innerText = total;
}

/* ================= MEMBER ================= */
function cekMember() {
  const nohp = document.getElementById("nohp").value.trim();
  if (!nohp) return;

  fetch(`${API_URL}?token=${TOKEN}&action=cekMember&noHP=${nohp}`)
    .then(r => r.json())
    .then(d => {
      if (d.exists) {
        member = d;
        document.getElementById("memberInfo").innerText =
          `Nama: ${d.nama} | Poin: ${d.poin}`;
      } else {
        member = null;
        document.getElementById("memberInfo").innerText = "Bukan member";
      }
    });
}

/* ================= CASH ================= */
function renderCash() {
  const metode = document.getElementById("metode").value;
  const box = document.getElementById("cashBox");
  if (metode !== "CASH") { box.innerHTML = ""; return; }

  box.innerHTML = `
    <input id="bayar" type="number"
           placeholder="Uang diterima"
           class="border p-2 w-full mb-2">
    <div class="flex gap-2 mb-2">
      ${[20000, 50000, 100000].map(v =>
        `<button onclick="quickCash(${v})"
                 class="border px-3 py-1 rounded">${v}</button>`
      ).join("")}
    </div>
    <div>Kembalian: Rp <span id="kembali">0</span></div>
  `;
}

function quickCash(v) {
  document.getElementById("bayar").value = v;
  hitungKembali();
}

document.addEventListener("input", e => {
  if (e.target.id === "bayar") hitungKembali();
});

function hitungKembali() {
  const bayar = Number(document.getElementById("bayar")?.value || 0);
  const total = Number(document.getElementById("total").innerText || 0);
  document.getElementById("kembali").innerText = bayar - total;
}

/* ================= SUBMIT + PRINT ================= */
async function submitOrder() {
  const total = Number(document.getElementById("total").innerText || 0);
  if (total <= 0) { alert("Keranjang kosong"); return; }

  const voucher = Number(document.getElementById("voucher").value || 0);
  const finalTotal = Math.max(0, total - voucher);
  const metode = document.getElementById("metode").value;
  const noWA = document.getElementById("nohp").value || "";

  const pesanan = Object.values(cart)
    .map(i => `${i.nama} x${i.qty}`)
    .join(", ");

  const url =
    `${API_URL}?token=${TOKEN}` +
    `&action=processPayment` +
    `&total=${finalTotal}` +
    `&noWA=${noWA}` +
    `&redeemQty=0` +
    `&voucher=${voucher}` +
    `&method=${metode}` +
    `&pesanan=${encodeURIComponent(pesanan)}`;

  const res = await fetch(url);
  const txt = await res.text();

  if (txt === "SUCCESS") {
    let esc = "\x1B\x40\x1B\x61\x01\x1B\x21\x10dyg++ RETAIL\x1B\x21\x00\n";
    esc += "Tgl: " + new Date().toLocaleString() + "\n";
    esc += "--------------------------------\n\x1B\x61\x00";

    Object.values(cart).forEach(i => {
      esc += `${i.nama}\n`;
      esc += `${i.qty} x ${i.harga.toLocaleString()} = ${(i.qty*i.harga).toLocaleString()}\n`;
    });

    esc += "--------------------------------\n";
    esc += "TOTAL: Rp " + finalTotal.toLocaleString() + "\n";
    if (noWA) esc += "Member: " + noWA + "\n";
    esc += "\nTERIMA KASIH\n\n\n\n";

    if (window.AppInventor) {
      window.AppInventor.setWebViewString("PRINT|" + esc);
    }

    alert("Transaksi Berhasil");
    location.reload();
  } else {
    alert("Gagal menyimpan");
  }
}
</script>

</body>
</html>
