<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>KASIR PRO V2.5 | cloudkitchen.dyg++</title>

<style>
:root{
--primary:#1B4332;
--success:#00b894;
--danger:#e74c3c;
--warning:#f39c12;
--bg:#f0f2f5;
}

/* ================= BASE ================= */
body{
font-family:'Segoe UI',sans-serif;
background:var(--bg);
margin:0;
padding:16px;
touch-action:manipulation;
color:#2d3436;
}

/* ================= HEADER ================= */
.header{
display:flex;
justify-content:space-between;
align-items:center;
background:#fff;
padding:16px 20px;
border-radius:16px;
margin-bottom:16px;
box-shadow:0 2px 6px rgba(0,0,0,.08);
}
.header h2{
margin:0;
font-size:22px;
}

/* ================= GRID ================= */
.order-grid{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(360px,1fr));
gap:16px;
}

/* ================= CARD ================= */
.card{
background:#fff;
border-radius:16px;
padding:16px;
border-left:10px solid var(--success);
box-shadow:0 4px 8px rgba(0,0,0,.08);
}
.antrean{
font-size:30px;
font-weight:900;
color:var(--primary);
}
.mode{
font-size:14px;
font-weight:bold;
opacity:.7;
}
.pesanan{
margin:8px 0;
font-size:14px;
line-height:1.4;
}
.total{
font-size:22px;
font-weight:900;
color:var(--danger);
margin-top:8px;
}

/* ================= BUTTON ================= */
.btn-group{
display:grid;
grid-template-columns:1fr;
gap:12px;
margin-top:14px;
}
.btn{
height:56px;
border-radius:14px;
font-size:16px;
font-weight:900;
border:none;
color:#fff;
cursor:pointer;
}
.btn:active{transform:scale(.97)}
.btn-bayar{background:var(--success)}
.btn-split{background:var(--warning)}
.btn-rekap{
background:var(--primary);
height:44px;
font-size:14px;
}

/* ================= MODAL (BOTTOM SHEET) ================= */
.modal{
display:none;
position:fixed;
inset:0;
background:rgba(0,0,0,.4);
align-items:flex-end;
z-index:1000;
}
.sheet{
background:#fff;
width:100%;
border-radius:24px 24px 0 0;
padding:20px;
max-height:90vh;
overflow:auto;
}

/* ================= CASH ================= */
.cash-grid{
display:grid;
grid-template-columns:repeat(3,1fr);
gap:12px;
margin:12px 0;
}
.cash-btn{
height:56px;
border-radius:14px;
font-size:16px;
font-weight:900;
background:#ecf0f1;
border:2px solid #dcdde1;
}
.input{
width:100%;
height:56px;
font-size:22px;
font-weight:900;
border-radius:14px;
border:2px solid #ddd;
text-align:center;
margin-top:10px;
}
.change{
font-size:28px;
font-weight:900;
margin-top:10px;
}
.change.ok{color:var(--success)}
.change.err{color:var(--danger)}

/* ================= SPLIT ================= */
.cart-item{
display:grid;
grid-template-columns:2fr 1fr auto;
gap:8px;
align-items:center;
padding:10px 0;
border-bottom:1px solid #eee;
font-size:14px;
}

/* ================= MOBILE OPTIMIZATION ================= */
@media (max-width:768px){
body{padding:10px}
.header{padding:12px 14px}
.header h2{font-size:18px}
.order-grid{grid-template-columns:1fr}
.antrean{font-size:24px}
.total{font-size:20px}
.btn{height:52px;font-size:15px}
.cash-grid{grid-template-columns:repeat(2,1fr)}
.input{font-size:18px;height:52px}
.change{font-size:22px}
}
</style>
</head>

<body>

<div class="header">
<h2>üí∞ KASIR</h2>
<button class="btn btn-rekap" onclick="showRekap()">üìä REKAP</button>
</div>

<div id="list" class="order-grid"></div>

<!-- ================= MODAL BAYAR ================= -->
<div id="payModal" class="modal">
<div class="sheet">
<h3>Total</h3>
<div id="payTotal" class="total">Rp 0</div>

<select id="method" class="input" onchange="toggleCash()">
<option value="TUNAI">üíµ TUNAI</option>
<option value="QRIS">üì± QRIS</option>
<option value="KARTU">üí≥ KARTU</option>
</select>

<div id="cashArea">
<div class="cash-grid">
<button class="cash-btn" onclick="setCash('PAS')">PAS</button>
<button class="cash-btn" onclick="setCash(20000)">20K</button>
<button class="cash-btn" onclick="setCash(50000)">50K</button>
<button class="cash-btn" onclick="setCash(100000)">100K</button>
</div>
<input id="cashIn" type="number" class="input" placeholder="Uang diterima" oninput="calc()">
<div id="change" class="change">Rp 0</div>
</div>

<button id="confirmBtn" class="btn btn-bayar" style="margin-top:16px" onclick="pay()">BAYAR</button>
</div>
</div>

<!-- ================= MODAL SPLIT ================= -->
<div id="splitModal" class="modal">
<div class="sheet">
<h3>üßæ Split Bill</h3>
<div id="splitList"></div>
<div style="font-size:20px;font-weight:900;text-align:right;margin-top:10px">
Total: <span id="splitTotal">Rp 0</span>
</div>
<button class="btn btn-bayar" style="margin-top:16px" onclick="paySplit()">BAYAR & CETAK</button>
</div>
</div>

<!-- ================= MODAL REKAP ================= -->
<div id="rekapModal" class="modal">
<div class="sheet" id="rekapContent"></div>
</div>

<script>
const CONFIG={
API:"https://script.google.com/macros/s/AKfycbwTMnQ2lTxuguB7o1zmi9TecIns60xMY3Q02au40g4XUxNpkc5lNAQhNudvLwBC2Vt2/exec",
TOKEN:"dyg-access-v2"
};

let activeOrder=null;
let splitItems=[];

/* ================= LOAD DATA ================= */
async function refresh(){
const r=await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&getOrders=true&statusFilter=DAPUR_SELESAI`);
render(await r.json());
}
window.onload=refresh;

/* ================= RENDER ================= */
function render(data){
list.innerHTML=data.map(o=>{
const mode=(o.mode_pesanan||"").toUpperCase();
const allowSplit=mode.includes("DINE")||mode.includes("TAKE");
return`
<div class="card">
<div style="display:flex;justify-content:space-between">
<div class="antrean">#${o.antrean}</div>
<div class="mode">${mode}</div>
</div>
<div class="pesanan">${o.pesanan.split(',').join('<br>')}</div>
<div class="total">Rp ${(+o.total_bayar).toLocaleString('id-ID')}</div>
<div class="btn-group">
<button class="btn btn-bayar" onclick="openPay(${o.row_index},${o.total_bayar})">BAYAR</button>
${allowSplit?`<button class="btn btn-split" onclick='openSplit(${JSON.stringify(o)})'>SPLIT BILL</button>`:''}
</div>
</div>`;
}).join('');
}

/* ================= BAYAR ================= */
function openPay(r,t){
activeOrder={row:r,total:t};
payTotal.innerText="Rp "+t.toLocaleString('id-ID');
cashIn.value="";
change.innerText="Rp 0";
payModal.style.display="flex";
toggleCash();
setTimeout(()=>cashIn.focus(),300);
}
function toggleCash(){
cashArea.style.display=method.value==="TUNAI"?"block":"none";
}
function setCash(v){
cashIn.value=v==="PAS"?activeOrder.total:v;
calc();
}
function calc(){
let c=(cashIn.value||0)-activeOrder.total;
change.innerText="Rp "+Math.max(0,c).toLocaleString('id-ID');
change.className="change "+(c>=0?"ok":"err");
confirmBtn.disabled=(method.value==="TUNAI" && c<0);
confirmBtn.style.opacity=confirmBtn.disabled?.5:1;
}
async function pay(){
if(confirmBtn.disabled) return;
await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&updateStatus=true&row=${activeOrder.row}&finalStatus=LUNAS&metode=${method.value}`);
printStruk(activeOrder.total,method.value,cashIn.value||0);
closeModal();refresh();
}

/* ================= SPLIT ================= */
function openSplit(o){
splitItems=o.pesanan.split(',').map(p=>{
let [n,h]=p.split(" x ");
return{nama:n.trim(),harga:+h||0};
});
renderSplit();
splitModal.style.display="flex";
}
function renderSplit(){
let t=0;
splitList.innerHTML=splitItems.map((i,idx)=>{
t+=i.harga;
return`
<div class="cart-item">
<div>${i.nama}</div>
<div>Rp ${i.harga.toLocaleString()}</div>
<button onclick="removeSplit(${idx})">‚ùå</button>
</div>`;
}).join('');
splitTotal.innerText="Rp "+t.toLocaleString();
}
function removeSplit(i){
splitItems.splice(i,1);
renderSplit();
}
function paySplit(){
let t=splitItems.reduce((a,b)=>a+b.harga,0);
printStruk(t,"SPLIT",t);
closeModal();
}

/* ================= STRUK ================= */
function printStruk(total,metode,bayar){
let s=`{center}{h}STRUK PEMBAYARAN{/h}
cloudkitchen.dyg++
-------------------------
Total : Rp ${total.toLocaleString()}
Bayar : Rp ${bayar.toLocaleString()}
Metode: ${metode}
-------------------------
{center}TERIMA KASIH
{cut}`;
location.href="rawbt:base64,"+btoa(unescape(encodeURIComponent(s)));
}

/* ================= REKAP ================= */
async function showRekap(){
const r=await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&getRekap=true`);
const d=await r.json();
rekapContent.innerHTML=`
<h3>üìä Rekap Hari Ini</h3>
<b>Transaksi:</b> ${d.count}<br>
<b>Omzet:</b> Rp ${(+d.total).toLocaleString()}<br><br>
Tunai: Rp ${(+d.tunai).toLocaleString()}<br>
QRIS: Rp ${(+d.qris).toLocaleString()}<br>
Kartu: Rp ${(+d.kartu).toLocaleString()}<br><br>
<button class="btn btn-bayar" onclick="closeModal()">TUTUP</button>`;
rekapModal.style.display="flex";
}

/* ================= UTIL ================= */
function closeModal(){
document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
}
</script>
</body>
</html>
