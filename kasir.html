<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KASIR MEJA | CloudKitchen</title>
    <style>
        :root { --primary: #1B4332; --danger: #d63031; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); padding: 15px; margin: 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .card-meja { background: white; border-radius: 15px; padding: 20px; border-top: 8px solid var(--primary); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .antrean-tag { font-size: 11px; background: #eee; padding: 2px 6px; border-radius: 4px; margin-right: 4px; }
        .total-box { font-size: 24px; font-weight: 900; color: var(--danger); text-align: right; margin-top: 15px; border-top: 2px dashed #eee; padding-top: 10px; }
        .btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-pay { background: var(--primary); color: white; width: 100%; }
        .btn-split { background: #f39c12; color: white; width: 100%; }
        
        /* Modal Split Bill */
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); align-items:flex-end; z-index:1000; }
        .sheet { background:white; width:100%; border-radius:20px 20px 0 0; padding:25px; box-sizing:border-box; max-height: 85vh; overflow-y: auto; }
        .split-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .checkbox-custom { width: 25px; height: 25px; cursor: pointer; }
    </style>
</head>
<body>
    <h2 style="text-align:center; color: var(--primary);">ðŸ’° KASIR - GROUPING MEJA</h2>
    <div id="listMeja" class="grid">Memuat data transaksi...</div>

    <div id="splitModal" class="modal">
        <div class="sheet">
            <h3 id="splitTitle">ðŸ§¾ Split Bill</h3>
            <div id="splitItems"></div>
            <div class="total-box" id="splitTotalDisplay">Total Pilih: Rp 0</div>
            <div style="margin-top:20px;">
                <label>Metode Bayar:</label>
                <select id="splitMetode" style="width:100%; padding:10px; margin:10px 0;">
                    <option value="TUNAI">TUNAI</option>
                    <option value="QRIS">QRIS</option>
                    <option value="KARTU">KARTU</option>
                </select>
            </div>
            <button class="btn btn-pay" onclick="prosesBayarSplit()">PROSES BAYAR ITEM</button>
            <button class="btn" style="background:#ddd; width:100%; margin-top:10px;" onclick="tutupModal()">BATAL</button>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxxkNv1NGjHw4vMIK9i3k43KgEwud_VgDIImbRNrCKtk3bmCEnoTZmCI2HRxR48Owo7-Q/exec"; // <--- GANTI DENGAN URL GAS TERBARU
        const TOKEN = "dyg-access-v2";
        let masterData = [];
        let tempSplitItems = [];

        async function loadKasir() {
            try {
                const r = await fetch(`${API_URL}?token=${TOKEN}&getOrders=true&statusFilter=ALL`);
                masterData = await r.json();
                renderMeja();
            } catch(e) { console.error(e); }
        }

        function renderMeja() {
            // Logika Grouping Meja
            const groups = masterData.reduce((acc, obj) => {
                const meja = obj.mode_pesanan || "Take Away";
                if (!acc[meja]) acc[meja] = [];
                acc[meja].push(obj);
                return acc;
            }, {});

            document.getElementById('listMeja').innerHTML = Object.keys(groups).map(meja => {
                const orders = groups[meja];
                const grandTotal = orders.reduce((sum, o) => sum + Number(o.total_bayar), 0);
                return `
                <div class="card-meja">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <b style="font-size:20px;">ðŸª‘ ${meja}</b>
                        <div>${orders.map(o => `<span class="antrean-tag">#${o.no_antrean}</span>`).join('')}</div>
                    </div>
                    <div style="margin:15px 0; font-size:13px; color:#666;">
                        ${orders.map(o => `<div>â€¢ ${o.pesanan} (${o.status})</div>`).join('')}
                    </div>
                    <div class="total-box">Rp ${grandTotal.toLocaleString()}</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
                        <button class="btn btn-pay" onclick="bayarFullMeja('${meja}')">LUNAS MEJA</button>
                        <button class="btn btn-split" onclick='bukaSplitModal("${meja}")'>SPLIT BILL</button>
                    </div>
                </div>`;
            }).join('');
        }

        function bukaSplitModal(mejaName) {
            const orders