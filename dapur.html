<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>KITCHEN DASHBOARD | Cloud Kitchen</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
<style>
:root {
    --primary: #1B4332;
    --danger: #D63031;
    --success: #00B894;
    --bg: #f0f2f5;
}

body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: var(--bg); margin: 0; padding: 20px; 
    overflow-x: hidden;
}

.container { max-width: 1000px; margin: auto; }
.header-page {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 20px; background: white; padding: 15px 20px;
    border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.order-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
}

.order-card {
    background: white; border-radius: 12px; padding: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    border-top: 8px solid var(--primary);
    display: flex; flex-direction: column;
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
    position: relative;
    touch-action: pan-y;
}

.swiped-left {
    transform: translateX(-150%) rotate(-15deg) !important;
    opacity: 0 !important;
}

.order-header {
    display: flex; justify-content: space-between;
    border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px;
}

.order-no { font-size: 24px; font-weight: 900; color: var(--primary); }
.order-time { font-size: 12px; color: #888; }

.customer-info { margin-bottom: 15px; }
.customer-name { font-weight: bold; font-size: 18px; display: block; }
.order-mode { font-size: 12px; background: #eee; padding: 2px 8px; border-radius: 10px; }

.item-list {
    background: #f9f9f9; padding: 15px; border-radius: 8px;
    flex-grow: 1; margin-bottom: 15px;
    font-family: 'Courier New', Courier, monospace; font-size: 16px;
}

.btn-group { display: flex; gap: 10px; }
button {
    flex: 1; padding: 12px; border: none; border-radius: 8px;
    cursor: pointer; font-weight: bold;
}

.btn-print { background: var(--primary); color: white; }
.btn-done { background: var(--success); color: white; }

.swipe-hint {
    text-align: center; font-size: 10px; color: #bbb; margin-top: 10px;
}
</style>
</head>
<body>

<div class="container">
    <div class="header-page">
        <h2 style="margin:0;">üë®‚Äçüç≥ Dashboard Dapur</h2>
        <div id="status-conn" style="font-size: 12px; color: green;">‚óè Menghubungkan...</div>
    </div>
    <div id="orderList" class="order-grid"></div>
</div>

<audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
const PIN_DAPUR = "1212"; 
if (prompt("Masukkan PIN Dapur:") !== PIN_DAPUR) {
    alert("Akses ditolak!");
    document.body.innerHTML = "<h1 style='text-align:center;margin-top:50px;'>Akses Dilarang</h1>";
    throw new Error("Invalid PIN");
}

const CONFIG = {
    API_URL: "https://script.google.com/macros/s/AKfycbyHXKH97V_JUlyWcl0y51q3B9t7gKTUXqZo1RZbhClE9xhwmQN7AaIxTAR27tmFw9b2LA/exec",
    TOKEN: "dyg-access-v2",
    REFRESH_RATE: 10000,
    PRINTER_IP: "192.168.1.100", // Ganti dengan IP printer RawBT atau printer jaringan
    PRINTER_PORT: 9100
};

let lastOrderCount = 0;
let isProcessing = [];

async function fetchOrders() {
    try {
        const response = await fetch(`${CONFIG.API_URL}?token=${CONFIG.TOKEN}&getOrders=true`);
        const data = await response.json();
        document.getElementById('status-conn').innerText = "‚óè Terhubung (Otomatis)";
        
        if (data.length > lastOrderCount && lastOrderCount !== 0) {
            document.getElementById('notifSound').play().catch(() => {});
        }
        lastOrderCount = data.length;
        renderOrders(data);
    } catch (err) {
        document.getElementById('status-conn').innerText = "‚óã Terputus...";
    }
}

function renderOrders(orders) {
    const container = document.getElementById('orderList');
    const activeOrders = orders.filter(ord => !isProcessing.includes(ord.row_index.toString()));

    if (!activeOrders || activeOrders.length === 0) {
        if (isProcessing.length === 0) {
            container.innerHTML = "<p style='grid-column: 1/-1; text-align:center; color:#888;'>Tidak ada pesanan aktif.</p>";
        }
        return;
    }

    container.innerHTML = activeOrders.map(ord => `
        <div class="order-card" id="card-${ord.row_index}" data-row="${ord.row_index}">
            <div class="order-header">
                <span class="order-no">#${ord.no_antrean}</span>
                <div class="order-time">${new Date(ord.timestamp).toLocaleTimeString('id-ID')}</div>
            </div>
            <div class="customer-info">
                <span class="customer-name">${ord.nama}</span>
                <span class="order-mode">${ord.mode_pesanan}</span>
            </div>
            <div class="item-list">
                ${ord.pesanan.split(',').map(item => `‚Ä¢ ${item.trim()}`).join('<br>')}
            </div>
            <div class="btn-group">
                <button class="btn-print" onclick="printThermal(${ord.row_index}, '${ord.no_antrean}', '${ord.nama}', '${ord.pesanan}', '${ord.mode_pesanan}', '${ord.total_bayar}')">CETAK</button>
                <button class="btn-done" onclick="markDone(${ord.row_index})">SELESAI</button>
            </div>
            <div class="swipe-hint">‚Üê Geser kiri untuk selesai</div>
        </div>
    `).join('');

    document.querySelectorAll('.order-card').forEach(card => {
        const mc = new Hammer(card);
        mc.on("swipeleft", () => handleAction(card));
    });
}

function handleAction(card) {
    const rowIndex = card.getAttribute('data-row');
    isProcessing.push(rowIndex);
    
    card.classList.add('swiped-left');
    
    setTimeout(() => {
        card.remove();
        if (document.querySelectorAll('.order-card').length === 0) {
            document.getElementById('orderList').innerHTML = "<p style='grid-column: 1/-1; text-align:center; color:#888;'>Semua pesanan selesai!</p>";
        }
    }, 400);

    executeDone(rowIndex);
}

async function markDone(rowIndex) {
    if (confirm("Selesaikan pesanan?")) {
        handleAction(document.getElementById(`card-${rowIndex}`));
    }
}

async function executeDone(rowIndex) {
    try {
        await fetch(`${CONFIG.API_URL}?token=${CONFIG.TOKEN}&updateStatus=true&row=${rowIndex}`);
        isProcessing = isProcessing.filter(id => id !== rowIndex.toString());
    } catch (e) {
        console.error("Gagal update status");
        isProcessing = isProcessing.filter(id => id !== rowIndex.toString());
        fetchOrders();
    }
}

// CETAK KE PRINTER THERMAL 58mm
async function printThermal(rowIndex, no, nama, menu, mode, total) {
    const struk = `
CLOUD KITCHEN DYG
KITCHEN BILL
--------------------------
ANTREAN: #${no}
Nama: ${nama}
Mode: ${mode}
--------------------------
${menu.split(',').map(m => `[ ] ${m.trim()}`).join('\n')}
--------------------------
TOTAL: Rp ${total}
`;

    try {
        const url = `http://${CONFIG.PRINTER_IP}:${CONFIG.PRINTER_PORT}/print`;
        const response = await fetch(url, { method:'POST', headers:{'Content-Type':'text/plain'}, body:struk });
        if (!response.ok) alert('Gagal cetak, cek koneksi printer');
    } catch (e) {
        console.error('Error koneksi printer', e);
        alert('Error koneksi printer. Pastikan printer terhubung.');
    }
}

setInterval(fetchOrders, CONFIG.REFRESH_RATE);
fetchOrders();
</script>
</body>
</html>
