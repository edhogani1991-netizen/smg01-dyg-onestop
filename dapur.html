<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KITCHEN MONITOR | Cloud Kitchen</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <style>
        :root {
            --primary: #1B4332;
            --danger: #d63031;
            --bg: #f0f2f5;
        }
        body { font-family:'Segoe UI', sans-serif; background: var(--bg); margin:0; padding:15px; overflow-x: hidden; }
        .container { max-width:1200px; margin:auto; }
        
        .header-page { 
            display:flex; justify-content:space-between; align-items:center; 
            margin-bottom:20px; background:white; padding:15px 20px; 
            border-radius:12px; box-shadow:0 2px 5px rgba(0,0,0,0.05); 
        }

        .order-grid { 
            display:grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap:15px; 
        }

        .order-card { 
            background:white; border-radius:12px; padding:18px; 
            box-shadow:0 4px 6px rgba(0,0,0,0.1); border-top:8px solid var(--primary);
            display:flex; flex-direction:column; position:relative;
            touch-action: pan-y; overflow: hidden;
            transition: all 0.3s ease;
        }

        .confirm-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(214, 48, 49, 0.96); color:white;
            display:none; flex-direction:column; justify-content:center;
            align-items:center; z-index: 10; text-align: center;
        }
        .confirm-overlay.active { display: flex; }
        
        .btn-confirm-group { display: flex; gap: 15px; margin-top: 15px; }
        .btn-confirm { padding: 12px 30px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .btn-ya { background: white; color: var(--danger); }
        .btn-batal { background: transparent; color: white; border: 2px solid white; }

        .order-header { 
            display:flex; justify-content:space-between; align-items:center;
            border-bottom:2px dashed #eee; padding-bottom:10px; margin-bottom:15px; 
        }
        .order-no { font-size:40px; font-weight:900; color:var(--primary); }
        .order-time { font-size:14px; color:#666; font-weight: bold; }
        
        .customer-name { font-weight:bold; font-size:22px; color: #2d3436; display:block; }
        .order-mode { 
            display:inline-block; margin-top:5px; font-size:12px; font-weight:bold;
            background: #dfe6e9; color: #2d3436; padding:3px 12px; border-radius:15px; 
            text-transform: uppercase;
        }

        .item-list { 
            background:#f8f9fa; padding:15px; border-radius:8px; flex-grow:1; 
            margin-bottom:15px; font-family:'Courier New', monospace; 
            font-size:19px; border:1px solid #edf2f7; line-height: 1.4; font-weight: bold;
        }

        .btn-print { 
            width: 100%; padding:18px; border:none; border-radius:8px; 
            cursor:pointer; font-weight:bold; font-size:16px;
            background:var(--primary); color:white;
        }

        .swipe-hint { text-align:center; font-size:11px; color:#aaa; margin-top:10px; }
        .removed { transform: scale(0.8); opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-page">
        <h2 style="margin:0;">üë®‚Äçüç≥ MONITOR DAPUR</h2>
        <div id="status-conn" style="color: orange; font-weight: bold;">‚óè Menghubungkan...</div>
    </div>
    <div id="orderList" class="order-grid"></div>
</div>

<audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
// --- FITUR KEAMANAN PIN ---
const PIN_DAPUR = "1212";
if(prompt("Masukkan PIN Dapur:") !== PIN_DAPUR){
    alert("Akses ditolak!");
    document.body.innerHTML="<h1 style='text-align:center;margin-top:50px;'>Akses Dilarang</h1>"; 
    throw new Error("Invalid PIN");
}

const CONFIG = {
    API_URL: "https://script.google.com/macros/s/AKfycbw8r4no1QS_l3NlSeV1wbYb76RBl5or18ayesRcBlMQwrztaxfeon6pIeZU8bfWCCb1Vg/exec",
    TOKEN: "dyg-access-v2",
    REFRESH_RATE: 10000
};

let lastOrderCount = 0;
let isRemoving = []; 

async function fetchOrders(){
    try{
        const resp = await fetch(`${CONFIG.API_URL}?token=${CONFIG.TOKEN}&getOrders=true`);
        const data = await resp.json();
        document.getElementById('status-conn').innerText = "‚óè TERHUBUNG";
        document.getElementById('status-conn').style.color = "green";

        if(data.length > lastOrderCount && lastOrderCount !== 0) {
            document.getElementById('notifSound').play().catch(()=>{});
        }
        lastOrderCount = data.length;
        renderOrders(data);
    } catch(err) {
        document.getElementById('status-conn').innerText = "‚óã TERPUTUS";
        document.getElementById('status-conn').style.color = "red";
    }
}

function renderOrders(orders){
    const container = document.getElementById('orderList');
    const filtered = orders.filter(ord => !isRemoving.includes(ord.row_index.toString()));

    if(filtered.length === 0){
        container.innerHTML = "<p style='grid-column:1/-1; text-align:center; color:#888; margin-top:50px;'>Tidak ada pesanan aktif.</p>";
        return;
    }

    container.innerHTML = filtered.map(ord => {
        const no = ord.antrean || ord.no_antrean || "!!";
        const row = ord.row_index;
        const pesanan = ord.pesanan || "";
        const mode = ord.mode_pesanan || ord["mode pesanan"] || "DINE IN";
        const total = ord.total_bayar || ord["total bayar"] || "0";

        return `
        <div class="order-card" id="card-${row}" data-row="${row}">
            <div class="confirm-overlay" id="overlay-${row}">
                <b style="font-size:20px;">SELESAIKAN PESANAN?</b>
                <div class="btn-confirm-group">
                    <button class="btn-confirm btn-ya" onclick="confirmDelete(${row})">YA</button>
                    <button class="btn-confirm btn-batal" onclick="cancelDelete(${row})">BATAL</button>
                </div>
            </div>
            <div class="order-header">
                <span class="order-no">#${no}</span>
                <div class="order-time">${new Date(ord.timestamp).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'})}</div>
            </div>
            <div class="customer-info">
                <span class="customer-name">${ord.nama || 'Pelanggan'}</span>
                <span class="order-mode">${mode}</span>
            </div>
            <div class="item-list">
                ${pesanan.split(',').map(item => `‚Ä¢ ${item.trim()}`).join('<br>')}
            </div>
            <button class="btn-print" onclick="printAndClose('${row}', '${no}', '${ord.nama}', '${pesanan.replace(/'/g, "\\'")}', '${mode}', '${total}')">
                üñ®Ô∏è CETAK & SELESAI
            </button>
            <div class="swipe-hint">‚Üê Geser untuk hapus tanpa cetak</div>
        </div>`;
    }).join('');

    document.querySelectorAll('.order-card').forEach(card => {
        const mc = new Hammer(card);
        mc.on("swipeleft", () => {
            const row = card.getAttribute('data-row');
            document.getElementById(`overlay-${row}`).classList.add('active');
        });
    });
}

function cancelDelete(row) {
    document.getElementById(`overlay-${row}`).classList.remove('active');
}

// --- FUNGSI CETAK BASE64 (TERCEPAT) ---
function printAndClose(row, no, nama, menu, mode, total) {
    // 1. Efek Visual Instan
    const card = document.getElementById(`card-${row}`);
    if(card) card.classList.add('removed');
    isRemoving.push(row.toString());

    // 2. Siapkan Struk
    const struk = `{center}{h}KITCHEN BILL{/h}\n--------------------------------\n{h}ANTREAN: #${no}{/h}\n--------------------------------\nNama: ${nama}\nMode: ${mode}\n--------------------------------\n${menu.split(',').map(m => `[ ] ${m.trim()}`).join('\n')}\n--------------------------------\n{center}--- ${new Date().toLocaleTimeString('id-ID')} ---\n{cut}`;

    // 3. Panggil RawBT via Base64 (Metode paling instan di Android)
    try {
        const base64Data = btoa(unescape(encodeURIComponent(struk)));
        window.location.href = "rawbt:base64," + base64Data;
    } catch(e) {
        console.error("Gagal encode printer data");
    }

    // 4. Update server di background (Tanpa menunggu)
    fetch(`${CONFIG.API_URL}?token=${CONFIG.TOKEN}&updateStatus=true&row=${row}`)
    .catch(e => console.log("Server update pending..."));
}

async function confirmDelete(row) {
    const card = document.getElementById(`card-${row}`);
    card.classList.add('removed');
    isRemoving.push(row.toString());
    try {
        await fetch(`${CONFIG.API_URL}?token=${CONFIG.TOKEN}&updateStatus=true&row=${row}`);
        setTimeout(() => { if(card && card.parentNode) card.remove(); }, 400);
    } catch(e) {
        isRemoving = isRemoving.filter(id => id !== row.toString());
        if(card) card.classList.remove('removed');
    }
}

setInterval(fetchOrders, CONFIG.REFRESH_RATE);
fetchOrders();
</script>
</body>
</html>