<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KITCHEN DASHBOARD | Cloud Kitchen</title>
    <style>
        :root {
            --primary: #1B4332;
            --danger: #D63031;
            --success: #00B894;
            --bg: #f0f2f5;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 20px; 
        }

        .container { max-width: 1000px; margin: auto; }
        
        .header-page {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .order-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .order-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-top: 8px solid var(--primary);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .order-no { font-size: 24px; font-weight: 900; color: var(--primary); }
        .order-time { font-size: 12px; color: #888; text-align: right; }

        .customer-info { margin-bottom: 15px; }
        .customer-name { font-weight: bold; font-size: 18px; display: block; }
        .order-mode { font-size: 12px; background: #eee; padding: 2px 8px; border-radius: 10px; }

        .item-list {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            flex-grow: 1;
            margin-bottom: 15px;
            font-family: 'Courier New', Courier, monospace;
        }

        .btn-group { display: flex; gap: 10px; }
        
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        .btn-print { background: var(--primary); color: white; }
        .btn-done { background: var(--success); color: white; }
        button:hover { opacity: 0.8; }

        /* CSS KHUSUS CETAK */
        @media print {
            body * { visibility: hidden; }
            #printSection, #printSection * { visibility: visible; }
            #printSection {
                position: absolute;
                left: 0; top: 0;
                width: 80mm; /* Standar Thermal */
                font-family: monospace;
                padding: 5px;
            }
            .no-print { display: none; }
        }

        /* Notifikasi */
        #notification {
            position: fixed;
            top: 20px; right: 20px;
            background: var(--success);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-page">
            <h2 style="margin:0;">üë®‚Äçüç≥ Dashboard Dapur</h2>
            <div id="status-conn" style="font-size: 12px; color: green;">‚óè Menghubungkan...</div>
        </div>

        <div id="orderList" class="order-grid">
            </div>
    </div>

    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div id="printSection" style="display:none;"></div>

    <script>
    // Proteksi PIN sederhana
    const PIN_DAPUR = "1212"; // Ganti sesuai keinginan Anda
    let akses = prompt("Masukkan PIN Dapur:");
    
    if (akses !== PIN_DAPUR) {
        alert("Akses ditolak!");
        document.body.innerHTML = "<h1 style='text-align:center;margin-top:50px;'>Akses Dilarang</h1>";
    }

    // CONFIGURATION (Lanjutkan kode yang sudah ada)
    const CONFIG = {
        API_URL: "https://script.google.com/macros/s/.../exec", 
        TOKEN: "dyg-access-v2",
        REFRESH_RATE: 15000 
    };
    // ... dst
</script>
        // CONFIGURATION
        const CONFIG = {
            API_URL: "https://script.google.com/macros/s/AKfycbyHXKH97V_JUlyWcl0y51q3B9t7gKTUXqZo1RZbhClE9xhwmQN7AaIxTAR27tmFw9b2LA/exec", // GANTI DENGAN URL GAS ANDA
            TOKEN: "dyg-access-v2",
            REFRESH_RATE: 15000 // Cek setiap 15 detik
        };

        let lastOrderCount = 0;

        async function fetchOrders() {
            try {
                const response = await fetch(`${CONFIG.API_URL}?token=${CONFIG.TOKEN}&getOrders=true`);
                const data = await response.json();
                
                document.getElementById('status-conn').innerText = "‚óè Terhubung (Auto-refresh Aktif)";
                renderOrders(data);
                
                // Bunyikan notifikasi jika ada pesanan baru masuk
                if (data.length > lastOrderCount) {
                    if (lastOrderCount !== 0) {
                        document.getElementById('notifSound').play();
                    }
                    lastOrderCount = data.length;
                } else if (data.length < lastOrderCount) {
                    lastOrderCount = data.length;
                }

            } catch (err) {
                document.getElementById('status-conn').innerText = "‚óã Terputus, mencoba lagi...";
                console.error("Fetch error:", err);
            }
        }

        function renderOrders(orders) {
            const container = document.getElementById('orderList');
            if (orders.length === 0) {
                container.innerHTML = "<p style='grid-column: 1/-1; text-align:center; color:#888;'>Tidak ada pesanan aktif.</p>";
                return;
            }

            container.innerHTML = orders.map(ord => `
                <div class="order-card" id="card-${ord.row_index}">
                    <div class="order-header">
                        <span class="order-no">#${ord.no_antrean}</span>
                        <div class="order-time">${new Date(ord.timestamp).toLocaleTimeString('id-ID')}</div>
                    </div>
                    <div class="customer-info">
                        <span class="customer-name">${ord.nama}</span>
                        <span class="order-mode">${ord.mode_pesanan}</span>
                    </div>
                    <div class="item-list">
                        ${ord.pesanan.split(',').map(item => `‚Ä¢ ${item.trim()}`).join('<br>')}
                    </div>
                    <div class="btn-group">
                        <button class="btn-print" onclick="preparePrint('${ord.no_antrean}', '${ord.nama}', '${ord.pesanan}', '${ord.mode_pesanan}', '${ord.total_bayar}')">CETAK</button>
                        <button class="btn-done" onclick="markDone(${ord.row_index})">SELESAI</button>
                    </div>
                </div>
            `).join('');
        }

        async function markDone(rowIndex) {
            if (!confirm("Pesanan selesai dan siap disajikan?")) return;
            
            const card = document.getElementById(`card-${rowIndex}`);
            card.style.opacity = "0.3";
            card.style.pointerEvents = "none";

            try {
                await fetch(`${CONFIG.API_URL}?token=${CONFIG.TOKEN}&updateStatus=true&row=${rowIndex}`);
                fetchOrders(); // Refresh data
            } catch (err) {
                alert("Gagal update status. Coba lagi.");
                card.style.opacity = "1";
                card.style.pointerEvents = "auto";
            }
        }

        function preparePrint(no, nama, menu, mode, total) {
            const printArea = document.getElementById('printSection');
            printArea.style.display = 'block';
            
            const content = `
                <div style="text-align:center; border-bottom:1px dashed #000; padding-bottom:10px;">
                    <b style="font-size:16px;">CLOUD KITCHEN DYG</b><br>
                    STRUK DAPUR / KITCHEN BILL
                </div>
                <div style="padding: 10px 0; border-bottom:1px dashed #000; font-size:14px;">
                    <b>NO ANTREAN : #${no}</b><br>
                    Nama : ${nama}<br>
                    Mode : ${mode}<br>
                    Jam  : ${new Date().toLocaleTimeString('id-ID')}
                </div>
                <div style="padding: 10px 0; min-height: 100px; font-size:15px;">
                    ${menu.split(',').map(m => `[ ] ${m.trim()}`).join('<br>')}
                </div>
                <div style="border-top:1px dashed #000; padding-top:10px; text-align:right;">
                    TOTAL: Rp ${total}
                </div>
                <div style="text-align:center; margin-top:20px; font-size:10px;">
                    --- ${mode.toUpperCase()} ---
                </div>
            `;
            
            printArea.innerHTML = content;
            window.print();
            printArea.style.display = 'none';
        }

        // Jalankan polling
        setInterval(fetchOrders, CONFIG.REFRESH_RATE);
        fetchOrders();
    </script>
</body>
</html>